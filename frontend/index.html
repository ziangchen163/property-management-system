<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ä¸šç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        
        /* å¯¼èˆªæ  */
        .navbar { background: #2c3e50; color: white; padding: 1rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .nav-title { font-size: 1.5rem; font-weight: bold; }
        .nav-menu { display: flex; gap: 20px; }
        .nav-item { padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: #3498db; }
        
        /* ä¸»å®¹å™¨ */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card h2 { color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        
        /* è¡¨å•æ ·å¼ */
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3498db; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin: 5px; }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .table th { background: #f8f9fa; font-weight: 600; color: #2c3e50; }
        .table tr:hover { background: #f8f9fa; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { color: white; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-card h3 { font-size: 2rem; margin-bottom: 10px; }
        .stat-card p { opacity: 0.9; }
        .stat-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-green { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .stat-red { background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%); }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .modal-header { background: #2c3e50; color: white; padding: 20px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: white; }
        .modal-body { padding: 30px; }
        .modal-actions { margin-top: 30px; text-align: right; }
        
        /* ç…§ç‰‡åŒºåŸŸæ ·å¼ */
        .photo-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
        .photo-section h3 { margin-bottom: 15px; color: #2c3e50; }
        .photo-container { display: flex; justify-content: center; margin-bottom: 20px; }
        #ownerPhotoPreview { max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #ddd; }
        .no-photo-placeholder { width: 200px; height: 200px; border: 2px dashed #ccc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; background: white; }
        .no-photo-placeholder span { font-size: 48px; margin-bottom: 10px; }
        .photo-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* æˆ¿äº§ç…§ç‰‡ç”»å»Šæ ·å¼ */
        .photos-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; min-height: 140px; border: 2px dashed #ddd; border-radius: 8px; padding: 15px; background: white; }
        .photo-item { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .photo-item img { width: 100%; height: 120px; object-fit: cover; }
        .photo-item .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; }
        .photo-item .delete-btn:hover { background: #e74c3c; }
        .photos-gallery.empty::before { content: "ğŸ“· æš‚æ— ç…§ç‰‡ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ "; display: flex; align-items: center; justify-content: center; color: #999; font-size: 16px; min-height: 100px; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-title">ğŸ  ç‰©ä¸šç®¡ç†ç³»ç»Ÿ</div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="showPage('dashboard')">ä»ªè¡¨ç›˜</div>
                <div class="nav-item" onclick="showPage('owners')">ä¸šä¸»ç®¡ç†</div>
                <div class="nav-item" onclick="showPage('communities')">å°åŒºç®¡ç†</div>
                <div class="nav-item" onclick="showPage('properties')">æˆ¿äº§ç®¡ç†</div>
                <div class="nav-item" onclick="showPage('parking')">è½¦ä½ç®¡ç†</div>
                <div class="nav-item" onclick="showPage('fees')">æ”¶è´¹ç®¡ç†</div>
                <div class="nav-item" onclick="showPage('advanced-fees')">é«˜çº§æ”¶è´¹</div>
                <div class="nav-item" onclick="showPage('rental')">ç§Ÿèµç®¡ç†</div>
                <div class="nav-item" onclick="showPage('decoration')">è£…ä¿®ç®¡ç†</div>
                <div class="nav-item" onclick="showPage('vehicles')">è½¦è¾†ç®¡ç†</div>
                <div class="nav-item" onclick="showPage('reports')">æ—¥æŠ¥ç®¡ç†</div>
                <div class="nav-item" onclick="showPage('import')">æ•°æ®å¯¼å…¥</div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
        <div id="dashboard" class="page active">
            <div class="stats">
                <div class="stat-card stat-blue">
                    <h3 id="ownerCount">0</h3>
                    <p>ä¸šä¸»æ€»æ•°</p>
                </div>
                <div class="stat-card stat-blue">
                    <h3 id="propertyCount">0</h3>
                    <p>æˆ¿äº§æ€»æ•°</p>
                </div>
                <div class="stat-card stat-blue">
                    <h3 id="parkingCount">0</h3>
                    <p>è½¦ä½æ€»æ•°</p>
                </div>
                <div class="stat-card stat-red">
                    <h3 id="feeTotal">Â¥0</h3>
                    <p>æœªæ”¶è´¹ç”¨</p>
                </div>
            </div>
            <div class="card">
                <h2>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>
                <p>æ¬¢è¿ä½¿ç”¨ç‰©ä¸šç®¡ç†ç³»ç»Ÿï¼è¿™é‡Œæ˜¯ç³»ç»Ÿçš„ä¸»è¦ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
            </div>
        </div>

        <!-- ä¸šä¸»ç®¡ç†é¡µé¢ -->
        <div id="owners" class="page">
            <div class="card">
                <h2>ğŸ‘¤ æ·»åŠ ä¸šä¸»</h2>
                <form id="ownerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å§“å: <span style="color:red">*</span></label>
                            <input type="text" id="ownerName" required>
                        </div>
                        <div class="form-group">
                            <label>ç”µè¯å·ç :</label>
                            <input type="tel" id="ownerPhone" placeholder="å¯é€‰ï¼Œä½†ä¸èƒ½é‡å¤">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>èº«ä»½è¯å·:</label>
                            <input type="text" id="ownerIdCard" placeholder="å¯é€‰ï¼Œä½†ä¸èƒ½é‡å¤">
                        </div>
                        <div class="form-group">
                            <label>å·¥ä½œå•ä½:</label>
                            <input type="text" id="ownerCompany">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>èŒåŠ¡:</label>
                            <input type="text" id="ownerPosition">
                        </div>
                        <div class="form-group">
                            <label>çˆ±å¥½:</label>
                            <input type="text" id="ownerHobby" placeholder="å¤šä¸ªçˆ±å¥½ç”¨é€—å·åˆ†éš”">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¤‡æ³¨:</label>
                            <input type="text" id="ownerRemark">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">æ·»åŠ ä¸šä¸»</button>
                </form>
            </div>
            
            <div class="card">
                <h2>ğŸ‘¥ ä¸šä¸»åˆ—è¡¨</h2>
                <div style="margin-bottom: 20px;">
                    <button onclick="loadOwners()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                    <input type="text" id="ownerSearchInput" placeholder="æœç´¢ä¸šä¸»å§“åæˆ–ç”µè¯" style="margin-left: 10px; padding: 8px;">
                    <button onclick="searchOwners()" class="btn">æœç´¢</button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ç…§ç‰‡</th>
                            <th>å§“å</th>
                            <th>ç”µè¯</th>
                            <th>èº«ä»½è¯å·</th>
                            <th>å·¥ä½œå•ä½</th>
                            <th>èŒåŠ¡</th>
                            <th>æˆ¿äº§æ•°</th>
                            <th>è½¦ä½æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="ownerTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ä¸šä¸»ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="ownerEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âœï¸ ç¼–è¾‘ä¸šä¸»ä¿¡æ¯</h2>
                    <span class="close" onclick="closeOwnerEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- ç…§ç‰‡åŒºåŸŸ -->
                    <div class="photo-section">
                        <h3>ä¸šä¸»ç…§ç‰‡</h3>
                        <div class="photo-container">
                            <img id="ownerPhotoPreview" src="" alt="ä¸šä¸»ç…§ç‰‡" style="display: none;">
                            <div id="noPhotoPlaceholder" class="no-photo-placeholder">
                                <span>ğŸ“·</span>
                                <p>æš‚æ— ç…§ç‰‡</p>
                            </div>
                        </div>
                        <div class="photo-actions">
                            <label for="ownerPhotoInput" class="btn btn-secondary">
                                ğŸ“¸ é€‰æ‹©ç…§ç‰‡
                                <input type="file" id="ownerPhotoInput" accept="image/*" style="display: none;">
                            </label>
                            <button type="button" id="uploadPhotoBtn" class="btn" style="display: none;">ä¸Šä¼ ç…§ç‰‡</button>
                            <button type="button" id="deletePhotoBtn" class="btn btn-danger" style="display: none;">åˆ é™¤ç…§ç‰‡</button>
                        </div>
                    </div>

                    <!-- ä¿¡æ¯ç¼–è¾‘è¡¨å• -->
                    <form id="ownerEditForm">
                        <input type="hidden" id="editOwnerId">
                        <div class="form-row">
                            <div class="form-group">
                                <label>å§“å: <span style="color:red">*</span></label>
                                <input type="text" id="editOwnerName" required>
                            </div>
                            <div class="form-group">
                                <label>ç”µè¯å·ç :</label>
                                <input type="tel" id="editOwnerPhone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>èº«ä»½è¯å·:</label>
                                <input type="text" id="editOwnerIdCard">
                            </div>
                            <div class="form-group">
                                <label>å·¥ä½œå•ä½:</label>
                                <input type="text" id="editOwnerCompany">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>èŒåŠ¡:</label>
                                <input type="text" id="editOwnerPosition">
                            </div>
                            <div class="form-group">
                                <label>çˆ±å¥½:</label>
                                <input type="text" id="editOwnerHobby" placeholder="å¤šä¸ªçˆ±å¥½ç”¨é€—å·åˆ†éš”">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¤‡æ³¨:</label>
                                <input type="text" id="editOwnerRemark">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-success">ä¿å­˜ä¿®æ”¹</button>
                            <button type="button" class="btn btn-secondary" onclick="closeOwnerEditModal()">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- å°åŒºç®¡ç†é¡µé¢ -->
        <div id="communities" class="page">
            <div class="card">
                <h2>ğŸ˜ï¸ æ·»åŠ å°åŒº</h2>
                <form id="communityForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å°åŒºåç§°: <span style="color:red">*</span></label>
                            <input type="text" id="communityName" required>
                        </div>
                        <div class="form-group">
                            <label>å°åŒºåœ°å€:</label>
                            <input type="text" id="communityAddress">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å°åŒºæè¿°:</label>
                            <input type="text" id="communityDescription" placeholder="å¦‚: é«˜æ¡£ä½å®…å°åŒº">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">æ·»åŠ å°åŒº</button>
                </form>
            </div>
            
            <div class="card">
                <h2>ğŸ˜ï¸ å°åŒºåˆ—è¡¨</h2>
                <button onclick="loadCommunities()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>å°åŒºåç§°</th>
                            <th>åœ°å€</th>
                            <th>æè¿°</th>
                            <th>æˆ¿äº§æ•°</th>
                            <th>è½¦ä½æ•°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="communityTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- å°åŒºç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="communityEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“ ç¼–è¾‘å°åŒºä¿¡æ¯</h3>
                    <span class="close" onclick="closeCommunityEditModal()">&times;</span>
                </div>
                <form id="communityEditForm">
                    <input type="hidden" id="editCommunityId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å°åŒºåç§°: <span style="color:red">*</span></label>
                            <input type="text" id="editCommunityName" required>
                        </div>
                        <div class="form-group">
                            <label>å°åŒºåœ°å€:</label>
                            <input type="text" id="editCommunityAddress">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å°åŒºæè¿°:</label>
                            <input type="text" id="editCommunityDescription" placeholder="å¦‚: é«˜æ¡£ä½å®…å°åŒº">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeCommunityEditModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-success">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æˆ¿äº§ç®¡ç†é¡µé¢ -->
        <div id="properties" class="page">
            <div class="card">
                <h2>ğŸ¢ æ·»åŠ æˆ¿äº§</h2>
                <form id="propertyForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ‰€å±å°åŒº: <span style="color:red">*</span></label>
                            <select id="propertyCommunity" required>
                                <option value="">è¯·é€‰æ‹©å°åŒº</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æˆ¿äº§æ€§è´¨:</label>
                            <select id="propertyType">
                                <option value="æ™®é€šä½å®…">æ™®é€šä½å®…</option>
                                <option value="å…¬å¯“">å…¬å¯“</option>
                                <option value="å•†é“º">å•†é“º</option>
                                <option value="ä¸Šå ">ä¸Šå </option>
                                <option value="ä¸‹å ">ä¸‹å </option>
                                <option value="åˆ«å¢…">åˆ«å¢…</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¥¼æ ‹: <span style="color:red">*</span></label>
                            <input type="text" id="propertyBuilding" placeholder="å¦‚: Aæ ‹" required>
                        </div>
                        <div class="form-group">
                            <label>å•å…ƒ: <span style="color:red">*</span></label>
                            <input type="text" id="propertyUnit" placeholder="å¦‚: 1å•å…ƒ" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é—¨ç‰Œå·: <span style="color:red">*</span></label>
                            <input type="text" id="propertyRoom" placeholder="å¦‚: 101" required>
                        </div>
                        <div class="form-group">
                            <label>å»ºç­‘é¢ç§¯(ã¡): <span style="color:red">*</span></label>
                            <input type="number" id="propertyArea" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ˜¯å¦å·²äº¤æˆ¿:</label>
                            <select id="propertyDelivered">
                                <option value="0">æœªäº¤æˆ¿</option>
                                <option value="1">å·²äº¤æˆ¿</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ˜¯å¦è£…ä¿®:</label>
                            <select id="propertyDecorated">
                                <option value="0">æœªè£…ä¿®</option>
                                <option value="1">å·²è£…ä¿®</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å±…ä½çŠ¶æ€:</label>
                            <select id="propertyOccupancy">
                                <option value="ç©ºå…³">ç©ºå…³</option>
                                <option value="è‡ªä½">è‡ªä½</option>
                                <option value="å‡ºç§Ÿ">å‡ºç§Ÿ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ˜¯å¦ç§Ÿå”®:</label>
                            <select id="propertyForRent">
                                <option value="0">ä¸ç§Ÿå”®</option>
                                <option value="1">å¯ç§Ÿå”®</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>äº¤æˆ¿æ—¥æœŸ:</label>
                            <input type="date" id="propertyHandoverDate">
                        </div>
                        <div class="form-group">
                            <label>ä¸šä¸»:</label>
                            <select id="propertyOwner">
                                <option value="">è¯·é€‰æ‹©ä¸šä¸»</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">æ·»åŠ æˆ¿äº§</button>
                </form>
            </div>
            
            <div class="card">
                <h2>ğŸ  æˆ¿äº§åˆ—è¡¨</h2>
                <button onclick="loadProperties()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>å°åŒº</th>
                            <th>æˆ¿äº§æ€§è´¨</th>
                            <th>æ¥¼æ ‹-å•å…ƒ-é—¨ç‰Œå·</th>
                            <th>é¢ç§¯(ã¡)</th>
                            <th>äº¤æˆ¿çŠ¶æ€</th>
                            <th>è£…ä¿®çŠ¶æ€</th>
                            <th>å±…ä½çŠ¶æ€</th>
                            <th>ç§Ÿå”®çŠ¶æ€</th>
                            <th>ä¸šä¸»</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="propertyTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- æˆ¿äº§ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="propertyEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ¢ ç¼–è¾‘æˆ¿äº§ä¿¡æ¯</h2>
                    <span class="close" onclick="closePropertyEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- ç…§ç‰‡åŒºåŸŸ -->
                    <div class="photo-section">
                        <h3>æˆ¿äº§ç…§ç‰‡</h3>
                        <div class="photos-gallery" id="propertyPhotosGallery">
                            <!-- ç…§ç‰‡å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                        </div>
                        <div class="photo-actions">
                            <label for="propertyPhotoInput" class="btn btn-secondary">
                                ğŸ“¸ æ·»åŠ ç…§ç‰‡
                                <input type="file" id="propertyPhotoInput" accept="image/*" style="display: none;">
                            </label>
                            <button type="button" id="uploadPropertyPhotoBtn" class="btn" style="display: none;">ä¸Šä¼ ç…§ç‰‡</button>
                        </div>
                    </div>

                    <!-- ä¿¡æ¯ç¼–è¾‘è¡¨å• -->
                    <form id="propertyEditForm">
                        <input type="hidden" id="editPropertyId">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ‰€å±å°åŒº: <span style="color:red">*</span></label>
                                <select id="editPropertyCommunity" required>
                                    <option value="">è¯·é€‰æ‹©å°åŒº</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æˆ¿äº§æ€§è´¨:</label>
                                <select id="editPropertyType">
                                    <option value="æ™®é€šä½å®…">æ™®é€šä½å®…</option>
                                    <option value="å…¬å¯“">å…¬å¯“</option>
                                    <option value="å•†é“º">å•†é“º</option>
                                    <option value="ä¸Šå ">ä¸Šå </option>
                                    <option value="ä¸‹å ">ä¸‹å </option>
                                    <option value="åˆ«å¢…">åˆ«å¢…</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ¥¼æ ‹: <span style="color:red">*</span></label>
                                <input type="text" id="editPropertyBuilding" required>
                            </div>
                            <div class="form-group">
                                <label>å•å…ƒ: <span style="color:red">*</span></label>
                                <input type="text" id="editPropertyUnit" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>é—¨ç‰Œå·: <span style="color:red">*</span></label>
                                <input type="text" id="editPropertyRoom" required>
                            </div>
                            <div class="form-group">
                                <label>å»ºç­‘é¢ç§¯(ã¡): <span style="color:red">*</span></label>
                                <input type="number" id="editPropertyArea" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ˜¯å¦å·²äº¤æˆ¿:</label>
                                <select id="editPropertyDelivered">
                                    <option value="0">æœªäº¤æˆ¿</option>
                                    <option value="1">å·²äº¤æˆ¿</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ˜¯å¦è£…ä¿®:</label>
                                <select id="editPropertyDecorated">
                                    <option value="0">æœªè£…ä¿®</option>
                                    <option value="1">å·²è£…ä¿®</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å±…ä½çŠ¶æ€:</label>
                                <select id="editPropertyOccupancy">
                                    <option value="ç©ºå…³">ç©ºå…³</option>
                                    <option value="è‡ªä½">è‡ªä½</option>
                                    <option value="å‡ºç§Ÿ">å‡ºç§Ÿ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ˜¯å¦ç§Ÿå”®:</label>
                                <select id="editPropertyForRent">
                                    <option value="0">ä¸ç§Ÿå”®</option>
                                    <option value="1">å¯ç§Ÿå”®</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>äº¤æˆ¿æ—¥æœŸ:</label>
                                <input type="date" id="editPropertyHandoverDate">
                            </div>
                            <div class="form-group">
                                <label>ä¸šä¸»:</label>
                                <select id="editPropertyOwner">
                                    <option value="">è¯·é€‰æ‹©ä¸šä¸»</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-success">ä¿å­˜ä¿®æ”¹</button>
                            <button type="button" class="btn btn-secondary" onclick="closePropertyEditModal()">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- è½¦ä½ç®¡ç†é¡µé¢ -->
        <div id="parking" class="page">
            <div class="card">
                <h2>ğŸ…¿ï¸ æ·»åŠ è½¦ä½</h2>
                <form id="parkingForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ‰€å±å°åŒº:</label>
                            <select id="parkingCommunity" required>
                                <option value="">è¯·é€‰æ‹©å°åŒº</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è½¦ä½ç¼–å·:</label>
                            <input type="text" id="parkingNumber" placeholder="å¦‚: B1-001" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è½¦ä½ç±»å‹:</label>
                            <select id="parkingType">
                                <option value="åœ°ä¸‹">åœ°ä¸‹</option>
                                <option value="åœ°ä¸Š">åœ°ä¸Š</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è½¦ä½çŠ¶æ€:</label>
                            <select id="parkingStatus">
                                <option value="è‡ªç”¨">è‡ªç”¨</option>
                                <option value="å¾…å‡ºç§Ÿ">å¾…å‡ºç§Ÿ</option>
                                <option value="æœªäº¤æˆ¿">æœªäº¤æˆ¿</option>
                                <option value="å‡ºç§Ÿä¸­">å‡ºç§Ÿä¸­</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è½¦ä½ä¸šä¸»:</label>
                            <select id="parkingOwner">
                                <option value="">è¯·é€‰æ‹©ä¸šä¸»</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">æ·»åŠ è½¦ä½</button>
                </form>
            </div>
            
            <div class="card">
                <h2>ğŸ…¿ï¸ è½¦ä½åˆ—è¡¨</h2>
                <button onclick="loadParkingSpaces()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>å°åŒº</th>
                            <th>è½¦ä½ç¼–å·</th>
                            <th>ç±»å‹</th>
                            <th>çŠ¶æ€</th>
                            <th>ä¸šä¸»</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="parkingTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- è½¦ä½ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="parkingEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ…¿ï¸ ç¼–è¾‘è½¦ä½ä¿¡æ¯</h2>
                    <span class="close" onclick="closeParkingEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="parkingEditForm">
                        <input type="hidden" id="editParkingId">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ‰€å±å°åŒº: <span style="color:red">*</span></label>
                                <select id="editParkingCommunity" required>
                                    <option value="">è¯·é€‰æ‹©å°åŒº</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>è½¦ä½ç¼–å·: <span style="color:red">*</span></label>
                                <input type="text" id="editParkingNumber" placeholder="å¦‚: B1-001" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>è½¦ä½ç±»å‹:</label>
                                <select id="editParkingType">
                                    <option value="åœ°ä¸‹">åœ°ä¸‹</option>
                                    <option value="åœ°ä¸Š">åœ°ä¸Š</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>è½¦ä½çŠ¶æ€:</label>
                                <select id="editParkingStatus">
                                    <option value="è‡ªç”¨">è‡ªç”¨</option>
                                    <option value="å¾…å‡ºç§Ÿ">å¾…å‡ºç§Ÿ</option>
                                    <option value="æœªäº¤æˆ¿">æœªäº¤æˆ¿</option>
                                    <option value="å‡ºç§Ÿä¸­">å‡ºç§Ÿä¸­</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>è½¦ä½ä¸šä¸»:</label>
                                <select id="editParkingOwner">
                                    <option value="">è¯·é€‰æ‹©ä¸šä¸»</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ä½ç½®æè¿°:</label>
                                <input type="text" id="editParkingLocation" placeholder="å¦‚: é è¿‘ç”µæ¢¯ï¼Œæ–¹ä¾¿åœè½¦">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æœˆç§Ÿé‡‘(å…ƒ):</label>
                                <input type="number" id="editParkingRent" step="0.01" placeholder="å¦‚: 200">
                            </div>
                            <div class="form-group">
                                <label>å¤‡æ³¨ä¿¡æ¯:</label>
                                <input type="text" id="editParkingRemark" placeholder="å…¶ä»–è¯´æ˜ä¿¡æ¯">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-success">ä¿å­˜ä¿®æ”¹</button>
                            <button type="button" class="btn btn-secondary" onclick="closeParkingEditModal()">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- æ”¶è´¹ç®¡ç†é¡µé¢ -->
        <div id="fees" class="page">
            <div class="card">
                <h2>ğŸ’° æ·»åŠ æ”¶è´¹è®°å½•</h2>
                <form id="feeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æˆ¿äº§:</label>
                            <select id="feeProperty" required onchange="updateFeeAmount()">
                                <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è´¹ç”¨ç±»å‹:</label>
                            <select id="feeType" required onchange="updateFeeAmount()">
                                <option value="">è¯·é€‰æ‹©è´¹ç”¨ç±»å‹</option>
                                <option value="ç‰©ä¸šè´¹">ç‰©ä¸šè´¹</option>
                                <option value="æ°´è´¹">æ°´è´¹</option>
                                <option value="ç”µè´¹">ç”µè´¹</option>
                                <option value="ç‡ƒæ°”è´¹">ç‡ƒæ°”è´¹</option>
                                <option value="åœè½¦è´¹">åœè½¦è´¹</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é‡‘é¢(å…ƒ):</label>
                            <input type="number" id="feeAmount" step="0.01" required>
                            <div id="feeAmountTip" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                        </div>
                        <div class="form-group">
                            <label>è´¹ç”¨å‘¨æœŸ:</label>
                            <input type="text" id="feePeriod" placeholder="å¦‚: 2025-01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>åˆ°æœŸæ—¥æœŸ:</label>
                            <input type="date" id="feeDueDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">æ·»åŠ æ”¶è´¹è®°å½•</button>
                </form>
            </div>
            
            <!-- æ”¶è´¹é¡¹ç›®ç®¡ç† -->
            <div class="card">
                <h2>âš™ï¸ æ”¶è´¹é¡¹ç›®ç®¡ç†</h2>
                <form id="feeItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>é¡¹ç›®åç§°: <span style="color:red">*</span></label>
                            <input type="text" id="feeItemName" placeholder="å¦‚: ç‰©ä¸šç®¡ç†è´¹" required>
                        </div>
                        <div class="form-group">
                            <label>å•ä»·(å…ƒ):</label>
                            <input type="number" id="feeItemPrice" step="0.01" placeholder="å¦‚: 2.5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è®¡è´¹æ–¹å¼:</label>
                            <select id="feeItemMethod">
                                <option value="">è¯·é€‰æ‹©è®¡è´¹æ–¹å¼</option>
                                <option value="æŒ‰é¢ç§¯">æŒ‰é¢ç§¯</option>
                                <option value="æŒ‰å¥—">æŒ‰å¥—</option>
                                <option value="æŒ‰æœˆ">æŒ‰æœˆ</option>
                                <option value="æŒ‰å¹´">æŒ‰å¹´</option>
                                <option value="æŒ‰æ¬¡">æŒ‰æ¬¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡¹ç›®æè¿°:</label>
                            <input type="text" id="feeItemDescription" placeholder="é¡¹ç›®è¯´æ˜">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">æ·»åŠ æ”¶è´¹é¡¹ç›®</button>
                </form>
                
                <h3 style="margin-top: 30px;">ğŸ“‹ æ”¶è´¹é¡¹ç›®åˆ—è¡¨</h3>
                <button onclick="loadFeeItems()" class="btn btn-secondary">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                <button onclick="saveBatchFeeItems()" class="btn btn-success">ğŸ’¾ ä¿å­˜æ‰€æœ‰ä¿®æ”¹</button>
                <span id="feeItemBatchUpdateStatus" style="margin-left: 15px; color: #666; display: none;">âœ… å·²ä¿å­˜</span>
                <table class="table" style="margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®åç§°</th>
                            <th>å•ä»·(å…ƒ)</th>
                            <th>è®¡è´¹æ–¹å¼</th>
                            <th>é¡¹ç›®æè¿°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="feeItemTableBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>ğŸ“‹ æ”¶è´¹è®°å½•åˆ—è¡¨</h2>
                <button onclick="loadFeeRecords()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                <button onclick="loadFeeStats()" class="btn">æ›´æ–°ç»Ÿè®¡</button>
                
                <div class="stats" style="margin: 20px 0;">
                    <div class="stat-card stat-green">
                        <h3 id="paidAmount">Â¥0</h3>
                        <p>å·²æ”¶è´¹ç”¨</p>
                    </div>
                    <div class="stat-card stat-red">
                        <h3 id="unpaidAmount">Â¥0</h3>
                        <p>æœªæ”¶è´¹ç”¨</p>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr><th>æˆ¿äº§</th><th>æˆ¿äº§ç±»å‹</th><th>ä¸šä¸»</th><th>è´¹ç”¨ç±»å‹</th><th>é‡‘é¢</th><th>å‘¨æœŸ</th><th>åˆ°æœŸæ—¥æœŸ</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody id="feeTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- é«˜çº§æ”¶è´¹ç®¡ç†é¡µé¢ -->
        <div id="advanced-fees" class="page">
            <!-- æ”¶è´¹æ ‡å‡†ç®¡ç† -->
            <div class="card">
                <h2>âš™ï¸ æˆ¿äº§ç±»å‹æ”¶è´¹æ ‡å‡†</h2>
                <p style="color: #666; margin-bottom: 20px;">ä¸åŒæˆ¿äº§ç±»å‹çš„ç‰©ä¸šè´¹å•ä»·è®¾å®šï¼ŒæŒ‰é¢ç§¯è®¡ç®—è´¹ç”¨</p>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>æˆ¿äº§ç±»å‹</th>
                            <th>ç‰©ä¸šè´¹å•ä»·(å…ƒ/ã¡/æœˆ)</th>
                            <th>è®¡è´¹æ–¹å¼</th>
                        </tr>
                    </thead>
                    <tbody id="feeRatesTableBody">
                        <tr><td colspan="3">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                    <button onclick="saveBatchFeeRates()" class="btn btn-success">ğŸ’¾ ä¿å­˜æ‰€æœ‰ä¿®æ”¹</button>
                    <button onclick="loadPropertyFeeRates()" class="btn btn-secondary">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                    <button onclick="showAddPropertyTypeModal()" class="btn">ğŸ“ æ·»åŠ æˆ¿äº§ç±»å‹</button>
                    <span id="batchUpdateStatus" style="margin-left: 15px; color: #666; display: none;">âœ… å·²ä¿å­˜</span>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ§® ç‰©ä¸šè´¹è‡ªåŠ¨è®¡ç®—</h2>
                <form id="calculateFeesForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸šä¸»:</label>
                            <select id="calcOwner">
                                <option value="">è¯·é€‰æ‹©ä¸šä¸»</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æˆ¿äº§:</label>
                            <select id="calcProperty">
                                <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ:</label>
                            <input type="date" id="calcStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ:</label>
                            <input type="date" id="calcEndDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">è®¡ç®—è´¹ç”¨</button>
                </form>
                
                <div id="calcResults" style="margin-top: 20px; display: none;">
                    <h3>ğŸ“Š è®¡ç®—ç»“æœ</h3>
                    <div id="calcResultsContent"></div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ’§ æ°´ç”µè´¹ç®¡ç†</h2>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button onclick="showUtilityTab('water')" class="btn btn-secondary" id="waterTabBtn">æ°´è´¹æŠ„è¡¨</button>
                    <button onclick="showUtilityTab('electricity')" class="btn btn-secondary" id="electricityTabBtn">ç”µè´¹æŠ„è¡¨</button>
                    <button onclick="showUtilityTab('deposit')" class="btn btn-secondary" id="depositTabBtn">æŠ¼é‡‘ç®¡ç†</button>
                </div>
                
                <!-- æ°´è´¹æŠ„è¡¨ -->
                <div id="waterTab" class="utility-tab" style="display: none;">
                    <form id="waterReadingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æˆ¿äº§:</label>
                                <select id="waterProperty" required>
                                    <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æŠ„è¡¨æ—¥æœŸ:</label>
                                <input type="date" id="waterDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å½“å‰è¯»æ•°:</label>
                                <input type="number" id="waterReading" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>æ°´è´¹å•ä»·(å…ƒ/å¨):</label>
                                <input type="number" id="waterPrice" value="3.5" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¤‡æ³¨:</label>
                                <input type="text" id="waterRemark" placeholder="å¦‚: æœˆåº¦æŠ„è¡¨">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">æäº¤æŠ„è¡¨</button>
                    </form>
                </div>
                
                <!-- ç”µè´¹æŠ„è¡¨ -->
                <div id="electricityTab" class="utility-tab" style="display: none;">
                    <form id="electricityReadingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æˆ¿äº§:</label>
                                <select id="electricityProperty" required>
                                    <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æŠ„è¡¨æ—¥æœŸ:</label>
                                <input type="date" id="electricityDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å½“å‰è¯»æ•°:</label>
                                <input type="number" id="electricityReading" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>é¢„ä»˜è´¹å……å€¼:</label>
                                <input type="number" id="electricityRecharge" step="0.01" placeholder="å¯é€‰">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¤‡æ³¨:</label>
                                <input type="text" id="electricityRemark" placeholder="å¦‚: æœˆåº¦æŠ„è¡¨+å……å€¼">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">æäº¤æŠ„è¡¨</button>
                    </form>
                </div>
                
                <!-- æŠ¼é‡‘ç®¡ç† -->
                <div id="depositTab" class="utility-tab" style="display: none;">
                    <form id="depositForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æˆ¿äº§:</label>
                                <select id="depositProperty" required>
                                    <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æŠ¼é‡‘ç±»å‹:</label>
                                <select id="depositType" required>
                                    <option value="æ°´è´¹æŠ¼é‡‘">æ°´è´¹æŠ¼é‡‘</option>
                                    <option value="è£…ä¿®æŠ¼é‡‘">è£…ä¿®æŠ¼é‡‘</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æŠ¼é‡‘é‡‘é¢:</label>
                                <input type="number" id="depositAmount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>ç¼´è´¹æ—¥æœŸ:</label>
                                <input type="date" id="depositDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¤‡æ³¨:</label>
                                <input type="text" id="depositRemark" placeholder="æŠ¼é‡‘è¯´æ˜">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">åˆ›å»ºæŠ¼é‡‘è®°å½•</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ« æ¯æ—¥æ”¶å…¥ç®¡ç†</h2>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button onclick="showIncomeTab('access-card')" class="btn btn-secondary" id="accessCardTabBtn">é—¨ç¦å¡</button>
                    <button onclick="showIncomeTab('fire-test')" class="btn btn-secondary" id="fireTestTabBtn">æ¶ˆé˜²æ”¾æ°´</button>
                    <button onclick="showIncomeTab('other')" class="btn btn-secondary" id="otherTabBtn">å…¶ä»–æ”¶è´¹</button>
                </div>
                
                <!-- é—¨ç¦å¡æ”¶è´¹ -->
                <div id="accessCardTab" class="income-tab" style="display: none;">
                    <form id="accessCardForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æˆ¿äº§:</label>
                                <select id="accessCardProperty" required>
                                    <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é—¨ç¦å¡æ•°é‡:</label>
                                <input type="number" id="accessCardQuantity" min="1" value="1" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å•ä»·(å…ƒ/å¼ ):</label>
                                <input type="number" id="accessCardPrice" value="20" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>æ”¶è´¹æ—¥æœŸ:</label>
                                <input type="date" id="accessCardDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¯´æ˜:</label>
                                <input type="text" id="accessCardDescription" placeholder="å¦‚: å¼ ä¸‰é—¨ç¦å¡2å¼ ">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">è®°å½•æ”¶è´¹</button>
                    </form>
                </div>
                
                <!-- æ¶ˆé˜²æ”¾æ°´è´¹ -->
                <div id="fireTestTab" class="income-tab" style="display: none;">
                    <form id="fireTestForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æˆ¿äº§:</label>
                                <select id="fireTestProperty" required>
                                    <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>è´¹ç”¨(å…ƒ):</label>
                                <input type="number" id="fireTestAmount" value="100" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ”¶è´¹æ—¥æœŸ:</label>
                                <input type="date" id="fireTestDate" required>
                            </div>
                            <div class="form-group">
                                <label>è¯´æ˜:</label>
                                <input type="text" id="fireTestDescription" placeholder="å¦‚: Aæ ‹1å•å…ƒ101æ¶ˆé˜²æ”¾æ°´">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">è®°å½•æ”¶è´¹</button>
                    </form>
                </div>
                
                <!-- å…¶ä»–æ”¶è´¹ -->
                <div id="otherTab" class="income-tab" style="display: none;">
                    <form id="otherIncomeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æˆ¿äº§:</label>
                                <select id="otherProperty">
                                    <option value="">è¯·é€‰æ‹©æˆ¿äº§(å¯é€‰)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ”¶è´¹ç±»å‹:</label>
                                <input type="text" id="otherIncomeType" placeholder="å¦‚: åœè½¦è´¹" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>è´¹ç”¨(å…ƒ):</label>
                                <input type="number" id="otherAmount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>æ”¶è´¹æ—¥æœŸ:</label>
                                <input type="date" id="otherDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¯´æ˜:</label>
                                <input type="text" id="otherDescription" placeholder="æ”¶è´¹è¯´æ˜">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">è®°å½•æ”¶è´¹</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ç§Ÿèµç®¡ç†é¡µé¢ -->
        <div id="rental" class="page">
            <div class="card">
                <h2>ğŸ  æˆ¿å±‹ç§Ÿå”®</h2>
                <button onclick="loadRentalProperties()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>å°åŒº</th>
                            <th>æˆ¿äº§</th>
                            <th>é¢ç§¯</th>
                            <th>ç±»å‹</th>
                            <th>ä¸šä¸»</th>
                            <th>ç§Ÿé‡‘</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rentalPropertiesBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>ğŸ…¿ï¸ è½¦ä½ç§Ÿå”®</h2>
                <button onclick="loadRentalParkingSpaces()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>å°åŒº</th>
                            <th>è½¦ä½ç¼–å·</th>
                            <th>ç±»å‹</th>
                            <th>ä¸šä¸»</th>
                            <th>ä½ç½®æè¿°</th>
                            <th>ç§Ÿé‡‘</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rentalParkingBody"></tbody>
                </table>
            </div>

            <div class="card">
                <h2>ğŸ“‹ åˆåŒç®¡ç†</h2>
                <button onclick="toggleContractForm()" class="btn btn-success">æ–°å»ºåˆåŒ</button>
                <button onclick="loadRentalContracts()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                
                <!-- åˆåŒåˆ›å»ºè¡¨å• -->
                <div id="contractForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #3498db; border-radius: 8px; background-color: #f8f9fa;">
                    <h3>ğŸ“ æ–°å»ºç§ŸèµåˆåŒ</h3>
                    <form onsubmit="createContract(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>åˆåŒç¼–å·:</label>
                                <input type="text" id="contractNumber" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label>ç§Ÿèµç±»å‹:</label>
                                <select id="rentalType" required onchange="updateRentalOptions()">
                                    <option value="">è¯·é€‰æ‹©ç§Ÿèµç±»å‹</option>
                                    <option value="property">æˆ¿å±‹ç§Ÿèµ</option>
                                    <option value="parking">è½¦ä½ç§Ÿèµ</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label id="rentalObjectLabel">ç§Ÿèµå¯¹è±¡:</label>
                                <select id="rentalObject" required>
                                    <option value="">è¯·å…ˆé€‰æ‹©ç§Ÿèµç±»å‹</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ç§Ÿå®¢ä¿¡æ¯:</label>
                                <select id="tenantSelect" required>
                                    <option value="">è¯·é€‰æ‹©ç§Ÿå®¢</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>æœˆç§Ÿé‡‘(å…ƒ):</label>
                                <input type="number" id="monthlyRent" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>æŠ¼é‡‘(å…ƒ):</label>
                                <input type="number" id="depositAmount" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>åˆåŒå¼€å§‹æ—¥æœŸ:</label>
                                <input type="date" id="contractStart" required>
                            </div>
                            <div class="form-group">
                                <label>åˆåŒç»“æŸæ—¥æœŸ:</label>
                                <input type="date" id="contractEnd" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ä»˜æ¬¾å‘¨æœŸ:</label>
                                <select id="paymentCycle" required>
                                    <option value="monthly">æœˆä»˜</option>
                                    <option value="quarterly">å­£ä»˜</option>
                                    <option value="semi_annual">åŠå¹´ä»˜</option>
                                    <option value="annual">å¹´ä»˜</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>åˆåŒçŠ¶æ€:</label>
                                <select id="contractStatus">
                                    <option value="active">ç”Ÿæ•ˆä¸­</option>
                                    <option value="pending">å¾…ç”Ÿæ•ˆ</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å¤‡æ³¨:</label>
                            <textarea id="contractRemarks" rows="3" placeholder="åˆåŒå¤‡æ³¨ä¿¡æ¯"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">åˆ›å»ºåˆåŒ</button>
                            <button type="button" onclick="cancelContractForm()" class="btn btn-secondary" style="margin-left: 10px;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>åˆåŒç¼–å·</th>
                            <th>ç§Ÿèµå¯¹è±¡</th>
                            <th>ç§Ÿå®¢</th>
                            <th>ç§Ÿé‡‘</th>
                            <th>æŠ¼é‡‘</th>
                            <th>å¼€å§‹æ—¥æœŸ</th>
                            <th>ç»“æŸæ—¥æœŸ</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="contractsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- è£…ä¿®ç®¡ç†é¡µé¢ -->
        <div id="decoration" class="page">
            <div class="card">
                <h2>ğŸ”¨ è£…ä¿®è®¸å¯ç®¡ç†</h2>
                <button onclick="toggleDecorationForm()" class="btn btn-success">æ–°å»ºè£…ä¿®è®¸å¯</button>
                <button onclick="loadDecorationPermits()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                
                <!-- è£…ä¿®è®¸å¯åˆ›å»ºè¡¨å• -->
                <div id="decorationForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #e67e22; border-radius: 8px; background-color: #fef9e7;">
                    <h3>ğŸ“„ æ–°å»ºè£…ä¿®è®¸å¯ç”³è¯·</h3>
                    <form onsubmit="createDecorationPermit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>è®¸å¯è¯ç¼–å·:</label>
                                <input type="text" id="permitNumber" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label>è£…ä¿®æˆ¿äº§:</label>
                                <select id="decorationProperty" required>
                                    <option value="">è¯·é€‰æ‹©æˆ¿äº§</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è£…ä¿®ç±»å‹:</label>
                                <select id="decorationType" required>
                                    <option value="">è¯·é€‰æ‹©è£…ä¿®ç±»å‹</option>
                                    <option value="æ–°è£…ä¿®">æ–°è£…ä¿®</option>
                                    <option value="äºŒæ¬¡è£…ä¿®">äºŒæ¬¡è£…ä¿®</option>
                                    <option value="å±€éƒ¨è£…ä¿®">å±€éƒ¨è£…ä¿®</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ–½å·¥æ–¹åç§°:</label>
                                <input type="text" id="contractorName" required placeholder="è¯·è¾“å…¥æ–½å·¥æ–¹åç§°">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è”ç³»äººå§“å:</label>
                                <input type="text" id="contactPerson" required placeholder="è¯·è¾“å…¥è”ç³»äººå§“å">
                            </div>
                            <div class="form-group">
                                <label>è”ç³»ç”µè¯:</label>
                                <input type="tel" id="contactPhone" required placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è£…ä¿®å¼€å§‹æ—¥æœŸ:</label>
                                <input type="date" id="decorationStart" required>
                            </div>
                            <div class="form-group">
                                <label>é¢„è®¡ç»“æŸæ—¥æœŸ:</label>
                                <input type="date" id="decorationEnd" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è£…ä¿®æŠ¼é‡‘(å…ƒ):</label>
                                <input type="number" id="decorationDeposit" step="0.01" required placeholder="è¯·è¾“å…¥è£…ä¿®æŠ¼é‡‘">
                            </div>
                            <div class="form-group">
                                <label>æ¸…è¿è´¹(å…ƒ):</label>
                                <input type="number" id="cleaningFee" step="0.01" placeholder="è£…ä¿®åƒåœ¾æ¸…è¿è´¹">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ¶ˆé˜²æ”¾æ°´è´¹(å…ƒ):</label>
                                <input type="number" id="fireSafetyFee" step="0.01" placeholder="æ¶ˆé˜²ç”¨æ°´è´¹ç”¨">
                            </div>
                            <div class="form-group">
                                <label>å…¶ä»–è´¹ç”¨(å…ƒ):</label>
                                <input type="number" id="otherFees" step="0.01" placeholder="å…¶ä»–ç›¸å…³è´¹ç”¨">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>ç”³è¯·çŠ¶æ€:</label>
                            <select id="decorationStatus">
                                <option value="ç”³è¯·ä¸­">ç”³è¯·ä¸­</option>
                                <option value="å®¡æ‰¹é€šè¿‡">å®¡æ‰¹é€šè¿‡</option>
                                <option value="è£…ä¿®ä¸­">è£…ä¿®ä¸­</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>å¤‡æ³¨:</label>
                            <textarea id="decorationRemarks" rows="3" placeholder="è£…ä¿®ç›¸å…³å¤‡æ³¨ä¿¡æ¯"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">åˆ›å»ºè®¸å¯</button>
                            <button type="button" onclick="cancelDecorationForm()" class="btn btn-secondary" style="margin-left: 10px;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>è®¸å¯è¯ç¼–å·</th>
                            <th>æˆ¿äº§</th>
                            <th>ä¸šä¸»</th>
                            <th>æ–½å·¥æœŸé—´</th>
                            <th>è”ç³»äºº</th>
                            <th>è£…ä¿®æŠ¼é‡‘</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="decorationPermitsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- è½¦è¾†ç®¡ç†é¡µé¢ -->
        <div id="vehicles" class="page">
            <div class="card">
                <h2>ğŸš— è½¦ä½è½¦è¾†ç»‘å®š</h2>
                <button onclick="toggleVehicleBindingForm()" class="btn btn-success">æ–°å»ºç»‘å®š</button>
                <button onclick="loadVehicleBindings()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                
                <!-- è½¦è¾†ç»‘å®šåˆ›å»ºè¡¨å• -->
                <div id="vehicleBindingForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #27ae60; border-radius: 8px; background-color: #eafaf1;">
                    <h3>ğŸ”— æ–°å»ºè½¦è¾†ç»‘å®š</h3>
                    <form onsubmit="createVehicleBinding(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>è½¦ä½ä¿¡æ¯:</label>
                                <select id="bindingParkingSpace" required>
                                    <option value="">è¯·é€‰æ‹©è½¦ä½</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>è½¦ç‰Œå·:</label>
                                <input type="text" id="vehicleLicensePlate" required placeholder="è¯·è¾“å…¥è½¦ç‰Œå·" style="text-transform: uppercase;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è½¦å‹:</label>
                                <input type="text" id="vehicleModel" required placeholder="è¯·è¾“å…¥è½¦å‹">
                            </div>
                            <div class="form-group">
                                <label>è½¦è¾†é¢œè‰²:</label>
                                <input type="text" id="vehicleColor" placeholder="è¯·è¾“å…¥è½¦è¾†é¢œè‰²">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è½¦ä¸»ç±»å‹:</label>
                                <select id="ownerType" required onchange="updateOwnerOptions()">
                                    <option value="">è¯·é€‰æ‹©è½¦ä¸»ç±»å‹</option>
                                    <option value="ä¸šä¸»">ä¸šä¸»</option>
                                    <option value="ç§Ÿå®¢">ç§Ÿå®¢</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>è½¦ä¸»ä¿¡æ¯:</label>
                                <select id="vehicleOwner" required>
                                    <option value="">è¯·å…ˆé€‰æ‹©è½¦ä¸»ç±»å‹</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ç»‘å®šç±»å‹:</label>
                                <select id="bindingType" required>
                                    <option value="owner">ä¸šä¸»ä½¿ç”¨</option>
                                    <option value="rent">ç§Ÿèµä½¿ç”¨</option>
                                    <option value="temporary">ä¸´æ—¶åœæ”¾</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ç»‘å®šçŠ¶æ€:</label>
                                <select id="bindingStatus">
                                    <option value="active">æ­£å¸¸ä½¿ç”¨</option>
                                    <option value="pending">å¾…æ¿€æ´»</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ç»‘å®šå¼€å§‹æ—¥æœŸ:</label>
                                <input type="date" id="bindingStartDate" required>
                            </div>
                            <div class="form-group">
                                <label>ç»‘å®šç»“æŸæ—¥æœŸ:</label>
                                <input type="date" id="bindingEndDate" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™æœŸ">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å¤‡æ³¨:</label>
                            <textarea id="vehicleRemarks" rows="3" placeholder="è½¦è¾†ç»‘å®šç›¸å…³å¤‡æ³¨"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">åˆ›å»ºç»‘å®š</button>
                            <button type="button" onclick="cancelVehicleBindingForm()" class="btn btn-secondary" style="margin-left: 10px;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>è½¦ä½ç¼–å·</th>
                            <th>è½¦ç‰Œå·</th>
                            <th>è½¦å‹</th>
                            <th>ä¸šä¸»</th>
                            <th>ç»‘å®šç±»å‹</th>
                            <th>ç»‘å®šæ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="vehicleBindingsBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>âš ï¸ è¿ç« ç®¡ç†</h2>
                <button onclick="toggleViolationForm()" class="btn btn-success">ç™»è®°è¿ç« </button>
                <button onclick="loadViolations()" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                
                <!-- è¿ç« ç™»è®°è¡¨å• -->
                <div id="violationForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #e74c3c; border-radius: 8px; background-color: #fdedec;">
                    <h3>ğŸš¨ æ–°å¢è¿ç« è®°å½•</h3>
                    <form onsubmit="createViolation(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¿ç« ç¼–å·:</label>
                                <input type="text" id="violationNumber" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label>è½¦ç‰Œå·:</label>
                                <input type="text" id="violationLicensePlate" required placeholder="è¯·è¾“å…¥è½¦ç‰Œå·" style="text-transform: uppercase;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¿ç« ç±»å‹:</label>
                                <select id="violationType" required>
                                    <option value="">è¯·é€‰æ‹©è¿ç« ç±»å‹</option>
                                    <option value="ä¹±åœä¹±æ”¾">ä¹±åœä¹±æ”¾</option>
                                    <option value="å ç”¨æ¶ˆé˜²é€šé“">å ç”¨æ¶ˆé˜²é€šé“</option>
                                    <option value="å ç”¨ç»¿åŒ–å¸¦">å ç”¨ç»¿åŒ–å¸¦</option>
                                    <option value="è¶…é€Ÿè¡Œé©¶">è¶…é€Ÿè¡Œé©¶</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>è¿ç« åœ°ç‚¹:</label>
                                <input type="text" id="violationLocation" required placeholder="è¯·è¾“å…¥è¿ç« åœ°ç‚¹">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¿ç« æ—¶é—´:</label>
                                <input type="datetime-local" id="violationTime" required>
                            </div>
                            <div class="form-group">
                                <label>ç½šæ¬¾é‡‘é¢(å…ƒ):</label>
                                <input type="number" id="fineAmount" step="0.01" required placeholder="è¯·è¾“å…¥ç½šæ¬¾é‡‘é¢">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ä¸ŠæŠ¥äºº:</label>
                                <input type="text" id="violationReporter" placeholder="ä¸ŠæŠ¥äººå§“å">
                            </div>
                            <div class="form-group">
                                <label>å¤„ç†çŠ¶æ€:</label>
                                <select id="violationStatus">
                                    <option value="å¾…å¤„ç†">å¾…å¤„ç†</option>
                                    <option value="å·²é€šçŸ¥">å·²é€šçŸ¥</option>
                                    <option value="å·²å¤„ç†">å·²å¤„ç†</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å¤‡æ³¨:</label>
                            <textarea id="violationRemarks" rows="3" placeholder="è¿ç« æƒ…å†µè¯¦ç»†æè¿°"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">ç™»è®°è¿ç« </button>
                            <button type="button" onclick="cancelViolationForm()" class="btn btn-secondary" style="margin-left: 10px;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                
                <div class="stats" style="margin: 20px 0;">
                    <div class="stat-card stat-red">
                        <h3 id="pendingViolations">0</h3>
                        <p>å¾…å¤„ç†è¿ç« </p>
                    </div>
                    <div class="stat-card stat-blue">
                        <h3 id="totalFines">Â¥0</h3>
                        <p>ç½šæ¬¾æ€»é¢</p>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>è½¦ç‰Œå·</th>
                            <th>è¿ç« ç±»å‹</th>
                            <th>è¿ç« æ—¶é—´</th>
                            <th>åœ°ç‚¹</th>
                            <th>ç½šæ¬¾é‡‘é¢</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="violationsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- æ—¥æŠ¥ç®¡ç†é¡µé¢ -->
        <div id="reports" class="page">
            <div class="card">
                <h2>ğŸ“ˆ æ—¥æŠ¥è¡¨ç”Ÿæˆ</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>æŠ¥è¡¨ç±»å‹:</label>
                        <select id="reportType">
                            <option value="daily">æ—¥æŠ¥è¡¨</option>
                            <option value="monthly">æœˆæŠ¥è¡¨</option>
                            <option value="quarterly">å­£åº¦æŠ¥è¡¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æŸ¥è¯¢æ—¥æœŸ:</label>
                        <input type="date" id="reportDate">
                    </div>
                </div>
                <button onclick="generateReport()" class="btn btn-success">ç”ŸæˆæŠ¥è¡¨</button>
                <div id="reportResults" style="margin-top: 20px; display: none;"></div>
            </div>
            
            <div class="card">
                <h2>ğŸ’¸ æ¬ è´¹ç»Ÿè®¡</h2>
                <button onclick="loadOutstandingFees()" class="btn btn-secondary">åˆ·æ–°æ¬ è´¹ç»Ÿè®¡</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ä¸šä¸»</th>
                            <th>è”ç³»ç”µè¯</th>
                            <th>æˆ¿äº§</th>
                            <th>è½¦ä½</th>
                            <th>æ¬ è´¹ç¬”æ•°</th>
                            <th>æ¬ è´¹æ€»é¢</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="outstandingFeesBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>ğŸ” æ¬ è´¹çœ‹æ¿</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>æŸ¥è¯¢ç±»å‹:</label>
                        <select id="searchType">
                            <option value="owner">æŒ‰ä¸šä¸»åç§°</option>
                            <option value="property">æŒ‰é—¨ç‰Œå·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æŸ¥è¯¢å†…å®¹:</label>
                        <input type="text" id="searchValue" placeholder="è¾“å…¥ä¸šä¸»åç§°æˆ–é—¨ç‰Œå·(å¦‚: Aæ ‹-1å•å…ƒ-101)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆªæ­¢æ—¥æœŸ:</label>
                        <input type="date" id="dashboardEndDate">
                    </div>
                </div>
                <button onclick="searchOutstanding()" class="btn btn-success">æŸ¥è¯¢æ¬ è´¹</button>
                <div id="dashboardResults" style="margin-top: 20px; display: none;"></div>
            </div>
        </div>

        <!-- æˆ¿äº§ç…§ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
        <div id="propertyPhotosModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ  æˆ¿äº§ç…§ç‰‡</h2>
                    <span class="close" onclick="closePropertyPhotosModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="propertyPhotosContainer">
                        <!-- ç…§ç‰‡å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿ç« ç…§ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
        <div id="violationPhotosModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸš— è¿ç« ç…§ç‰‡</h2>
                    <span class="close" onclick="closeViolationPhotosModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="violationPhotosContainer">
                        <!-- ç…§ç‰‡å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¯¼å…¥é¡µé¢ -->
        <div id="import" class="page">
            <div class="card">
                <h2>ğŸ“¥ Excelæ•°æ®å¯¼å…¥</h2>
                <p style="color: #666; margin-bottom: 20px;">æ”¯æŒæ‰¹é‡å¯¼å…¥ä¸šä¸»ã€æˆ¿äº§ã€è½¦ä½æ•°æ®ã€‚è¯·å…ˆä¸‹è½½æ¨¡æ¿ï¼ŒæŒ‰æ ¼å¼å¡«å†™åä¸Šä¼ ã€‚</p>
                
                <!-- ä¸šä¸»æ•°æ®å¯¼å…¥ -->
                <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <h3>ğŸ‘¤ ä¸šä¸»æ•°æ®å¯¼å…¥</h3>
                    <div style="margin: 15px 0;">
                        <a href="javascript:downloadTemplate('owners')" class="btn btn-secondary">ğŸ“‹ ä¸‹è½½ä¸šä¸»å¯¼å…¥æ¨¡æ¿</a>
                        <span style="margin-left: 10px; color: #666;">æ”¯æŒå­—æ®µï¼šå§“å*ã€ç”µè¯ã€èº«ä»½è¯ã€å·¥ä½œå•ä½ã€èŒåŠ¡ã€çˆ±å¥½ã€å¤‡æ³¨</span>
                    </div>
                    <div style="margin: 15px 0;">
                        <input type="file" id="ownersFile" accept=".xlsx,.xls" style="margin-right: 10px;">
                        <button onclick="importData('owners')" class="btn btn-success">ğŸ“¤ å¯¼å…¥ä¸šä¸»æ•°æ®</button>
                    </div>
                    <div id="ownersResult" style="margin-top: 10px;"></div>
                </div>

                <!-- æˆ¿äº§æ•°æ®å¯¼å…¥ -->
                <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <h3>ğŸ¢ æˆ¿äº§æ•°æ®å¯¼å…¥</h3>
                    <div style="margin: 15px 0;">
                        <a href="javascript:downloadTemplate('properties')" class="btn btn-secondary">ğŸ“‹ ä¸‹è½½æˆ¿äº§å¯¼å…¥æ¨¡æ¿</a>
                        <span style="margin-left: 10px; color: #666;">æ”¯æŒå­—æ®µï¼šæ¥¼æ ‹*ã€å•å…ƒ*ã€æˆ¿å·*ã€é¢ç§¯*ã€æˆ¿äº§æ€§è´¨ã€ä¸šä¸»</span>
                    </div>
                    <div style="margin: 15px 0;">
                        <input type="file" id="propertiesFile" accept=".xlsx,.xls" style="margin-right: 10px;">
                        <button onclick="importData('properties')" class="btn btn-success">ğŸ“¤ å¯¼å…¥æˆ¿äº§æ•°æ®</button>
                    </div>
                    <div id="propertiesResult" style="margin-top: 10px;"></div>
                </div>

                <!-- è½¦ä½æ•°æ®å¯¼å…¥ -->
                <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <h3>ğŸ…¿ï¸ è½¦ä½æ•°æ®å¯¼å…¥</h3>
                    <div style="margin: 15px 0;">
                        <a href="javascript:downloadTemplate('parking')" class="btn btn-secondary">ğŸ“‹ ä¸‹è½½è½¦ä½å¯¼å…¥æ¨¡æ¿</a>
                        <span style="margin-left: 10px; color: #666;">æ”¯æŒå­—æ®µï¼šè½¦ä½ç¼–å·*ã€ç±»å‹ã€çŠ¶æ€ã€ä¸šä¸»ã€ä½ç½®æè¿°</span>
                    </div>
                    <div style="margin: 15px 0;">
                        <input type="file" id="parkingFile" accept=".xlsx,.xls" style="margin-right: 10px;">
                        <button onclick="importData('parking')" class="btn btn-success">ğŸ“¤ å¯¼å…¥è½¦ä½æ•°æ®</button>
                    </div>
                    <div id="parkingResult" style="margin-top: 10px;"></div>
                </div>

                <!-- å¯¼å…¥è¯´æ˜ -->
                <div class="card" style="background: #f8f9fa; border: 1px solid #e9ecef;">
                    <h3>ğŸ“ å¯¼å…¥è¯´æ˜</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>æ–‡ä»¶æ ¼å¼</strong>ï¼šä»…æ”¯æŒExcelæ–‡ä»¶(.xlsx, .xls)ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡5MB</li>
                        <li><strong>æ•°æ®é¡ºåº</strong>ï¼šå»ºè®®å…ˆå¯¼å…¥ä¸šä¸»ï¼Œå†å¯¼å…¥æˆ¿äº§å’Œè½¦ä½(å› ä¸ºæˆ¿äº§å’Œè½¦ä½éœ€è¦å…³è”ä¸šä¸»)</li>
                        <li><strong>å­—æ®µè¯´æ˜</strong>ï¼šå¸¦*çš„å­—æ®µä¸ºå¿…å¡«é¡¹ï¼Œå…¶ä»–ä¸ºå¯é€‰é¡¹</li>
                        <li><strong>ä¸šä¸»å…³è”</strong>ï¼šæˆ¿äº§å’Œè½¦ä½çš„"ä¸šä¸»"å­—æ®µè¯·å¡«å†™ä¸šä¸»å§“åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŒ¹é…</li>
                        <li><strong>æ•°æ®éªŒè¯</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯æ•°æ®æ ¼å¼ï¼Œé‡å¤æ•°æ®å°†è¢«è·³è¿‡</li>
                        <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå¯¼å…¥æ—¶å¦‚æœ‰é”™è¯¯ï¼Œä¼šæ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æˆ¿äº§ç±»å‹æ¨¡æ€æ¡† -->
    <div id="addPropertyTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ æ·»åŠ æˆ¿äº§ç±»å‹æ”¶è´¹æ ‡å‡†</h2>
                <span class="close" onclick="closeAddPropertyTypeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addPropertyTypeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æˆ¿äº§ç±»å‹åç§°: <span style="color:red">*</span></label>
                            <input type="text" id="newPropertyTypeName" placeholder="å¦‚: æ´‹æˆ¿" required>
                        </div>
                        <div class="form-group">
                            <label>ç‰©ä¸šè´¹å•ä»·(å…ƒ/ã¡/æœˆ): <span style="color:red">*</span></label>
                            <input type="number" id="newPropertyTypeRate" step="0.01" min="0" placeholder="å¦‚: 2.8" required>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeAddPropertyTypeModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-success">æ·»åŠ </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'owners') loadOwners();
            if (pageId === 'communities') loadCommunities();
            if (pageId === 'properties') { loadProperties(); loadCommunitiesForSelect(); loadOwnersForSelect(); }
            if (pageId === 'parking') { loadParkingSpaces(); loadCommunitiesForSelect(); loadOwnersForSelect(); }
            if (pageId === 'fees') { loadFeeRecords(); loadPropertiesForSelect(); loadFeeStats(); loadFeeItems(); loadFeeRatesCache(); }
            if (pageId === 'advanced-fees') { loadOwnersForSelect(); loadPropertiesForSelect(); loadPropertyFeeRates(); showUtilityTab('water'); }
            if (pageId === 'rental') { loadRentalProperties(); loadRentalParkingSpaces(); loadRentalContracts(); }
            if (pageId === 'decoration') { loadDecorationPermits(); }
            if (pageId === 'vehicles') { loadVehicleBindings(); loadViolations(); loadViolationStats(); }
            if (pageId === 'reports') { setDefaultReportDate(); }
            if (pageId === 'import') { /* æ•°æ®å¯¼å…¥é¡µé¢æ— éœ€åˆå§‹åŒ–åŠ è½½ */ }
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboard() {
            try {
                const [ownersRes, propertiesRes, parkingRes, feeStatsRes] = await Promise.all([
                    fetch(`${API_BASE}/owners`),
                    fetch(`${API_BASE}/properties`),
                    fetch(`${API_BASE}/parking`),
                    fetch(`${API_BASE}/fees/stats`)
                ]);
                
                const owners = await ownersRes.json();
                const properties = await propertiesRes.json();
                const parking = await parkingRes.json();
                const feeStats = await feeStatsRes.json();
                
                if (owners.success) document.getElementById('ownerCount').textContent = owners.data.length;
                if (properties.success) document.getElementById('propertyCount').textContent = properties.data.length;
                if (parking.success) document.getElementById('parkingCount').textContent = parking.data.length;
                if (feeStats.success) document.getElementById('feeTotal').textContent = 'Â¥' + (feeStats.data.unpaid_amount || 0);
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ä¸šä¸»åˆ—è¡¨
        async function loadOwners() {
            try {
                const response = await fetch(`${API_BASE}/owners`);
                const result = await response.json();
                
                const tbody = document.getElementById('ownerTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(owner => `
                        <tr>
                            <td>
                                ${owner.photo_url ? 
                                    `<img src="${API_BASE.replace('/api', '')}${owner.photo_url}" alt="ä¸šä¸»ç…§ç‰‡" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : 
                                    '<span style="color: #999;">æ— ç…§ç‰‡</span>'
                                }
                            </td>
                            <td>${owner.name}</td>
                            <td>${owner.phone || '-'}</td>
                            <td>${owner.id_card || '-'}</td>
                            <td>${owner.company || '-'}</td>
                            <td>${owner.position || '-'}</td>
                            <td>${owner.property_count || 0}</td>
                            <td>${owner.parking_count || 0}</td>
                            <td>
                                <button onclick="editOwner(${owner.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">ç¼–è¾‘</button>
                                <button onclick="deleteOwner(${owner.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½ä¸šä¸»åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æˆ¿äº§åˆ—è¡¨
        async function loadProperties() {
            try {
                const response = await fetch(`${API_BASE}/properties`);
                const result = await response.json();
                
                const tbody = document.getElementById('propertyTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(property => `
                        <tr>
                            <td>${property.community_name || 'æœªçŸ¥å°åŒº'}</td>
                            <td>${property.property_type}</td>
                            <td>${property.building}-${property.unit}-${property.room}</td>
                            <td>${property.area}</td>
                            <td>${property.is_delivered ? 'å·²äº¤æˆ¿' : 'æœªäº¤æˆ¿'}</td>
                            <td>${property.is_decorated ? 'å·²è£…ä¿®' : 'æœªè£…ä¿®'}</td>
                            <td>${property.occupancy_status}</td>
                            <td>${property.is_for_rent ? 'å¯ç§Ÿå”®' : 'ä¸ç§Ÿå”®'}</td>
                            <td>${property.owner_name || 'ç©ºç½®'}</td>
                            <td>
                                <button onclick="editProperty(${property.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">ç¼–è¾‘</button>
                                <button onclick="deleteProperty(${property.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿äº§åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ä¸šä¸»é€‰é¡¹
        async function loadOwnersForSelect() {
            try {
                const response = await fetch(`${API_BASE}/owners`);
                const result = await response.json();
                
                const propertySelect = document.getElementById('propertyOwner');
                const parkingSelect = document.getElementById('parkingOwner');
                const calcOwnerSelect = document.getElementById('calcOwner');
                const editPropertyOwnerSelect = document.getElementById('editPropertyOwner');
                const editParkingOwnerSelect = document.getElementById('editParkingOwner');
                
                if (result.success) {
                    const options = '<option value="">è¯·é€‰æ‹©ä¸šä¸»</option>' + 
                        result.data.map(owner => `<option value="${owner.id}">${owner.name}${owner.phone ? ' - ' + owner.phone : ''}</option>`).join('');
                    
                    if (propertySelect) propertySelect.innerHTML = options;
                    if (parkingSelect) parkingSelect.innerHTML = options;
                    if (calcOwnerSelect) calcOwnerSelect.innerHTML = options;
                    if (editPropertyOwnerSelect) editPropertyOwnerSelect.innerHTML = options;
                    if (editParkingOwnerSelect) editParkingOwnerSelect.innerHTML = options;
                }
            } catch (error) {
                console.error('åŠ è½½ä¸šä¸»é€‰é¡¹å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æˆ¿äº§é€‰é¡¹ï¼ˆå¢å¼ºç‰ˆï¼ŒåŒ…å«æˆ¿äº§è¯¦æƒ…ï¼‰
        async function loadPropertiesForSelect() {
            try {
                const response = await fetch(`${API_BASE}/properties`);
                const result = await response.json();
                
                const feePropertySelect = document.getElementById('feeProperty');
                const calcPropertySelect = document.getElementById('calcProperty');
                
                if (result.success) {
                    const options = '<option value="">è¯·é€‰æ‹©æˆ¿äº§</option>' + 
                        result.data.map(property => `<option value="${property.id}" data-area="${property.area}" data-type="${property.property_type}">${property.building}-${property.unit}-${property.room} (${property.property_type}, ${property.area}ã¡)</option>`).join('');
                        
                    if (feePropertySelect) feePropertySelect.innerHTML = options;
                    if (calcPropertySelect) calcPropertySelect.innerHTML = options;
                    
                    // åŒæ—¶å¡«å……é«˜çº§æ”¶è´¹é¡µé¢çš„å…¶ä»–æˆ¿äº§é€‰æ‹©æ¡†
                    const utilitySelects = [
                        'waterProperty', 'electricityProperty', 'depositProperty',
                        'accessCardProperty', 'fireTestProperty', 'otherProperty'
                    ];
                    
                    utilitySelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = options;
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿äº§é€‰é¡¹å¤±è´¥:', error);
            }
        }
        
        // å…¨å±€å­˜å‚¨è´¹ç‡æ•°æ®
        let propertyFeeRatesCache = {};
        
        // åŠ è½½è´¹ç‡æ•°æ®åˆ°ç¼“å­˜
        async function loadFeeRatesCache() {
            try {
                const response = await fetch(`${API_BASE}/advanced-fees/rates`);
                const result = await response.json();
                if (result.success) {
                    propertyFeeRatesCache = {};
                    result.data.forEach(rate => {
                        propertyFeeRatesCache[rate.property_type] = rate.unit_price;
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è´¹ç‡ç¼“å­˜å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°è´¹ç”¨é‡‘é¢å»ºè®®
        function updateFeeAmount() {
            const propertySelect = document.getElementById('feeProperty');
            const feeTypeSelect = document.getElementById('feeType');
            const amountInput = document.getElementById('feeAmount');
            const tipDiv = document.getElementById('feeAmountTip');
            
            if (!propertySelect.value || !feeTypeSelect.value) {
                tipDiv.innerHTML = '';
                return;
            }
            
            const selectedOption = propertySelect.options[propertySelect.selectedIndex];
            const area = parseFloat(selectedOption.dataset.area);
            const propertyType = selectedOption.dataset.type;
            const feeType = feeTypeSelect.value;
            
            if (feeType === 'ç‰©ä¸šè´¹' && area && propertyType && propertyFeeRatesCache[propertyType]) {
                const rate = propertyFeeRatesCache[propertyType];
                const monthlyAmount = area * rate;
                amountInput.value = monthlyAmount.toFixed(2);
                tipDiv.innerHTML = `ğŸ’¡ ${propertyType}æ ‡å‡†: ${rate}å…ƒ/ã¡/æœˆ Ã— ${area}ã¡ = ${monthlyAmount.toFixed(2)}å…ƒ/æœˆ`;
                tipDiv.style.color = '#28a745';
            } else if (feeType === 'ç‰©ä¸šè´¹') {
                tipDiv.innerHTML = 'âš ï¸ è¯¥æˆ¿äº§ç±»å‹æš‚æ— è´¹ç‡æ ‡å‡†ï¼Œè¯·åœ¨é«˜çº§æ”¶è´¹ç®¡ç†ä¸­è®¾ç½®';
                tipDiv.style.color = '#e74c3c';
            } else {
                tipDiv.innerHTML = '';
            }
        }
        
        // åŠ è½½æ”¶è´¹è®°å½•
        async function loadFeeRecords() {
            try {
                const response = await fetch(`${API_BASE}/fees`);
                const result = await response.json();
                
                const tbody = document.getElementById('feeTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(fee => `
                        <tr>
                            <td>${fee.building}-${fee.unit}-${fee.room}</td>
                            <td><span style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${fee.property_type || 'æœªçŸ¥'}</span></td>
                            <td>${fee.owner_name || 'æœªåˆ†é…'}</td>
                            <td>${fee.fee_type}</td>
                            <td>Â¥${fee.amount}</td>
                            <td>${fee.period}</td>
                            <td>${fee.due_date}</td>
                            <td style="color: ${fee.status === 'paid' ? '#27ae60' : '#e74c3c'};">
                                ${fee.status === 'paid' ? 'å·²ç¼´è´¹' : 'æœªç¼´è´¹'}
                            </td>
                            <td>
                                ${fee.status === 'unpaid' ? 
                                    `<button onclick="markAsPaid(${fee.id})" class="btn btn-success" style="padding: 5px 10px; font-size: 12px;">æ ‡è®°å·²ç¼´è´¹</button>` :
                                    `<button onclick="markAsUnpaid(${fee.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">æ ‡è®°æœªç¼´è´¹</button>`
                                }
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½æ”¶è´¹è®°å½•å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ”¶è´¹ç»Ÿè®¡
        async function loadFeeStats() {
            try {
                const response = await fetch(`${API_BASE}/fees/stats`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('paidAmount').textContent = 'Â¥' + (result.data.paid_amount || 0);
                    document.getElementById('unpaidAmount').textContent = 'Â¥' + (result.data.unpaid_amount || 0);
                }
            } catch (error) {
                console.error('åŠ è½½æ”¶è´¹ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // æ ‡è®°ä¸ºå·²ç¼´è´¹
        async function markAsPaid(feeId) {
            try {
                const response = await fetch(`${API_BASE}/fees/${feeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'paid' })
                });
                
                if (response.ok) {
                    loadFeeRecords();
                    loadFeeStats();
                    loadDashboard();
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥');
            }
        }
        
        // æ ‡è®°ä¸ºæœªç¼´è´¹
        async function markAsUnpaid(feeId) {
            try {
                const response = await fetch(`${API_BASE}/fees/${feeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'unpaid' })
                });
                
                if (response.ok) {
                    loadFeeRecords();
                    loadFeeStats();
                    loadDashboard();
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥');
            }
        }
        
        // æ·»åŠ ä¸šä¸»
        document.getElementById('ownerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('ownerName').value,
                phone: document.getElementById('ownerPhone').value,
                id_card: document.getElementById('ownerIdCard').value,
                company: document.getElementById('ownerCompany').value,
                position: document.getElementById('ownerPosition').value,
                hobby: document.getElementById('ownerHobby').value,
                remark: document.getElementById('ownerRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/owners`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ä¸šä¸»æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('ownerForm').reset();
                    loadOwners();
                    loadDashboard();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        // æ·»åŠ æˆ¿äº§
        document.getElementById('propertyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                community_id: document.getElementById('propertyCommunity').value,
                property_type: document.getElementById('propertyType').value,
                building: document.getElementById('propertyBuilding').value,
                unit: document.getElementById('propertyUnit').value,
                room: document.getElementById('propertyRoom').value,
                area: parseFloat(document.getElementById('propertyArea').value),
                is_delivered: document.getElementById('propertyDelivered').value,
                is_decorated: document.getElementById('propertyDecorated').value,
                occupancy_status: document.getElementById('propertyOccupancy').value,
                is_for_rent: document.getElementById('propertyForRent').value,
                handover_date: document.getElementById('propertyHandoverDate').value,
                owner_id: document.getElementById('propertyOwner').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/properties`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æˆ¿äº§æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('propertyForm').reset();
                    loadProperties();
                    loadDashboard();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        // æˆ¿äº§ç¼–è¾‘è¡¨å•æäº¤
        document.getElementById('propertyEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const propertyId = document.getElementById('editPropertyId').value;
            const formData = {
                community_id: document.getElementById('editPropertyCommunity').value,
                property_type: document.getElementById('editPropertyType').value,
                building: document.getElementById('editPropertyBuilding').value,
                unit: document.getElementById('editPropertyUnit').value,
                room: document.getElementById('editPropertyRoom').value,
                area: parseFloat(document.getElementById('editPropertyArea').value),
                is_delivered: document.getElementById('editPropertyDelivered').value,
                is_decorated: document.getElementById('editPropertyDecorated').value,
                occupancy_status: document.getElementById('editPropertyOccupancy').value,
                is_for_rent: document.getElementById('editPropertyForRent').value,
                handover_date: document.getElementById('editPropertyHandoverDate').value,
                owner_id: document.getElementById('editPropertyOwner').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æˆ¿äº§ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    closePropertyEditModal();
                    loadProperties();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        // æ·»åŠ æ”¶è´¹è®°å½•
        document.getElementById('feeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('feeProperty').value,
                fee_type: document.getElementById('feeType').value,
                amount: parseFloat(document.getElementById('feeAmount').value),
                period: document.getElementById('feePeriod').value,
                due_date: document.getElementById('feeDueDate').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/fees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ”¶è´¹è®°å½•æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('feeForm').reset();
                    loadFeeRecords();
                    loadFeeStats();
                    loadDashboard();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        // æ·»åŠ æ”¶è´¹é¡¹ç›®
        document.getElementById('feeItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('feeItemName').value,
                unit_price: document.getElementById('feeItemPrice').value || null,
                calculation_method: document.getElementById('feeItemMethod').value || null,
                description: document.getElementById('feeItemDescription').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/fees/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ”¶è´¹é¡¹ç›®æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('feeItemForm').reset();
                    loadFeeItems();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥');
                console.error(error);
            }
        });
        
        // åŠ è½½æ”¶è´¹é¡¹ç›®åˆ—è¡¨
        async function loadFeeItems() {
            try {
                const response = await fetch(`${API_BASE}/fees/items`);
                const result = await response.json();
                
                const tbody = document.getElementById('feeItemTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(item => `
                        <tr>
                            <td>
                                <input type="text" 
                                       id="item_name_${item.id}" 
                                       value="${item.name || ''}" 
                                       style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="markFeeItemAsModified()">
                            </td>
                            <td>
                                <input type="number" 
                                       id="item_price_${item.id}" 
                                       value="${item.unit_price || ''}" 
                                       step="0.01" 
                                       min="0"
                                       style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="markFeeItemAsModified()">
                            </td>
                            <td>
                                <select id="item_method_${item.id}" 
                                        style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                        onchange="markFeeItemAsModified()">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="æŒ‰é¢ç§¯" ${item.calculation_method === 'æŒ‰é¢ç§¯' ? 'selected' : ''}>æŒ‰é¢ç§¯</option>
                                    <option value="æŒ‰å¥—" ${item.calculation_method === 'æŒ‰å¥—' ? 'selected' : ''}>æŒ‰å¥—</option>
                                    <option value="æŒ‰æœˆ" ${item.calculation_method === 'æŒ‰æœˆ' ? 'selected' : ''}>æŒ‰æœˆ</option>
                                    <option value="æŒ‰å¹´" ${item.calculation_method === 'æŒ‰å¹´' ? 'selected' : ''}>æŒ‰å¹´</option>
                                    <option value="æŒ‰æ¬¡" ${item.calculation_method === 'æŒ‰æ¬¡' ? 'selected' : ''}>æŒ‰æ¬¡</option>
                                </select>
                            </td>
                            <td>
                                <input type="text" 
                                       id="item_desc_${item.id}" 
                                       value="${item.description || ''}" 
                                       style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="markFeeItemAsModified()">
                            </td>
                            <td>${new Date(item.created_at).toLocaleDateString()}</td>
                            <td>
                                <button onclick="deactivateFeeItem(${item.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">åœç”¨</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½æ”¶è´¹é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('feeItemTableBody').innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // æ ‡è®°æ”¶è´¹é¡¹ç›®ä¸ºå·²ä¿®æ”¹
        function markFeeItemAsModified() {
            const statusElement = document.getElementById('feeItemBatchUpdateStatus');
            statusElement.style.display = 'none';
        }

        // æ‰¹é‡ä¿å­˜æ”¶è´¹é¡¹ç›®
        async function saveBatchFeeItems() {
            const tbody = document.getElementById('feeItemTableBody');
            const rows = tbody.querySelectorAll('tr');
            const updates = [];
            
            // æ”¶é›†æ‰€æœ‰è¾“å…¥å€¼
            rows.forEach(row => {
                const nameInput = row.querySelector('[id^="item_name_"]');
                const priceInput = row.querySelector('[id^="item_price_"]');
                const methodSelect = row.querySelector('[id^="item_method_"]');
                const descInput = row.querySelector('[id^="item_desc_"]');
                
                if (nameInput) {
                    const itemId = nameInput.id.replace('item_name_', '');
                    updates.push({
                        id: parseInt(itemId),
                        name: nameInput.value.trim(),
                        unit_price: parseFloat(priceInput.value) || null,
                        calculation_method: methodSelect.value || null,
                        description: descInput.value.trim() || null
                    });
                }
            });
            
            if (updates.length === 0) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®');
                return;
            }
            
            try {
                // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
                const statusElement = document.getElementById('feeItemBatchUpdateStatus');
                statusElement.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
                statusElement.style.display = 'inline';
                statusElement.style.color = '#f39c12';
                
                // æ‰¹é‡æ›´æ–°æ‰€æœ‰æ”¶è´¹é¡¹ç›®
                const promises = updates.map(update => 
                    fetch(`${API_BASE}/fees/items/${update.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: update.name,
                            unit_price: update.unit_price,
                            calculation_method: update.calculation_method,
                            description: update.description
                        })
                    })
                );
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨æˆåŠŸ
                const failures = results.filter(r => !r.success);
                if (failures.length > 0) {
                    throw new Error(`${failures.length}ä¸ªæ”¶è´¹é¡¹ç›®æ›´æ–°å¤±è´¥`);
                }
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                statusElement.textContent = 'âœ… å·²ä¿å­˜';
                statusElement.style.color = '#27ae60';
                
                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                const statusElement = document.getElementById('feeItemBatchUpdateStatus');
                statusElement.textContent = 'âŒ ä¿å­˜å¤±è´¥';
                statusElement.style.color = '#e74c3c';
                
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                console.error('æ‰¹é‡ä¿å­˜æ”¶è´¹é¡¹ç›®å¤±è´¥:', error);
            }
        }
        
        // åœç”¨æ”¶è´¹é¡¹ç›®
        async function deactivateFeeItem(id) {
            if (!confirm('ç¡®å®šè¦åœç”¨æ­¤æ”¶è´¹é¡¹ç›®å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/fees/items/${id}/deactivate`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ”¶è´¹é¡¹ç›®å·²åœç”¨ï¼');
                    loadFeeItems();
                } else {
                    alert('åœç”¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åœç”¨å¤±è´¥');
                console.error(error);
            }
        }
        
        // åŠ è½½è½¦ä½åˆ—è¡¨
        async function loadParkingSpaces() {
            try {
                const response = await fetch(`${API_BASE}/parking`);
                const result = await response.json();
                
                const tbody = document.getElementById('parkingTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(parking => `
                        <tr>
                            <td>${parking.community_name || 'æœªçŸ¥å°åŒº'}</td>
                            <td>${parking.space_number}</td>
                            <td>${parking.type}</td>
                            <td>${parking.status}</td>
                            <td>${parking.owner_name || 'æ— '}</td>
                            <td>${new Date(parking.created_at).toLocaleDateString()}</td>
                            <td>
                                <button onclick="editParking(${parking.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">ç¼–è¾‘</button>
                                <button onclick="deleteParking(${parking.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½è½¦ä½åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å°åŒºé€‰é¡¹
        async function loadCommunitiesForSelect() {
            try {
                const response = await fetch(`${API_BASE}/communities`);
                const result = await response.json();
                
                const selects = ['propertyCommunity', 'parkingCommunity', 'editPropertyCommunity', 'editParkingCommunity'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (result.success && select) {
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©å°åŒº</option>' + 
                            result.data.map(community => `<option value="${community.id}">${community.name}</option>`).join('');
                    }
                });
            } catch (error) {
                console.error('åŠ è½½å°åŒºé€‰é¡¹å¤±è´¥:', error);
            }
        }
        
        // æœç´¢ä¸šä¸»
        async function searchOwners() {
            const searchTerm = document.getElementById('ownerSearchInput').value.trim();
            if (!searchTerm) {
                loadOwners();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/owners/search?keyword=${encodeURIComponent(searchTerm)}`);
                const result = await response.json();
                
                const tbody = document.getElementById('ownerTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(owner => `
                        <tr>
                            <td>
                                ${owner.photo_url ? 
                                    `<img src="${API_BASE.replace('/api', '')}${owner.photo_url}" alt="ä¸šä¸»ç…§ç‰‡" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : 
                                    '<span style="color: #999;">æ— ç…§ç‰‡</span>'
                                }
                            </td>
                            <td>${owner.name}</td>
                            <td>${owner.phone || '-'}</td>
                            <td>${owner.id_card || '-'}</td>
                            <td>${owner.company || '-'}</td>
                            <td>${owner.position || '-'}</td>
                            <td>${owner.property_count || 0}</td>
                            <td>${owner.parking_count || 0}</td>
                            <td>
                                <button onclick="editOwner(${owner.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">ç¼–è¾‘</button>
                                <button onclick="deleteOwner(${owner.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('æœç´¢ä¸šä¸»å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å°åŒºåˆ—è¡¨
        async function loadCommunities() {
            try {
                const response = await fetch(`${API_BASE}/communities`);
                const result = await response.json();
                
                const tbody = document.getElementById('communityTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(community => `
                        <tr>
                            <td>${community.name}</td>
                            <td>${community.address || '-'}</td>
                            <td>${community.description || '-'}</td>
                            <td>${community.property_count || 0}</td>
                            <td>${community.parking_count || 0}</td>
                            <td>${new Date(community.created_at).toLocaleDateString()}</td>
                            <td>
                                <button onclick="editCommunity(${community.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">ç¼–è¾‘</button>
                                <button onclick="deleteCommunity(${community.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½å°åŒºåˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ·»åŠ è½¦ä½
        document.getElementById('parkingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                community_id: document.getElementById('parkingCommunity').value,
                space_number: document.getElementById('parkingNumber').value,
                type: document.getElementById('parkingType').value,
                status: document.getElementById('parkingStatus').value,
                owner_id: document.getElementById('parkingOwner').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/parking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('è½¦ä½æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('parkingForm').reset();
                    loadParkingSpaces();
                    loadDashboard();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        // æ·»åŠ å°åŒº
        document.getElementById('communityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('communityName').value,
                address: document.getElementById('communityAddress').value,
                description: document.getElementById('communityDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/communities`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å°åŒºæ·»åŠ æˆåŠŸï¼');
                    document.getElementById('communityForm').reset();
                    loadCommunities();
                    loadCommunitiesForSelect(); // åˆ·æ–°å°åŒºé€‰é¡¹
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥');
                console.error(error);
            }
        });
        
        // ç¼–è¾‘ä¸šä¸»
        async function editOwner(id) {
            try {
                const response = await fetch(`${API_BASE}/owners/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const owner = result.data.owner;
                    
                    // å¡«å……è¡¨å•
                    document.getElementById('editOwnerId').value = owner.id;
                    document.getElementById('editOwnerName').value = owner.name || '';
                    document.getElementById('editOwnerPhone').value = owner.phone || '';
                    document.getElementById('editOwnerIdCard').value = owner.id_card || '';
                    document.getElementById('editOwnerCompany').value = owner.company || '';
                    document.getElementById('editOwnerPosition').value = owner.position || '';
                    document.getElementById('editOwnerHobby').value = owner.hobby || '';
                    document.getElementById('editOwnerRemark').value = owner.remark || '';
                    
                    // æ˜¾ç¤ºç…§ç‰‡
                    updatePhotoDisplay(owner.photo_url);
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('ownerEditModal').style.display = 'block';
                } else {
                    alert('è·å–ä¸šä¸»ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                alert('è·å–ä¸šä¸»ä¿¡æ¯å¤±è´¥');
                console.error(error);
            }
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeOwnerEditModal() {
            document.getElementById('ownerEditModal').style.display = 'none';
            document.getElementById('ownerPhotoInput').value = '';
            document.getElementById('uploadPhotoBtn').style.display = 'none';
        }
        
        // å…³é—­æˆ¿äº§ç¼–è¾‘æ¨¡æ€æ¡†
        function closePropertyEditModal() {
            document.getElementById('propertyEditModal').style.display = 'none';
            // æ¸…ç©ºç…§ç‰‡ä¸Šä¼ 
            document.getElementById('propertyPhotoInput').value = '';
            document.getElementById('uploadPropertyPhotoBtn').style.display = 'none';
        }
        
        // åŠ è½½æˆ¿äº§ç…§ç‰‡ç”¨äºç¼–è¾‘
        async function loadPropertyPhotosForEdit(propertyId) {
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}/photos`);
                const result = await response.json();
                
                const gallery = document.getElementById('propertyPhotosGallery');
                
                if (result.success && result.data && result.data.length > 0) {
                    gallery.className = 'photos-gallery';
                    gallery.innerHTML = result.data.map((photo, index) => `
                        <div class="photo-item">
                            <img src="${API_BASE.replace('/api', '')}${photo.url}" alt="æˆ¿äº§ç…§ç‰‡${index + 1}">
                            <button class="delete-btn" onclick="deletePropertyPhoto(${propertyId}, '${photo.url}')" title="åˆ é™¤ç…§ç‰‡">&times;</button>
                        </div>
                    `).join('');
                } else {
                    gallery.className = 'photos-gallery empty';
                    gallery.innerHTML = '';
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿äº§ç…§ç‰‡å¤±è´¥:', error);
                const gallery = document.getElementById('propertyPhotosGallery');
                gallery.className = 'photos-gallery empty';
                gallery.innerHTML = '';
            }
        }
        
        // åˆ é™¤æˆ¿äº§ç…§ç‰‡
        async function deletePropertyPhoto(propertyId, photoUrl) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}/photos`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photo_url: photoUrl })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ç…§ç‰‡åˆ é™¤æˆåŠŸï¼');
                    await loadPropertyPhotosForEdit(propertyId);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }
        
        // å¤„ç†æˆ¿äº§ç…§ç‰‡æ–‡ä»¶é€‰æ‹©
        document.getElementById('propertyPhotoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadPropertyPhotoBtn');
            
            if (file) {
                uploadBtn.style.display = 'inline-block';
            } else {
                uploadBtn.style.display = 'none';
            }
        });
        
        // ä¸Šä¼ æˆ¿äº§ç…§ç‰‡
        document.getElementById('uploadPropertyPhotoBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('propertyPhotoInput');
            const propertyId = document.getElementById('editPropertyId').value;
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ç…§ç‰‡');
                return;
            }
            
            if (!propertyId) {
                alert('æˆ¿äº§ä¿¡æ¯é”™è¯¯ï¼Œè¯·é‡æ–°é€‰æ‹©æˆ¿äº§è¿›è¡Œç¼–è¾‘');
                return;
            }
            
            const formData = new FormData();
            formData.append('photo', file);
            
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}/photos`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                    await loadPropertyPhotosForEdit(propertyId);
                    document.getElementById('uploadPropertyPhotoBtn').style.display = 'none';
                    fileInput.value = '';
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        // æ›´æ–°ç…§ç‰‡æ˜¾ç¤º
        function updatePhotoDisplay(photoUrl) {
            const preview = document.getElementById('ownerPhotoPreview');
            const placeholder = document.getElementById('noPhotoPlaceholder');
            const deleteBtn = document.getElementById('deletePhotoBtn');
            
            if (photoUrl) {
                preview.src = `${API_BASE.replace('/api', '')}${photoUrl}`;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
                deleteBtn.style.display = 'none';
            }
        }
        
        // å¤„ç†ç…§ç‰‡æ–‡ä»¶é€‰æ‹©
        document.getElementById('ownerPhotoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadPhotoBtn');
            
            if (file) {
                // æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('ownerPhotoPreview');
                    const placeholder = document.getElementById('noPhotoPlaceholder');
                    
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
                
                uploadBtn.style.display = 'inline-block';
            } else {
                uploadBtn.style.display = 'none';
            }
        });
        
        // ä¸Šä¼ ç…§ç‰‡
        document.getElementById('uploadPhotoBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('ownerPhotoInput');
            const ownerId = document.getElementById('editOwnerId').value;
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ç…§ç‰‡');
                return;
            }
            
            const formData = new FormData();
            formData.append('photo', file);
            
            try {
                const response = await fetch(`${API_BASE}/owners/${ownerId}/photo`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                    updatePhotoDisplay(result.data.photo_url);
                    document.getElementById('uploadPhotoBtn').style.display = 'none';
                    fileInput.value = '';
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥');
                console.error(error);
            }
        });
        
        // åˆ é™¤ç…§ç‰‡
        document.getElementById('deletePhotoBtn').addEventListener('click', async function() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) {
                return;
            }
            
            const ownerId = document.getElementById('editOwnerId').value;
            
            try {
                const response = await fetch(`${API_BASE}/owners/${ownerId}/photo`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ç…§ç‰‡åˆ é™¤æˆåŠŸï¼');
                    updatePhotoDisplay(null);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥');
                console.error(error);
            }
        });
        
        // æäº¤ç¼–è¾‘è¡¨å•
        document.getElementById('ownerEditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ownerId = document.getElementById('editOwnerId').value;
            const formData = {
                name: document.getElementById('editOwnerName').value,
                phone: document.getElementById('editOwnerPhone').value,
                id_card: document.getElementById('editOwnerIdCard').value,
                company: document.getElementById('editOwnerCompany').value,
                position: document.getElementById('editOwnerPosition').value,
                hobby: document.getElementById('editOwnerHobby').value,
                remark: document.getElementById('editOwnerRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/owners/${ownerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ä¸šä¸»ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    closeOwnerEditModal();
                    loadOwners(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥');
                console.error(error);
            }
        });
        
        async function deleteOwner(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¸šä¸»å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
                try {
                    const response = await fetch(`${API_BASE}/owners/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('ä¸šä¸»åˆ é™¤æˆåŠŸï¼');
                        loadOwners();
                        loadDashboard();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                    console.error(error);
                }
            }
        }
        
        async function editProperty(id) {
            try {
                const response = await fetch(`${API_BASE}/properties/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const property = result.data;
                    
                    // å…ˆåŠ è½½å°åŒºå’Œä¸šä¸»é€‰é¡¹
                    await loadCommunitiesForSelect();
                    await loadOwnersForSelect();
                    
                    // å¡«å……è¡¨å• - ç¡®ä¿æ­£ç¡®å¡«å……æ‰€æœ‰å­—æ®µ
                    document.getElementById('editPropertyId').value = property.id;
                    document.getElementById('editPropertyCommunity').value = property.community_id || '';
                    document.getElementById('editPropertyType').value = property.property_type || 'æ™®é€šä½å®…';
                    document.getElementById('editPropertyBuilding').value = property.building || '';
                    document.getElementById('editPropertyUnit').value = property.unit || '';
                    document.getElementById('editPropertyRoom').value = property.room || '';
                    document.getElementById('editPropertyArea').value = property.area || '';
                    document.getElementById('editPropertyDelivered').value = property.is_delivered ? '1' : '0';
                    document.getElementById('editPropertyDecorated').value = property.is_decorated ? '1' : '0';
                    document.getElementById('editPropertyOccupancy').value = property.occupancy_status || 'ç©ºå…³';
                    document.getElementById('editPropertyForRent').value = property.is_for_rent ? '1' : '0';
                    document.getElementById('editPropertyHandoverDate').value = property.handover_date || '';
                    document.getElementById('editPropertyOwner').value = property.owner_id || '';
                    
                    // åŠ è½½æˆ¿äº§ç…§ç‰‡
                    await loadPropertyPhotosForEdit(property.id);
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('propertyEditModal').style.display = 'block';
                } else {
                    alert('è·å–æˆ¿äº§ä¿¡æ¯å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è·å–æˆ¿äº§ä¿¡æ¯å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }
        
        async function deleteProperty(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æˆ¿äº§å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
                try {
                    const response = await fetch(`${API_BASE}/properties/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('æˆ¿äº§åˆ é™¤æˆåŠŸï¼');
                        loadProperties();
                        loadDashboard();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                    console.error(error);
                }
            }
        }
        
        async function editParking(id) {
            try {
                const response = await fetch(`${API_BASE}/parking/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const parking = result.data.parking;
                    
                    // å…ˆåŠ è½½å°åŒºå’Œä¸šä¸»é€‰é¡¹
                    await loadCommunitiesForSelect();
                    await loadOwnersForSelect();
                    
                    // å¡«å……è¡¨å• - ç¡®ä¿æ­£ç¡®å¡«å……æ‰€æœ‰å­—æ®µ
                    document.getElementById('editParkingId').value = parking.id;
                    document.getElementById('editParkingCommunity').value = parking.community_id || '';
                    document.getElementById('editParkingNumber').value = parking.space_number || '';
                    document.getElementById('editParkingType').value = parking.type || 'åœ°ä¸‹';
                    document.getElementById('editParkingStatus').value = parking.status || 'è‡ªç”¨';
                    document.getElementById('editParkingOwner').value = parking.owner_id || '';
                    document.getElementById('editParkingLocation').value = parking.location_description || '';
                    document.getElementById('editParkingRent').value = parking.rental_price || '';
                    document.getElementById('editParkingRemark').value = parking.remark || '';
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('parkingEditModal').style.display = 'block';
                } else {
                    alert('è·å–è½¦ä½ä¿¡æ¯å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è·å–è½¦ä½ä¿¡æ¯å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }
        
        // å…³é—­è½¦ä½ç¼–è¾‘æ¨¡æ€æ¡†
        function closeParkingEditModal() {
            document.getElementById('parkingEditModal').style.display = 'none';
        }
        
        // è½¦ä½ç¼–è¾‘è¡¨å•æäº¤
        document.getElementById('parkingEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const parkingId = document.getElementById('editParkingId').value;
            const formData = {
                community_id: document.getElementById('editParkingCommunity').value,
                space_number: document.getElementById('editParkingNumber').value,
                type: document.getElementById('editParkingType').value,
                status: document.getElementById('editParkingStatus').value,
                owner_id: document.getElementById('editParkingOwner').value || null,
                location_description: document.getElementById('editParkingLocation').value,
                rental_price: document.getElementById('editParkingRent').value ? parseFloat(document.getElementById('editParkingRent').value) : null,
                remark: document.getElementById('editParkingRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/parking/${parkingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('è½¦ä½ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    closeParkingEditModal();
                    loadParkingSpaces();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        async function deleteParking(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è½¦ä½å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
                try {
                    const response = await fetch(`${API_BASE}/parking/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('è½¦ä½åˆ é™¤æˆåŠŸï¼');
                        loadParkingSpaces();
                        loadDashboard();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                    console.error(error);
                }
            }
        }
        
        // ç¼–è¾‘å°åŒº
        async function editCommunity(id) {
            try {
                const response = await fetch(`${API_BASE}/communities/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const community = result.data;
                    
                    // å¡«å……è¡¨å•
                    document.getElementById('editCommunityId').value = community.id;
                    document.getElementById('editCommunityName').value = community.name || '';
                    document.getElementById('editCommunityAddress').value = community.address || '';
                    document.getElementById('editCommunityDescription').value = community.description || '';
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('communityEditModal').style.display = 'block';
                } else {
                    alert('è·å–å°åŒºä¿¡æ¯å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è·å–å°åŒºä¿¡æ¯å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }
        
        // å…³é—­å°åŒºç¼–è¾‘æ¨¡æ€æ¡†
        function closeCommunityEditModal() {
            document.getElementById('communityEditModal').style.display = 'none';
        }
        
        // å°åŒºç¼–è¾‘è¡¨å•æäº¤
        document.getElementById('communityEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const communityId = document.getElementById('editCommunityId').value;
            const formData = {
                name: document.getElementById('editCommunityName').value,
                address: document.getElementById('editCommunityAddress').value,
                description: document.getElementById('editCommunityDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/communities/${communityId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å°åŒºä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    closeCommunityEditModal();
                    loadCommunities();
                    loadCommunitiesForSelect(); // åˆ·æ–°å°åŒºé€‰é¡¹
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        async function deleteCommunity(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å°åŒºå—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼Œä¸”ä¼šå½±å“ç›¸å…³çš„æˆ¿äº§å’Œè½¦ä½æ•°æ®ï¼')) {
                try {
                    const response = await fetch(`${API_BASE}/communities/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('å°åŒºåˆ é™¤æˆåŠŸï¼');
                        loadCommunities();
                        loadCommunitiesForSelect(); // åˆ·æ–°å°åŒºé€‰é¡¹
                        loadDashboard(); // åˆ·æ–°ä»ªè¡¨ç›˜ç»Ÿè®¡
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                    console.error(error);
                }
            }
        }

        // ========== é«˜çº§æ”¶è´¹ç®¡ç† JavaScript ==========
        
        // åŠ è½½æˆ¿äº§ç±»å‹æ”¶è´¹æ ‡å‡†
        async function loadPropertyFeeRates() {
            try {
                const response = await fetch(`${API_BASE}/advanced-fees/rates`);
                const result = await response.json();
                
                const tbody = document.getElementById('feeRatesTableBody');
                if (result.success) {
                    const propertyTypes = ['æ™®é€šä½å®…', 'å…¬å¯“', 'å•†é“º', 'ä¸Šå ', 'ä¸‹å ', 'åˆ«å¢…'];
                    
                    tbody.innerHTML = propertyTypes.map(type => {
                        const rate = result.data.find(r => r.property_type === type);
                        const rateValue = rate ? rate.unit_price : 0;
                        return `
                            <tr>
                                <td><strong>${type}</strong></td>
                                <td>
                                    <input type="number" 
                                           id="rate_${type.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                           value="${rateValue}" 
                                           step="0.01" 
                                           min="0"
                                           style="width: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                           onchange="markAsModified()">
                                    <span style="color: #666; margin-left: 8px;">å…ƒ/ã¡/æœˆ</span>
                                </td>
                                <td>æŒ‰é¢ç§¯(ã¡)Ã—æœˆæ•°</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3">åŠ è½½å¤±è´¥</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½æ”¶è´¹æ ‡å‡†å¤±è´¥:', error);
                document.getElementById('feeRatesTableBody').innerHTML = '<tr><td colspan="3">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // ç¼–è¾‘æ”¶è´¹æ ‡å‡†
        // æ ‡è®°ä¸ºå·²ä¿®æ”¹
        function markAsModified() {
            const statusElement = document.getElementById('batchUpdateStatus');
            statusElement.style.display = 'none';
        }

        // æ‰¹é‡ä¿å­˜è´¹ç‡
        async function saveBatchFeeRates() {
            const propertyTypes = ['æ™®é€šä½å®…', 'å…¬å¯“', 'å•†é“º', 'ä¸Šå ', 'ä¸‹å ', 'åˆ«å¢…'];
            const updates = [];
            
            // æ”¶é›†æ‰€æœ‰è¾“å…¥å€¼
            for (const type of propertyTypes) {
                const inputId = `rate_${type.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const input = document.getElementById(inputId);
                if (input) {
                    const rate = parseFloat(input.value) || 0;
                    updates.push({
                        property_type: type,
                        fee_item_id: 1, // ç‰©ä¸šè´¹é¡¹ç›®ID
                        unit_price: rate
                    });
                }
            }
            
            if (updates.length === 0) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®');
                return;
            }
            
            try {
                // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
                const statusElement = document.getElementById('batchUpdateStatus');
                statusElement.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
                statusElement.style.display = 'inline';
                statusElement.style.color = '#f39c12';
                
                // æ‰¹é‡æ›´æ–°æ‰€æœ‰è´¹ç‡
                const promises = updates.map(update => 
                    fetch(`${API_BASE}/advanced-fees/rates`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(update)
                    })
                );
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨æˆåŠŸ
                const failures = results.filter(r => !r.success);
                if (failures.length > 0) {
                    throw new Error(`${failures.length}ä¸ªè´¹ç‡æ›´æ–°å¤±è´¥`);
                }
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                statusElement.textContent = 'âœ… å·²ä¿å­˜';
                statusElement.style.color = '#27ae60';
                
                // æ›´æ–°ç¼“å­˜
                loadFeeRatesCache();
                
                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                const statusElement = document.getElementById('batchUpdateStatus');
                statusElement.textContent = 'âŒ ä¿å­˜å¤±è´¥';
                statusElement.style.color = '#e74c3c';
                
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                console.error('æ‰¹é‡ä¿å­˜è´¹ç‡å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ æˆ¿äº§ç±»å‹æ¨¡æ€æ¡†
        function showAddPropertyTypeModal() {
            document.getElementById('addPropertyTypeModal').style.display = 'block';
        }

        // å…³é—­æ·»åŠ æˆ¿äº§ç±»å‹æ¨¡æ€æ¡†
        function closeAddPropertyTypeModal() {
            document.getElementById('addPropertyTypeModal').style.display = 'none';
            document.getElementById('addPropertyTypeForm').reset();
        }

        // å¤„ç†æ·»åŠ æˆ¿äº§ç±»å‹è¡¨å•æäº¤
        document.getElementById('addPropertyTypeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const typeName = document.getElementById('newPropertyTypeName').value.trim();
            const typeRate = parseFloat(document.getElementById('newPropertyTypeRate').value);
            
            if (!typeName || isNaN(typeRate) || typeRate < 0) {
                alert('è¯·å¡«å†™å®Œæ•´ä¸”æœ‰æ•ˆçš„ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/advanced-fees/rates`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        property_type: typeName,
                        fee_item_id: 1, // ç‰©ä¸šè´¹é¡¹ç›®ID
                        unit_price: typeRate
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('æˆ¿äº§ç±»å‹æ”¶è´¹æ ‡å‡†æ·»åŠ æˆåŠŸï¼');
                    closeAddPropertyTypeModal();
                    loadPropertyFeeRates();
                    loadFeeRatesCache(); // æ›´æ–°ç¼“å­˜
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
                console.error(error);
            }
        });
        
        // å·¥å…·æ ‡ç­¾åˆ‡æ¢
        function showUtilityTab(tabName) {
            document.querySelectorAll('.utility-tab').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('[id$="TabBtn"]').forEach(btn => btn.classList.remove('btn-primary'));
            
            document.getElementById(tabName + 'Tab').style.display = 'block';
            document.getElementById(tabName + 'TabBtn').classList.add('btn-primary');
        }
        
        // æ”¶å…¥æ ‡ç­¾åˆ‡æ¢
        function showIncomeTab(tabName) {
            document.querySelectorAll('.income-tab').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('[id$="TabBtn"]').forEach(btn => btn.classList.remove('btn-primary'));
            
            document.getElementById(tabName.replace('-', '') + 'Tab').style.display = 'block';
            document.getElementById(tabName.replace('-', '') + 'TabBtn').classList.add('btn-primary');
        }
        
        // ç‰©ä¸šè´¹è®¡ç®—è¡¨å•æäº¤
        document.getElementById('calculateFeesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ownerId = document.getElementById('calcOwner').value;
            const propertyId = document.getElementById('calcProperty').value;
            const startDate = document.getElementById('calcStartDate').value;
            const endDate = document.getElementById('calcEndDate').value;
            
            try {
                let url = `${API_BASE}/advanced-fees/calculate?start_date=${startDate}&end_date=${endDate}`;
                if (ownerId) url += `&owner_id=${ownerId}`;
                if (propertyId) url += `&property_id=${propertyId}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayCalculationResults(result.data);
                } else {
                    alert('è®¡ç®—å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è®¡ç®—å¤±è´¥');
                console.error(error);
            }
        });
        
        function displayCalculationResults(data) {
            const resultsDiv = document.getElementById('calcResultsContent');
            let html = '<table class="table"><thead><tr><th>æˆ¿äº§åœ°å€</th><th>æˆ¿äº§ç±»å‹</th><th>é¢ç§¯(ã¡)</th><th>æœˆæ•°</th><th>ç‰©ä¸šè´¹å•ä»·</th><th>ç‰©ä¸šè´¹</th><th>è½¦ä½è´¹</th><th>åˆè®¡</th></tr></thead><tbody>';
            
            let totalAmount = 0;
            data.forEach(item => {
                totalAmount += item.total_amount;
                html += `<tr>
                    <td>${item.address}</td>
                    <td><span style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${item.property_type}</span></td>
                    <td>${item.area}</td>
                    <td>${item.months}</td>
                    <td>Â¥${item.property_fee.unit_price}/ã¡/æœˆ</td>
                    <td>Â¥${item.property_fee.amount.toFixed(2)}</td>
                    <td>Â¥${item.parking_fee.amount.toFixed(2)}</td>
                    <td><strong>Â¥${item.total_amount.toFixed(2)}</strong></td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr><th colspan="7">æ€»è®¡</th><th><strong style="color: #e74c3c;">Â¥${totalAmount.toFixed(2)}</strong></th></tr></tfoot></table>`;
            html += '<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; color: #666;">ğŸ’¡ æç¤ºï¼šä¸åŒæˆ¿äº§ç±»å‹ä½¿ç”¨ä¸åŒçš„ç‰©ä¸šè´¹å•ä»·ï¼Œå•ä»·å¯åœ¨ä¸Šæ–¹æ”¶è´¹æ ‡å‡†ä¸­è°ƒæ•´</div>';
            resultsDiv.innerHTML = html;
            document.getElementById('calcResults').style.display = 'block';
        }
        
        // æ°´è´¹æŠ„è¡¨è¡¨å•
        document.getElementById('waterReadingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('waterProperty').value,
                reading_date: document.getElementById('waterDate').value,
                current_reading: parseFloat(document.getElementById('waterReading').value),
                unit_price: parseFloat(document.getElementById('waterPrice').value),
                remark: document.getElementById('waterRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/utilities/water`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æ°´è´¹æŠ„è¡¨æˆåŠŸï¼ç”¨é‡: ${result.data.usage}å¨ï¼Œè´¹ç”¨: Â¥${result.data.amount}`);
                    document.getElementById('waterReadingForm').reset();
                } else {
                    alert('æŠ„è¡¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æŠ„è¡¨å¤±è´¥');
                console.error(error);
            }
        });
        
        // ç”µè´¹æŠ„è¡¨è¡¨å•
        document.getElementById('electricityReadingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('electricityProperty').value,
                reading_date: document.getElementById('electricityDate').value,
                current_reading: parseFloat(document.getElementById('electricityReading').value),
                prepaid_amount: parseFloat(document.getElementById('electricityRecharge').value) || 0,
                remark: document.getElementById('electricityRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/utilities/electricity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`ç”µè´¹æŠ„è¡¨æˆåŠŸï¼ç”¨é‡: ${result.data.usage}åº¦ï¼Œä½™é¢: Â¥${result.data.balance}(${result.data.balance_status})`);
                    document.getElementById('electricityReadingForm').reset();
                } else {
                    alert('æŠ„è¡¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æŠ„è¡¨å¤±è´¥');
                console.error(error);
            }
        });
        
        // æŠ¼é‡‘ç®¡ç†è¡¨å•
        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('depositProperty').value,
                deposit_type: document.getElementById('depositType').value,
                amount: parseFloat(document.getElementById('depositAmount').value),
                paid_date: document.getElementById('depositDate').value,
                remark: document.getElementById('depositRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/utilities/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æŠ¼é‡‘è®°å½•åˆ›å»ºæˆåŠŸï¼');
                    document.getElementById('depositForm').reset();
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥');
                console.error(error);
            }
        });
        
        // é—¨ç¦å¡æ”¶è´¹è¡¨å•
        document.getElementById('accessCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('accessCardProperty').value,
                quantity: parseInt(document.getElementById('accessCardQuantity').value),
                unit_price: parseFloat(document.getElementById('accessCardPrice').value),
                record_date: document.getElementById('accessCardDate').value,
                description: document.getElementById('accessCardDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/daily-income/access-card`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`é—¨ç¦å¡æ”¶è´¹è®°å½•æˆåŠŸï¼é‡‘é¢: Â¥${result.data.amount}`);
                    document.getElementById('accessCardForm').reset();
                } else {
                    alert('è®°å½•å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è®°å½•å¤±è´¥');
                console.error(error);
            }
        });
        
        // æ¶ˆé˜²æ”¾æ°´è´¹è¡¨å•
        document.getElementById('fireTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('fireTestProperty').value,
                unit_price: parseFloat(document.getElementById('fireTestAmount').value),
                record_date: document.getElementById('fireTestDate').value,
                description: document.getElementById('fireTestDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/daily-income/fire-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æ¶ˆé˜²æ”¾æ°´è´¹è®°å½•æˆåŠŸï¼é‡‘é¢: Â¥${result.data.amount}`);
                    document.getElementById('fireTestForm').reset();
                } else {
                    alert('è®°å½•å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è®°å½•å¤±è´¥');
                console.error(error);
            }
        });
        
        // å…¶ä»–æ”¶è´¹è¡¨å•
        document.getElementById('otherIncomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('otherProperty').value || null,
                income_type: document.getElementById('otherIncomeType').value,
                amount: parseFloat(document.getElementById('otherAmount').value),
                record_date: document.getElementById('otherDate').value,
                description: document.getElementById('otherDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/daily-income/other`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æ”¶è´¹è®°å½•æˆåŠŸï¼é‡‘é¢: Â¥${result.data.amount}`);
                    document.getElementById('otherIncomeForm').reset();
                } else {
                    alert('è®°å½•å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è®°å½•å¤±è´¥');
                console.error(error);
            }
        });
        
        // ========== ç§Ÿèµç®¡ç† JavaScript ==========
        
        async function loadRentalProperties() {
            try {
                const response = await fetch(`${API_BASE}/rental/properties`);
                const result = await response.json();
                
                const tbody = document.getElementById('rentalPropertiesBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(property => `
                        <tr>
                            <td>${property.community_name || 'æœªçŸ¥å°åŒº'}</td>
                            <td>
                                ${property.building}${property.unit}${property.room}
                                <br>
                                ${property.photos ? 
                                    `<span style="color: #28a745; font-size: 12px;">ğŸ“¸ æœ‰ç…§ç‰‡</span>` : 
                                    `<span style="color: #6c757d; font-size: 12px;">ğŸ“· æ— ç…§ç‰‡</span>`
                                }
                            </td>
                            <td>${property.area}ã¡</td>
                            <td>${property.property_type}</td>
                            <td>${property.owner_name || 'æ— '}</td>
                            <td>Â¥${property.rental_price || 0}/æœˆ</td>
                            <td>${property.rental_status}</td>
                            <td>
                                <button onclick="viewPropertyPhotos('${property.building}${property.unit}${property.room}', '${property.photos || ''}')" class="btn" style="padding: 5px 10px; font-size: 12px;">æŸ¥çœ‹</button>
                                <button onclick="editRentalProperty(${property.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">ç¼–è¾‘</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½å¯ç§Ÿå”®æˆ¿äº§å¤±è´¥:', error);
            }
        }
        
        async function loadRentalParkingSpaces() {
            try {
                const response = await fetch(`${API_BASE}/rental/parking-spaces`);
                const result = await response.json();
                
                const tbody = document.getElementById('rentalParkingBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(parking => `
                        <tr>
                            <td>${parking.community_name || 'æœªçŸ¥å°åŒº'}</td>
                            <td>${parking.space_number}</td>
                            <td>${parking.type}</td>
                            <td>${parking.owner_name || 'æ— '}</td>
                            <td>${parking.location_description || '-'}</td>
                            <td>Â¥${parking.rental_price || 0}/æœˆ</td>
                            <td>${parking.status}</td>
                            <td>
                                <button onclick="editRentalParking(${parking.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">ç¼–è¾‘</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½å¯ç§Ÿå”®è½¦ä½å¤±è´¥:', error);
            }
        }
        
        async function loadRentalContracts() {
            try {
                const response = await fetch(`${API_BASE}/rental/contracts`);
                const result = await response.json();
                
                const tbody = document.getElementById('contractsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(contract => {
                        const rentObject = contract.building ? 
                            `${contract.building}${contract.unit}${contract.room}` : 
                            contract.space_number;
                        
                        return `
                            <tr>
                                <td>${contract.contract_number}</td>
                                <td>${rentObject}</td>
                                <td>${contract.tenant_name}</td>
                                <td>Â¥${contract.monthly_rent}/æœˆ</td>
                                <td>Â¥${contract.deposit || 0}</td>
                                <td>${contract.start_date}</td>
                                <td>${contract.end_date}</td>
                                <td>${contract.status}</td>
                                <td>
                                    <button onclick="editContract(${contract.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">ç¼–è¾‘</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('åŠ è½½ç§ŸèµåˆåŒå¤±è´¥:', error);
            }
        }
        
        // ========== è£…ä¿®ç®¡ç† JavaScript ==========
        
        async function loadDecorationPermits() {
            try {
                const response = await fetch(`${API_BASE}/decoration`);
                const result = await response.json();
                
                const tbody = document.getElementById('decorationPermitsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(permit => `
                        <tr>
                            <td>${permit.permit_number || '-'}</td>
                            <td>${permit.building}${permit.unit}${permit.room}</td>
                            <td>${permit.owner_name}</td>
                            <td>${permit.start_date} è‡³ ${permit.end_date}</td>
                            <td>${permit.contact_person}<br>${permit.contact_phone}</td>
                            <td>Â¥${permit.deposit_amount || 0}</td>
                            <td>${permit.status}</td>
                            <td>
                                <button onclick="editDecoration(${permit.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">ç¼–è¾‘</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½è£…ä¿®è®¸å¯å¤±è´¥:', error);
            }
        }
        
        // ========== è½¦è¾†ç®¡ç† JavaScript ==========
        
        async function loadVehicleBindings() {
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/bindings`);
                const result = await response.json();
                
                const tbody = document.getElementById('vehicleBindingsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(binding => `
                        <tr>
                            <td>${binding.space_number}</td>
                            <td>${binding.license_plate}</td>
                            <td>${binding.car_model || '-'}</td>
                            <td>${binding.owner_name}</td>
                            <td>${binding.binding_type}</td>
                            <td>${binding.start_date}</td>
                            <td>${binding.status}</td>
                            <td>
                                <button onclick="removeBinding(${binding.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">è§£é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½è½¦è¾†ç»‘å®šå¤±è´¥:', error);
            }
        }
        
        async function loadViolations() {
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/violations`);
                const result = await response.json();
                
                const tbody = document.getElementById('violationsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(violation => `
                        <tr>
                            <td>${violation.license_plate}</td>
                            <td>${violation.violation_type}</td>
                            <td>${violation.violation_date}</td>
                            <td>${violation.location || '-'}</td>
                            <td>Â¥${violation.fine_amount}</td>
                            <td>${violation.status}</td>
                            <td>
                                <button onclick="viewViolationPhotos('${violation.license_plate}', '${violation.photos || ''}')" class="btn" style="padding: 5px 10px; font-size: 12px;">æŸ¥çœ‹ç…§ç‰‡</button>
                                <button onclick="updateViolation(${violation.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">å¤„ç†</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½è¿ç« è®°å½•å¤±è´¥:', error);
            }
        }
        
        async function loadViolationStats() {
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/violations/stats`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('pendingViolations').textContent = result.data.pending_violations;
                    document.getElementById('totalFines').textContent = `Â¥${result.data.total_fines}`;
                }
            } catch (error) {
                console.error('åŠ è½½è¿ç« ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // ========== æ—¥æŠ¥ç®¡ç† JavaScript ==========
        
        function setDefaultReportDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('dashboardEndDate').value = today;
        }
        
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            
            try {
                let url = `${API_BASE}/reports/${reportType}`;
                if (reportDate) {
                    if (reportType === 'daily') {
                        url += `?date=${reportDate}`;
                    } else if (reportType === 'monthly') {
                        const [year, month] = reportDate.split('-');
                        url += `?year=${year}&month=${month}`;
                    } else if (reportType === 'quarterly') {
                        const quarter = Math.ceil(new Date(reportDate).getMonth() / 3);
                        url += `?year=${reportDate.split('-')[0]}&quarter=${quarter}`;
                    }
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayReportResults(result.data, reportType);
                } else {
                    alert('æŠ¥è¡¨ç”Ÿæˆå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æŠ¥è¡¨ç”Ÿæˆå¤±è´¥');
                console.error(error);
            }
        }
        
        function displayReportResults(data, reportType) {
            const resultsDiv = document.getElementById('reportResults');
            let html = '';
            
            if (reportType === 'daily') {
                html = `
                    <h3>ğŸ“Š ${data.report_date} æ—¥æŠ¥è¡¨</h3>
                    <div class="stats" style="margin: 20px 0;">
                        <div class="stat-card stat-green">
                            <h3>Â¥${data.summary.total_amount}</h3>
                            <p>æ€»æ”¶å…¥</p>
                        </div>
                        <div class="stat-card stat-blue">
                            <h3>${data.summary.total_transactions}</h3>
                            <p>äº¤æ˜“ç¬”æ•°</p>
                        </div>
                    </div>
                `;
                
                if (data.daily_income.length > 0) {
                    html += '<h4>ğŸ’° æ¯æ—¥æ”¶å…¥æ˜ç»†</h4><table class="table"><thead><tr><th>æ”¶è´¹ç±»å‹</th><th>æˆ¿äº§</th><th>é‡‘é¢</th><th>è¯´æ˜</th></tr></thead><tbody>';
                    data.daily_income.forEach(income => {
                        html += `<tr><td>${income.income_type}</td><td>${income.building || ''}${income.unit || ''}${income.room || ''}</td><td>Â¥${income.amount}</td><td>${income.description || '-'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        async function loadOutstandingFees() {
            try {
                const response = await fetch(`${API_BASE}/reports/outstanding/all`);
                const result = await response.json();
                
                const tbody = document.getElementById('outstandingFeesBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(outstanding => `
                        <tr>
                            <td>${outstanding.owner_name}</td>
                            <td>${outstanding.owner_phone || '-'}</td>
                            <td>${outstanding.properties || '-'}</td>
                            <td>${outstanding.parking_spaces || '-'}</td>
                            <td>${outstanding.outstanding_count}</td>
                            <td>Â¥${outstanding.total_outstanding}</td>
                            <td>
                                <button onclick="viewOwnerDetails(${outstanding.owner_id})" class="btn" style="padding: 5px 10px; font-size: 12px;">æŸ¥çœ‹è¯¦æƒ…</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½æ¬ è´¹ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        async function searchOutstanding() {
            const searchType = document.getElementById('searchType').value;
            const searchValue = document.getElementById('searchValue').value;
            const endDate = document.getElementById('dashboardEndDate').value;
            
            if (!searchValue) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }
            
            try {
                const url = `${API_BASE}/reports/dashboard?search_type=${searchType}&search_value=${encodeURIComponent(searchValue)}&end_date=${endDate}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayDashboardResults(result.data);
                } else {
                    alert('æŸ¥è¯¢å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥');
                console.error(error);
            }
        }
        
        function displayDashboardResults(data) {
            const resultsDiv = document.getElementById('dashboardResults');
            let html = `
                <h3>ğŸ” æ¬ è´¹æŸ¥è¯¢ç»“æœ</h3>
                <p>æŸ¥è¯¢æ¡ä»¶: ${data.search_criteria.search_type === 'owner' ? 'ä¸šä¸»åç§°' : 'é—¨ç‰Œå·'} = ${data.search_criteria.search_value}</p>
                <p>æˆªæ­¢æ—¥æœŸ: ${data.search_criteria.end_date}</p>
                <div class="stats" style="margin: 20px 0;">
                    <div class="stat-card stat-red">
                        <h3>${data.summary.total_count}</h3>
                        <p>æ¬ è´¹ç¬”æ•°</p>
                    </div>
                    <div class="stat-card stat-red">
                        <h3>Â¥${data.summary.total_amount}</h3>
                        <p>æ¬ è´¹æ€»é¢</p>
                    </div>
                </div>
            `;
            
            if (data.records.length > 0) {
                html += '<table class="table"><thead><tr><th>ä¸šä¸»</th><th>æˆ¿äº§/è½¦ä½</th><th>è´¹ç”¨ç±»å‹</th><th>é‡‘é¢</th><th>åˆ°æœŸæ—¥æœŸ</th></tr></thead><tbody>';
                data.records.forEach(record => {
                    html += `<tr><td>${record.owner_name}</td><td>${record.location}</td><td>${record.fee_item_name}</td><td>Â¥${record.amount}</td><td>${record.due_date}</td></tr>`;
                });
                html += '</tbody></table>';
            } else {
                html += '<p>æš‚æ— æ¬ è´¹è®°å½•</p>';
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // ========== å ä½å‡½æ•° ==========
        
        async function editRentalProperty(id) { 
            const newPrice = prompt('è¯·è¾“å…¥æ–°çš„ç§Ÿé‡‘(å…ƒ/æœˆ):');
            if (newPrice === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/properties/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rental_price: parseFloat(newPrice) })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('ç§Ÿé‡‘æ›´æ–°æˆåŠŸï¼');
                    loadRentalProperties();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }
        
        async function editRentalParking(id) { 
            const newPrice = prompt('è¯·è¾“å…¥æ–°çš„ç§Ÿé‡‘(å…ƒ/æœˆ):');
            if (newPrice === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/parking/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rental_price: parseFloat(newPrice) })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('ç§Ÿé‡‘æ›´æ–°æˆåŠŸï¼');
                    loadRentalParkingSpaces();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }
        // ========== ç§Ÿèµç®¡ç† JavaScript ==========
        
        // æ˜¾ç¤º/éšè—åˆåŒè¡¨å•
        function toggleContractForm() {
            const form = document.getElementById('contractForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // ç”ŸæˆåˆåŒç¼–å·
                document.getElementById('contractNumber').value = 'CONTRACT-' + Date.now();
                // è®¾ç½®å½“å‰æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('contractStart').value = today;
                // åŠ è½½ç§Ÿå®¢åˆ—è¡¨
                loadTenantOptions();
            }
        }
        
        function cancelContractForm() {
            document.getElementById('contractForm').style.display = 'none';
            document.querySelector('#contractForm form').reset();
        }
        
        // æ›´æ–°ç§Ÿèµå¯¹è±¡é€‰é¡¹
        async function updateRentalOptions() {
            const rentalType = document.getElementById('rentalType').value;
            const select = document.getElementById('rentalObject');
            const label = document.getElementById('rentalObjectLabel');
            
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            if (rentalType === 'property') {
                label.textContent = 'ç§Ÿèµæˆ¿äº§:';
                try {
                    const response = await fetch(`${API_BASE}/properties`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿äº§</option>';
                        result.data.forEach(property => {
                            select.innerHTML += `<option value="${property.id}">${property.community_name} - ${property.building}${property.unit}${property.room_number}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            } else if (rentalType === 'parking') {
                label.textContent = 'ç§Ÿèµè½¦ä½:';
                try {
                    const response = await fetch(`${API_BASE}/parking`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©è½¦ä½</option>';
                        result.data.forEach(parking => {
                            select.innerHTML += `<option value="${parking.id}">${parking.community_name} - ${parking.space_number}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            }
        }
        
        // åŠ è½½ç§Ÿå®¢é€‰é¡¹
        async function loadTenantOptions() {
            try {
                const response = await fetch(`${API_BASE}/tenants`);
                const result = await response.json();
                const select = document.getElementById('tenantSelect');
                
                if (result.success) {
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©ç§Ÿå®¢</option>';
                    result.data.forEach(tenant => {
                        select.innerHTML += `<option value="${tenant.id}">${tenant.name} - ${tenant.phone}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">æ— ç§Ÿå®¢æ•°æ®</option>';
                }
            } catch (error) {
                document.getElementById('tenantSelect').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }
        
        // åˆ›å»ºåˆåŒ
        async function createContract(event) {
            event.preventDefault();
            
            const contractData = {
                contract_number: document.getElementById('contractNumber').value,
                rental_type: document.getElementById('rentalType').value,
                object_id: parseInt(document.getElementById('rentalObject').value),
                tenant_id: parseInt(document.getElementById('tenantSelect').value),
                monthly_rent: parseFloat(document.getElementById('monthlyRent').value),
                deposit_amount: parseFloat(document.getElementById('depositAmount').value),
                start_date: document.getElementById('contractStart').value,
                end_date: document.getElementById('contractEnd').value,
                payment_cycle: document.getElementById('paymentCycle').value,
                status: document.getElementById('contractStatus').value,
                remarks: document.getElementById('contractRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/rental/contracts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contractData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('åˆåŒåˆ›å»ºæˆåŠŸï¼');
                    cancelContractForm();
                    loadRentalContracts();
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
        
        function editContract(id) { 
            alert('åˆåŒç¼–è¾‘åŠŸèƒ½ï¼š\nç°åœ¨å¯ä»¥ä½¿ç”¨ä¸Šæ–¹çš„è¡¨å•åˆ›å»ºæ–°åˆåŒ\nåˆåŒID: ' + id); 
        }
        
        // ========== è£…ä¿®ç®¡ç† JavaScript ==========
        
        // æ˜¾ç¤º/éšè—è£…ä¿®è¡¨å•
        function toggleDecorationForm() {
            const form = document.getElementById('decorationForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // ç”Ÿæˆè®¸å¯è¯ç¼–å·
                document.getElementById('permitNumber').value = 'PERMIT-' + Date.now();
                // è®¾ç½®å½“å‰æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('decorationStart').value = today;
                // åŠ è½½æˆ¿äº§é€‰é¡¹
                loadDecorationPropertyOptions();
            }
        }
        
        function cancelDecorationForm() {
            document.getElementById('decorationForm').style.display = 'none';
            document.querySelector('#decorationForm form').reset();
        }
        
        // åŠ è½½æˆ¿äº§é€‰é¡¹
        async function loadDecorationPropertyOptions() {
            try {
                const response = await fetch(`${API_BASE}/properties`);
                const result = await response.json();
                const select = document.getElementById('decorationProperty');
                
                if (result.success) {
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿äº§</option>';
                    result.data.forEach(property => {
                        select.innerHTML += `<option value="${property.id}">${property.community_name} - ${property.building}${property.unit}${property.room_number} (ä¸šä¸»: ${property.owner_name || 'æœªçŸ¥'})</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">æ— æˆ¿äº§æ•°æ®</option>';
                }
            } catch (error) {
                document.getElementById('decorationProperty').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }
        
        // åˆ›å»ºè£…ä¿®è®¸å¯
        async function createDecorationPermit(event) {
            event.preventDefault();
            
            const decorationData = {
                permit_number: document.getElementById('permitNumber').value,
                property_id: parseInt(document.getElementById('decorationProperty').value),
                decoration_type: document.getElementById('decorationType').value,
                contractor_name: document.getElementById('contractorName').value,
                contact_person: document.getElementById('contactPerson').value,
                contact_phone: document.getElementById('contactPhone').value,
                start_date: document.getElementById('decorationStart').value,
                expected_end_date: document.getElementById('decorationEnd').value,
                deposit_amount: parseFloat(document.getElementById('decorationDeposit').value),
                cleaning_fee: parseFloat(document.getElementById('cleaningFee').value) || 0,
                fire_safety_fee: parseFloat(document.getElementById('fireSafetyFee').value) || 0,
                other_fees: parseFloat(document.getElementById('otherFees').value) || 0,
                status: document.getElementById('decorationStatus').value,
                remarks: document.getElementById('decorationRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/decoration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(decorationData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('è£…ä¿®è®¸å¯åˆ›å»ºæˆåŠŸï¼');
                    cancelDecorationForm();
                    loadDecorationPermits();
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
        
        function editDecoration(id) { 
            alert('è£…ä¿®ç®¡ç†ç¼–è¾‘åŠŸèƒ½ï¼š\nç°åœ¨å¯ä»¥ä½¿ç”¨ä¸Šæ–¹çš„è¡¨å•åˆ›å»ºæ–°è®¸å¯\nè®¸å¯ID: ' + id); 
        }
        // ========== è½¦è¾†ç®¡ç† JavaScript ==========
        
        // æ˜¾ç¤º/éšè—è½¦è¾†ç»‘å®šè¡¨å•
        function toggleVehicleBindingForm() {
            const form = document.getElementById('vehicleBindingForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // è®¾ç½®å½“å‰æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('bindingStartDate').value = today;
                // åŠ è½½è½¦ä½é€‰é¡¹
                loadParkingSpaceOptions();
            }
        }
        
        function cancelVehicleBindingForm() {
            document.getElementById('vehicleBindingForm').style.display = 'none';
            document.querySelector('#vehicleBindingForm form').reset();
        }
        
        // åŠ è½½è½¦ä½é€‰é¡¹
        async function loadParkingSpaceOptions() {
            try {
                const response = await fetch(`${API_BASE}/parking`);
                const result = await response.json();
                const select = document.getElementById('bindingParkingSpace');
                
                if (result.success) {
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©è½¦ä½</option>';
                    result.data.forEach(parking => {
                        const statusText = parking.status === 'è‡ªç”¨' ? '(å¯ç»‘å®š)' : `(${parking.status})`;
                        select.innerHTML += `<option value="${parking.id}">${parking.community_name} - ${parking.space_number} ${statusText}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">æ— è½¦ä½æ•°æ®</option>';
                }
            } catch (error) {
                document.getElementById('bindingParkingSpace').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }
        
        // æ›´æ–°è½¦ä¸»é€‰é¡¹
        async function updateOwnerOptions() {
            const ownerType = document.getElementById('ownerType').value;
            const select = document.getElementById('vehicleOwner');
            
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            if (ownerType === 'ä¸šä¸»') {
                try {
                    const response = await fetch(`${API_BASE}/owners`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸šä¸»</option>';
                        result.data.forEach(owner => {
                            select.innerHTML += `<option value="${owner.id}">${owner.name} - ${owner.phone}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            } else if (ownerType === 'ç§Ÿå®¢') {
                try {
                    const response = await fetch(`${API_BASE}/tenants`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©ç§Ÿå®¢</option>';
                        result.data.forEach(tenant => {
                            select.innerHTML += `<option value="${tenant.id}">${tenant.name} - ${tenant.phone}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            }
        }
        
        // åˆ›å»ºè½¦è¾†ç»‘å®š
        async function createVehicleBinding(event) {
            event.preventDefault();
            
            const bindingData = {
                parking_space_id: parseInt(document.getElementById('bindingParkingSpace').value),
                license_plate: document.getElementById('vehicleLicensePlate').value.toUpperCase(),
                car_model: document.getElementById('vehicleModel').value,
                color: document.getElementById('vehicleColor').value,
                owner_type: document.getElementById('ownerType').value,
                owner_id: parseInt(document.getElementById('vehicleOwner').value),
                binding_type: document.getElementById('bindingType').value,
                status: document.getElementById('bindingStatus').value,
                start_date: document.getElementById('bindingStartDate').value,
                end_date: document.getElementById('bindingEndDate').value || null,
                remarks: document.getElementById('vehicleRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/bindings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bindingData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('è½¦è¾†ç»‘å®šæˆåŠŸï¼');
                    cancelVehicleBindingForm();
                    loadVehicleBindings();
                } else {
                    alert('ç»‘å®šå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('ç»‘å®šå¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤º/éšè—è¿ç« è¡¨å•
        function toggleViolationForm() {
            const form = document.getElementById('violationForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // ç”Ÿæˆè¿ç« ç¼–å·
                document.getElementById('violationNumber').value = 'VIO-' + Date.now();
                // è®¾ç½®å½“å‰æ—¶é—´
                const now = new Date();
                const localTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('violationTime').value = localTime;
            }
        }
        
        function cancelViolationForm() {
            document.getElementById('violationForm').style.display = 'none';
            document.querySelector('#violationForm form').reset();
        }
        
        // åˆ›å»ºè¿ç« è®°å½•
        async function createViolation(event) {
            event.preventDefault();
            
            const violationData = {
                violation_number: document.getElementById('violationNumber').value,
                license_plate: document.getElementById('violationLicensePlate').value.toUpperCase(),
                violation_type: document.getElementById('violationType').value,
                location: document.getElementById('violationLocation').value,
                violation_time: document.getElementById('violationTime').value,
                fine_amount: parseFloat(document.getElementById('fineAmount').value),
                reporter: document.getElementById('violationReporter').value,
                status: document.getElementById('violationStatus').value,
                remarks: document.getElementById('violationRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/violations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(violationData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('è¿ç« è®°å½•åˆ›å»ºæˆåŠŸï¼');
                    cancelViolationForm();
                    loadViolations();
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
        
        function removeBinding(id) { 
            if (confirm('ç¡®å®šè¦è§£é™¤æ­¤è½¦è¾†ç»‘å®šå—ï¼Ÿ')) {
                alert('è½¦è¾†ç»‘å®šè§£é™¤åŠŸèƒ½ï¼š\nç°åœ¨å¯ä»¥ä½¿ç”¨ä¸Šæ–¹çš„è¡¨å•åˆ›å»ºæ–°ç»‘å®š\nç»‘å®šID: ' + id);
            }
        }
        
        // æ­¤å‡½æ•°å·²è¢«æ›¿æ¢ä¸ºä¸Šæ–¹çš„ toggleViolationForm() å’Œ createViolation()
        // è¯·ä½¿ç”¨æ–°çš„è¡¨å•ç•Œé¢åˆ›å»ºè¿ç« è®°å½•
        
        function updateViolation(id) { 
            if (confirm('ç¡®å®šè¦å¤„ç†æ­¤è¿ç« è®°å½•å—ï¼Ÿ')) {
                alert('è¿ç« å¤„ç†åŠŸèƒ½ï¼š\nè¿ç« ID: ' + id + '\nå¯å°†çŠ¶æ€æ”¹ä¸ºpaidæˆ–appealed');
            }
        }
        function viewOwnerDetails(id) { alert('æŸ¥çœ‹ä¸šä¸»è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...'); }

        // æŸ¥çœ‹æˆ¿äº§ç…§ç‰‡
        function viewPropertyPhotos(propertyName, photos) {
            const container = document.getElementById('propertyPhotosContainer');
            
            if (!photos || photos.trim() === '') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“·</div>
                        <h3>${propertyName}</h3>
                        <p>æš‚æ— æˆ¿äº§ç…§ç‰‡</p>
                    </div>
                `;
            } else {
                const photoUrls = photos.split(',').filter(url => url.trim());
                let html = `<h3 style="margin-bottom: 20px;">${propertyName} - æˆ¿äº§ç…§ç‰‡</h3>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                
                photoUrls.forEach((photo, index) => {
                    const photoUrl = photo.trim().startsWith('/') ? `${API_BASE.replace('/api', '')}${photo.trim()}` : photo.trim();
                    html += `
                        <div style="text-align: center;">
                            <img src="${photoUrl}" alt="æˆ¿äº§ç…§ç‰‡${index + 1}" 
                                 style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;"
                                 onclick="window.open('${photoUrl}', '_blank')">
                            <p style="margin-top: 5px; font-size: 12px; color: #666;">ç…§ç‰‡ ${index + 1}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            document.getElementById('propertyPhotosModal').style.display = 'block';
        }
        
        // å…³é—­æˆ¿äº§ç…§ç‰‡æ¨¡æ€æ¡†
        function closePropertyPhotosModal() {
            document.getElementById('propertyPhotosModal').style.display = 'none';
        }

        // æŸ¥çœ‹è¿ç« ç…§ç‰‡
        function viewViolationPhotos(licensePlate, photos) {
            const container = document.getElementById('violationPhotosContainer');
            
            if (!photos || photos.trim() === '') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“·</div>
                        <h3>${licensePlate}</h3>
                        <p>æš‚æ— è¿ç« ç…§ç‰‡</p>
                        <div style="margin-top: 20px;">
                            <input type="file" id="violationPhotoInput" accept="image/*" multiple style="margin-right: 10px;">
                            <button onclick="uploadViolationPhotos('${licensePlate}')" class="btn btn-success">ğŸ“¤ ä¸Šä¼ è¿ç« ç…§ç‰‡</button>
                        </div>
                    </div>
                `;
            } else {
                const photoUrls = photos.split(',').filter(url => url.trim());
                let html = `<h3 style="margin-bottom: 20px;">${licensePlate} - è¿ç« ç…§ç‰‡</h3>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
                
                photoUrls.forEach((photo, index) => {
                    const photoUrl = photo.trim().startsWith('/') ? `${API_BASE.replace('/api', '')}${photo.trim()}` : photo.trim();
                    html += `
                        <div style="text-align: center;">
                            <img src="${photoUrl}" alt="è¿ç« ç…§ç‰‡${index + 1}" 
                                 style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;"
                                 onclick="window.open('${photoUrl}', '_blank')">
                            <p style="margin-top: 5px; font-size: 12px; color: #666;">è¿ç« ç…§ç‰‡ ${index + 1}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `
                    <div style="text-align: center; padding: 20px; border-top: 1px solid #ddd;">
                        <input type="file" id="violationPhotoInput" accept="image/*" multiple style="margin-right: 10px;">
                        <button onclick="uploadViolationPhotos('${licensePlate}')" class="btn btn-success">ğŸ“¤ æ·»åŠ æ›´å¤šç…§ç‰‡</button>
                    </div>
                `;
                container.innerHTML = html;
            }
            
            document.getElementById('violationPhotosModal').style.display = 'block';
        }
        
        // å…³é—­è¿ç« ç…§ç‰‡æ¨¡æ€æ¡†
        function closeViolationPhotosModal() {
            document.getElementById('violationPhotosModal').style.display = 'none';
        }
        
        // ä¸Šä¼ è¿ç« ç…§ç‰‡(å ä½å‡½æ•°)
        function uploadViolationPhotos(licensePlate) {
            const fileInput = document.getElementById('violationPhotoInput');
            if (!fileInput.files.length) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ç…§ç‰‡');
                return;
            }
            alert('è¿ç« ç…§ç‰‡ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­...\nè½¦ç‰Œå·: ' + licensePlate + '\né€‰æ‹©äº† ' + fileInput.files.length + ' å¼ ç…§ç‰‡');
        }

        // ========== æ•°æ®å¯¼å…¥ JavaScript ==========
        
        // ä¸‹è½½å¯¼å…¥æ¨¡æ¿
        function downloadTemplate(type) {
            const url = `${API_BASE}/import/template/${type}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = true;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // å¯¼å…¥æ•°æ®
        async function importData(type) {
            const fileInput = document.getElementById(type + 'File');
            const resultDiv = document.getElementById(type + 'Result');
            
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„Excelæ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶(.xlsxæˆ–.xls)');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                resultDiv.innerHTML = '<div style="color: #007bff;">ğŸ“¤ æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·ç¨å€™...</div>';
                
                const response = await fetch(`${API_BASE}/import/${type}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let html = `<div style="color: #28a745; margin: 10px 0;">
                        âœ… ${result.message}
                        <br>æ€»è®¡: ${result.data.total} æ¡ï¼ŒæˆåŠŸ: ${result.data.successCount} æ¡ï¼Œå¤±è´¥: ${result.data.errorCount} æ¡
                    </div>`;
                    
                    if (result.data.errors && result.data.errors.length > 0) {
                        html += '<div style="color: #dc3545; margin: 10px 0;"><strong>é”™è¯¯è¯¦æƒ…:</strong><ul>';
                        result.data.errors.forEach(error => {
                            html += `<li>${error}</li>`;
                        });
                        html += '</ul></div>';
                    }
                    
                    resultDiv.innerHTML = html;
                    
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    fileInput.value = '';
                    
                    // åˆ·æ–°ç›¸å…³é¡µé¢æ•°æ®
                    if (type === 'owners') {
                        loadOwners();
                        loadDashboard();
                    } else if (type === 'properties') {
                        loadProperties();
                        loadDashboard();
                    } else if (type === 'parking') {
                        loadParkingSpaces();
                        loadDashboard();
                    }
                    
                } else {
                    resultDiv.innerHTML = `<div style="color: #dc3545;">âŒ å¯¼å…¥å¤±è´¥: ${result.message}</div>`;
                }
                
            } catch (error) {
                console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                resultDiv.innerHTML = `<div style="color: #dc3545;">âŒ å¯¼å…¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadDashboard();
        });
    </script>
</body>
</html>