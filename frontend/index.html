<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物业管理系统</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        
        /* 导航栏 */
        .navbar { background: #2c3e50; color: white; padding: 1rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .nav-title { font-size: 1.5rem; font-weight: bold; }
        .nav-menu { display: flex; gap: 20px; }
        .nav-item { padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: #3498db; }
        
        /* 主容器 */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        
        /* 卡片样式 */
        .card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card h2 { color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        
        /* 表单样式 */
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3498db; }
        
        /* 按钮样式 */
        .btn { background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin: 5px; }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }
        
        /* 表格样式 */
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .table th { background: #f8f9fa; font-weight: 600; color: #2c3e50; }
        .table tr:hover { background: #f8f9fa; }
        
        /* 统计卡片 */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { color: white; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-card h3 { font-size: 2rem; margin-bottom: 10px; }
        .stat-card p { opacity: 0.9; }
        .stat-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-green { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .stat-red { background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%); }
        
        /* 模态框样式 */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .modal-header { background: #2c3e50; color: white; padding: 20px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: white; }
        .modal-body { padding: 30px; }
        .modal-actions { margin-top: 30px; text-align: right; }
        
        /* 照片区域样式 */
        .photo-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
        .photo-section h3 { margin-bottom: 15px; color: #2c3e50; }
        .photo-container { display: flex; justify-content: center; margin-bottom: 20px; }
        #ownerPhotoPreview { max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #ddd; }
        .no-photo-placeholder { width: 200px; height: 200px; border: 2px dashed #ccc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; background: white; }
        .no-photo-placeholder span { font-size: 48px; margin-bottom: 10px; }
        .photo-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* 房产照片画廊样式 */
        .photos-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; min-height: 140px; border: 2px dashed #ddd; border-radius: 8px; padding: 15px; background: white; }
        .photo-item { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .photo-item img { width: 100%; height: 120px; object-fit: cover; }
        .photo-item .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; }
        .photo-item .delete-btn:hover { background: #e74c3c; }
        .photos-gallery.empty::before { content: "📷 暂无照片，点击下方按钮添加"; display: flex; align-items: center; justify-content: center; color: #999; font-size: 16px; min-height: 100px; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-title">🏠 物业管理系统</div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="showPage('dashboard')">仪表盘</div>
                <div class="nav-item" onclick="showPage('owners')">业主管理</div>
                <div class="nav-item" onclick="showPage('communities')">小区管理</div>
                <div class="nav-item" onclick="showPage('properties')">房产管理</div>
                <div class="nav-item" onclick="showPage('parking')">车位管理</div>
                <div class="nav-item" onclick="showPage('fees')">收费管理</div>
                <div class="nav-item" onclick="showPage('advanced-fees')">高级收费</div>
                <div class="nav-item" onclick="showPage('rental')">租赁管理</div>
                <div class="nav-item" onclick="showPage('decoration')">装修管理</div>
                <div class="nav-item" onclick="showPage('vehicles')">车辆管理</div>
                <div class="nav-item" onclick="showPage('reports')">日报管理</div>
                <div class="nav-item" onclick="showPage('import')">数据导入</div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 仪表盘页面 -->
        <div id="dashboard" class="page active">
            <div class="stats">
                <div class="stat-card stat-blue">
                    <h3 id="ownerCount">0</h3>
                    <p>业主总数</p>
                </div>
                <div class="stat-card stat-blue">
                    <h3 id="propertyCount">0</h3>
                    <p>房产总数</p>
                </div>
                <div class="stat-card stat-blue">
                    <h3 id="parkingCount">0</h3>
                    <p>车位总数</p>
                </div>
                <div class="stat-card stat-red">
                    <h3 id="feeTotal">¥0</h3>
                    <p>未收费用</p>
                </div>
            </div>
            <div class="card">
                <h2>📊 系统概览</h2>
                <p>欢迎使用物业管理系统！这里是系统的主要统计信息。</p>
            </div>
        </div>

        <!-- 业主管理页面 -->
        <div id="owners" class="page">
            <div class="card">
                <h2>👤 添加业主</h2>
                <form id="ownerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>姓名: <span style="color:red">*</span></label>
                            <input type="text" id="ownerName" required>
                        </div>
                        <div class="form-group">
                            <label>电话号码:</label>
                            <input type="tel" id="ownerPhone" placeholder="可选，但不能重复">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>身份证号:</label>
                            <input type="text" id="ownerIdCard" placeholder="可选，但不能重复">
                        </div>
                        <div class="form-group">
                            <label>工作单位:</label>
                            <input type="text" id="ownerCompany">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>职务:</label>
                            <input type="text" id="ownerPosition">
                        </div>
                        <div class="form-group">
                            <label>爱好:</label>
                            <input type="text" id="ownerHobby" placeholder="多个爱好用逗号分隔">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>备注:</label>
                            <input type="text" id="ownerRemark">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">添加业主</button>
                </form>
            </div>
            
            <div class="card">
                <h2>👥 业主列表</h2>
                <div style="margin-bottom: 20px;">
                    <button onclick="loadOwners()" class="btn btn-secondary">刷新列表</button>
                    <input type="text" id="ownerSearchInput" placeholder="搜索业主姓名或电话" style="margin-left: 10px; padding: 8px;">
                    <button onclick="searchOwners()" class="btn">搜索</button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>照片</th>
                            <th>姓名</th>
                            <th>电话</th>
                            <th>身份证号</th>
                            <th>工作单位</th>
                            <th>职务</th>
                            <th>房产数</th>
                            <th>车位数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="ownerTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 业主编辑模态框 -->
        <div id="ownerEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>✏️ 编辑业主信息</h2>
                    <span class="close" onclick="closeOwnerEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- 照片区域 -->
                    <div class="photo-section">
                        <h3>业主照片</h3>
                        <div class="photo-container">
                            <img id="ownerPhotoPreview" src="" alt="业主照片" style="display: none;">
                            <div id="noPhotoPlaceholder" class="no-photo-placeholder">
                                <span>📷</span>
                                <p>暂无照片</p>
                            </div>
                        </div>
                        <div class="photo-actions">
                            <label for="ownerPhotoInput" class="btn btn-secondary">
                                📸 选择照片
                                <input type="file" id="ownerPhotoInput" accept="image/*" style="display: none;">
                            </label>
                            <button type="button" id="uploadPhotoBtn" class="btn" style="display: none;">上传照片</button>
                            <button type="button" id="deletePhotoBtn" class="btn btn-danger" style="display: none;">删除照片</button>
                        </div>
                    </div>

                    <!-- 信息编辑表单 -->
                    <form id="ownerEditForm">
                        <input type="hidden" id="editOwnerId">
                        <div class="form-row">
                            <div class="form-group">
                                <label>姓名: <span style="color:red">*</span></label>
                                <input type="text" id="editOwnerName" required>
                            </div>
                            <div class="form-group">
                                <label>电话号码:</label>
                                <input type="tel" id="editOwnerPhone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>身份证号:</label>
                                <input type="text" id="editOwnerIdCard">
                            </div>
                            <div class="form-group">
                                <label>工作单位:</label>
                                <input type="text" id="editOwnerCompany">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>职务:</label>
                                <input type="text" id="editOwnerPosition">
                            </div>
                            <div class="form-group">
                                <label>爱好:</label>
                                <input type="text" id="editOwnerHobby" placeholder="多个爱好用逗号分隔">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>备注:</label>
                                <input type="text" id="editOwnerRemark">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-success">保存修改</button>
                            <button type="button" class="btn btn-secondary" onclick="closeOwnerEditModal()">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 小区管理页面 -->
        <div id="communities" class="page">
            <div class="card">
                <h2>🏘️ 添加小区</h2>
                <form id="communityForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>小区名称: <span style="color:red">*</span></label>
                            <input type="text" id="communityName" required>
                        </div>
                        <div class="form-group">
                            <label>小区地址:</label>
                            <input type="text" id="communityAddress">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>小区描述:</label>
                            <input type="text" id="communityDescription" placeholder="如: 高档住宅小区">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">添加小区</button>
                </form>
            </div>
            
            <div class="card">
                <h2>🏘️ 小区列表</h2>
                <button onclick="loadCommunities()" class="btn btn-secondary">刷新列表</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>小区名称</th>
                            <th>地址</th>
                            <th>描述</th>
                            <th>房产数</th>
                            <th>车位数</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="communityTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 小区编辑模态框 -->
        <div id="communityEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📝 编辑小区信息</h3>
                    <span class="close" onclick="closeCommunityEditModal()">&times;</span>
                </div>
                <form id="communityEditForm">
                    <input type="hidden" id="editCommunityId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>小区名称: <span style="color:red">*</span></label>
                            <input type="text" id="editCommunityName" required>
                        </div>
                        <div class="form-group">
                            <label>小区地址:</label>
                            <input type="text" id="editCommunityAddress">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>小区描述:</label>
                            <input type="text" id="editCommunityDescription" placeholder="如: 高档住宅小区">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeCommunityEditModal()">取消</button>
                        <button type="submit" class="btn btn-success">保存修改</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 房产管理页面 -->
        <div id="properties" class="page">
            <div class="card">
                <h2>🏢 添加房产</h2>
                <form id="propertyForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>所属小区: <span style="color:red">*</span></label>
                            <select id="propertyCommunity" required>
                                <option value="">请选择小区</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>房产性质:</label>
                            <select id="propertyType">
                                <option value="普通住宅">普通住宅</option>
                                <option value="公寓">公寓</option>
                                <option value="商铺">商铺</option>
                                <option value="上叠">上叠</option>
                                <option value="下叠">下叠</option>
                                <option value="别墅">别墅</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>楼栋: <span style="color:red">*</span></label>
                            <input type="text" id="propertyBuilding" placeholder="如: A栋" required>
                        </div>
                        <div class="form-group">
                            <label>单元: <span style="color:red">*</span></label>
                            <input type="text" id="propertyUnit" placeholder="如: 1单元" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>门牌号: <span style="color:red">*</span></label>
                            <input type="text" id="propertyRoom" placeholder="如: 101" required>
                        </div>
                        <div class="form-group">
                            <label>建筑面积(㎡): <span style="color:red">*</span></label>
                            <input type="number" id="propertyArea" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>是否已交房:</label>
                            <select id="propertyDelivered">
                                <option value="0">未交房</option>
                                <option value="1">已交房</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>是否装修:</label>
                            <select id="propertyDecorated">
                                <option value="0">未装修</option>
                                <option value="1">已装修</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>居住状态:</label>
                            <select id="propertyOccupancy">
                                <option value="空关">空关</option>
                                <option value="自住">自住</option>
                                <option value="出租">出租</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>是否租售:</label>
                            <select id="propertyForRent">
                                <option value="0">不租售</option>
                                <option value="1">可租售</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>交房日期:</label>
                            <input type="date" id="propertyHandoverDate">
                        </div>
                        <div class="form-group">
                            <label>业主:</label>
                            <select id="propertyOwner">
                                <option value="">请选择业主</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">添加房产</button>
                </form>
            </div>
            
            <div class="card">
                <h2>🏠 房产列表</h2>
                <button onclick="loadProperties()" class="btn btn-secondary">刷新列表</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>小区</th>
                            <th>房产性质</th>
                            <th>楼栋-单元-门牌号</th>
                            <th>面积(㎡)</th>
                            <th>交房状态</th>
                            <th>装修状态</th>
                            <th>居住状态</th>
                            <th>租售状态</th>
                            <th>业主</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="propertyTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 房产编辑模态框 -->
        <div id="propertyEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>🏢 编辑房产信息</h2>
                    <span class="close" onclick="closePropertyEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- 照片区域 -->
                    <div class="photo-section">
                        <h3>房产照片</h3>
                        <div class="photos-gallery" id="propertyPhotosGallery">
                            <!-- 照片将动态加载到这里 -->
                        </div>
                        <div class="photo-actions">
                            <label for="propertyPhotoInput" class="btn btn-secondary">
                                📸 添加照片
                                <input type="file" id="propertyPhotoInput" accept="image/*" style="display: none;">
                            </label>
                            <button type="button" id="uploadPropertyPhotoBtn" class="btn" style="display: none;">上传照片</button>
                        </div>
                    </div>

                    <!-- 信息编辑表单 -->
                    <form id="propertyEditForm">
                        <input type="hidden" id="editPropertyId">
                        <div class="form-row">
                            <div class="form-group">
                                <label>所属小区: <span style="color:red">*</span></label>
                                <select id="editPropertyCommunity" required>
                                    <option value="">请选择小区</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>房产性质:</label>
                                <select id="editPropertyType">
                                    <option value="普通住宅">普通住宅</option>
                                    <option value="公寓">公寓</option>
                                    <option value="商铺">商铺</option>
                                    <option value="上叠">上叠</option>
                                    <option value="下叠">下叠</option>
                                    <option value="别墅">别墅</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>楼栋: <span style="color:red">*</span></label>
                                <input type="text" id="editPropertyBuilding" required>
                            </div>
                            <div class="form-group">
                                <label>单元: <span style="color:red">*</span></label>
                                <input type="text" id="editPropertyUnit" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>门牌号: <span style="color:red">*</span></label>
                                <input type="text" id="editPropertyRoom" required>
                            </div>
                            <div class="form-group">
                                <label>建筑面积(㎡): <span style="color:red">*</span></label>
                                <input type="number" id="editPropertyArea" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>是否已交房:</label>
                                <select id="editPropertyDelivered">
                                    <option value="0">未交房</option>
                                    <option value="1">已交房</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>是否装修:</label>
                                <select id="editPropertyDecorated">
                                    <option value="0">未装修</option>
                                    <option value="1">已装修</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>居住状态:</label>
                                <select id="editPropertyOccupancy">
                                    <option value="空关">空关</option>
                                    <option value="自住">自住</option>
                                    <option value="出租">出租</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>是否租售:</label>
                                <select id="editPropertyForRent">
                                    <option value="0">不租售</option>
                                    <option value="1">可租售</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>交房日期:</label>
                                <input type="date" id="editPropertyHandoverDate">
                            </div>
                            <div class="form-group">
                                <label>业主:</label>
                                <select id="editPropertyOwner">
                                    <option value="">请选择业主</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-success">保存修改</button>
                            <button type="button" class="btn btn-secondary" onclick="closePropertyEditModal()">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 车位管理页面 -->
        <div id="parking" class="page">
            <div class="card">
                <h2>🅿️ 添加车位</h2>
                <form id="parkingForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>所属小区:</label>
                            <select id="parkingCommunity" required>
                                <option value="">请选择小区</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>车位编号:</label>
                            <input type="text" id="parkingNumber" placeholder="如: B1-001" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>车位类型:</label>
                            <select id="parkingType">
                                <option value="地下">地下</option>
                                <option value="地上">地上</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>车位状态:</label>
                            <select id="parkingStatus">
                                <option value="自用">自用</option>
                                <option value="待出租">待出租</option>
                                <option value="未交房">未交房</option>
                                <option value="出租中">出租中</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>车位业主:</label>
                            <select id="parkingOwner">
                                <option value="">请选择业主</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">添加车位</button>
                </form>
            </div>
            
            <div class="card">
                <h2>🅿️ 车位列表</h2>
                <button onclick="loadParkingSpaces()" class="btn btn-secondary">刷新列表</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>小区</th>
                            <th>车位编号</th>
                            <th>类型</th>
                            <th>状态</th>
                            <th>业主</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="parkingTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 车位编辑模态框 -->
        <div id="parkingEditModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>🅿️ 编辑车位信息</h2>
                    <span class="close" onclick="closeParkingEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="parkingEditForm">
                        <input type="hidden" id="editParkingId">
                        <div class="form-row">
                            <div class="form-group">
                                <label>所属小区: <span style="color:red">*</span></label>
                                <select id="editParkingCommunity" required>
                                    <option value="">请选择小区</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>车位编号: <span style="color:red">*</span></label>
                                <input type="text" id="editParkingNumber" placeholder="如: B1-001" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>车位类型:</label>
                                <select id="editParkingType">
                                    <option value="地下">地下</option>
                                    <option value="地上">地上</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>车位状态:</label>
                                <select id="editParkingStatus">
                                    <option value="自用">自用</option>
                                    <option value="待出租">待出租</option>
                                    <option value="未交房">未交房</option>
                                    <option value="出租中">出租中</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>车位业主:</label>
                                <select id="editParkingOwner">
                                    <option value="">请选择业主</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>位置描述:</label>
                                <input type="text" id="editParkingLocation" placeholder="如: 靠近电梯，方便停车">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>月租金(元):</label>
                                <input type="number" id="editParkingRent" step="0.01" placeholder="如: 200">
                            </div>
                            <div class="form-group">
                                <label>备注信息:</label>
                                <input type="text" id="editParkingRemark" placeholder="其他说明信息">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-success">保存修改</button>
                            <button type="button" class="btn btn-secondary" onclick="closeParkingEditModal()">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 收费管理页面 -->
        <div id="fees" class="page">
            <div class="card">
                <h2>💰 添加收费记录</h2>
                <form id="feeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>房产:</label>
                            <select id="feeProperty" required onchange="updateFeeAmount()">
                                <option value="">请选择房产</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>费用类型:</label>
                            <select id="feeType" required onchange="updateFeeAmount()">
                                <option value="">请选择费用类型</option>
                                <option value="物业费">物业费</option>
                                <option value="水费">水费</option>
                                <option value="电费">电费</option>
                                <option value="燃气费">燃气费</option>
                                <option value="停车费">停车费</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>金额(元):</label>
                            <input type="number" id="feeAmount" step="0.01" required>
                            <div id="feeAmountTip" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                        </div>
                        <div class="form-group">
                            <label>费用周期:</label>
                            <input type="text" id="feePeriod" placeholder="如: 2025-01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>到期日期:</label>
                            <input type="date" id="feeDueDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">添加收费记录</button>
                </form>
            </div>
            
            <!-- 收费项目管理 -->
            <div class="card">
                <h2>⚙️ 收费项目管理</h2>
                <form id="feeItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>项目名称: <span style="color:red">*</span></label>
                            <input type="text" id="feeItemName" placeholder="如: 物业管理费" required>
                        </div>
                        <div class="form-group">
                            <label>单价(元):</label>
                            <input type="number" id="feeItemPrice" step="0.01" placeholder="如: 2.5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>计费方式:</label>
                            <select id="feeItemMethod">
                                <option value="">请选择计费方式</option>
                                <option value="按面积">按面积</option>
                                <option value="按套">按套</option>
                                <option value="按月">按月</option>
                                <option value="按年">按年</option>
                                <option value="按次">按次</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>项目描述:</label>
                            <input type="text" id="feeItemDescription" placeholder="项目说明">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">添加收费项目</button>
                </form>
                
                <h3 style="margin-top: 30px;">📋 收费项目列表</h3>
                <button onclick="loadFeeItems()" class="btn btn-secondary">🔄 刷新列表</button>
                <button onclick="saveBatchFeeItems()" class="btn btn-success">💾 保存所有修改</button>
                <span id="feeItemBatchUpdateStatus" style="margin-left: 15px; color: #666; display: none;">✅ 已保存</span>
                <table class="table" style="margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>项目名称</th>
                            <th>单价(元)</th>
                            <th>计费方式</th>
                            <th>项目描述</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="feeItemTableBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>📋 收费记录列表</h2>
                <button onclick="loadFeeRecords()" class="btn btn-secondary">刷新列表</button>
                <button onclick="loadFeeStats()" class="btn">更新统计</button>
                
                <div class="stats" style="margin: 20px 0;">
                    <div class="stat-card stat-green">
                        <h3 id="paidAmount">¥0</h3>
                        <p>已收费用</p>
                    </div>
                    <div class="stat-card stat-red">
                        <h3 id="unpaidAmount">¥0</h3>
                        <p>未收费用</p>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr><th>房产</th><th>房产类型</th><th>业主</th><th>费用类型</th><th>金额</th><th>周期</th><th>到期日期</th><th>状态</th><th>操作</th></tr>
                    </thead>
                    <tbody id="feeTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 高级收费管理页面 -->
        <div id="advanced-fees" class="page">
            <!-- 收费标准管理 -->
            <div class="card">
                <h2>⚙️ 房产类型收费标准</h2>
                <p style="color: #666; margin-bottom: 20px;">不同房产类型的物业费单价设定，按面积计算费用</p>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>房产类型</th>
                            <th>物业费单价(元/㎡/月)</th>
                            <th>计费方式</th>
                        </tr>
                    </thead>
                    <tbody id="feeRatesTableBody">
                        <tr><td colspan="3">加载中...</td></tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                    <button onclick="saveBatchFeeRates()" class="btn btn-success">💾 保存所有修改</button>
                    <button onclick="loadPropertyFeeRates()" class="btn btn-secondary">🔄 刷新列表</button>
                    <button onclick="showAddPropertyTypeModal()" class="btn">📝 添加房产类型</button>
                    <span id="batchUpdateStatus" style="margin-left: 15px; color: #666; display: none;">✅ 已保存</span>
                </div>
            </div>
            
            <div class="card">
                <h2>🧮 物业费自动计算</h2>
                <form id="calculateFeesForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>业主:</label>
                            <select id="calcOwner">
                                <option value="">请选择业主</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>房产:</label>
                            <select id="calcProperty">
                                <option value="">请选择房产</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>开始日期:</label>
                            <input type="date" id="calcStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>结束日期:</label>
                            <input type="date" id="calcEndDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">计算费用</button>
                </form>
                
                <div id="calcResults" style="margin-top: 20px; display: none;">
                    <h3>📊 计算结果</h3>
                    <div id="calcResultsContent"></div>
                </div>
            </div>

            <div class="card">
                <h2>💧 水电费管理</h2>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button onclick="showUtilityTab('water')" class="btn btn-secondary" id="waterTabBtn">水费抄表</button>
                    <button onclick="showUtilityTab('electricity')" class="btn btn-secondary" id="electricityTabBtn">电费抄表</button>
                    <button onclick="showUtilityTab('deposit')" class="btn btn-secondary" id="depositTabBtn">押金管理</button>
                </div>
                
                <!-- 水费抄表 -->
                <div id="waterTab" class="utility-tab" style="display: none;">
                    <form id="waterReadingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>房产:</label>
                                <select id="waterProperty" required>
                                    <option value="">请选择房产</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>抄表日期:</label>
                                <input type="date" id="waterDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>当前读数:</label>
                                <input type="number" id="waterReading" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>水费单价(元/吨):</label>
                                <input type="number" id="waterPrice" value="3.5" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>备注:</label>
                                <input type="text" id="waterRemark" placeholder="如: 月度抄表">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">提交抄表</button>
                    </form>
                </div>
                
                <!-- 电费抄表 -->
                <div id="electricityTab" class="utility-tab" style="display: none;">
                    <form id="electricityReadingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>房产:</label>
                                <select id="electricityProperty" required>
                                    <option value="">请选择房产</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>抄表日期:</label>
                                <input type="date" id="electricityDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>当前读数:</label>
                                <input type="number" id="electricityReading" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>预付费充值:</label>
                                <input type="number" id="electricityRecharge" step="0.01" placeholder="可选">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>备注:</label>
                                <input type="text" id="electricityRemark" placeholder="如: 月度抄表+充值">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">提交抄表</button>
                    </form>
                </div>
                
                <!-- 押金管理 -->
                <div id="depositTab" class="utility-tab" style="display: none;">
                    <form id="depositForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>房产:</label>
                                <select id="depositProperty" required>
                                    <option value="">请选择房产</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>押金类型:</label>
                                <select id="depositType" required>
                                    <option value="水费押金">水费押金</option>
                                    <option value="装修押金">装修押金</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>押金金额:</label>
                                <input type="number" id="depositAmount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>缴费日期:</label>
                                <input type="date" id="depositDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>备注:</label>
                                <input type="text" id="depositRemark" placeholder="押金说明">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">创建押金记录</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <h2>🎫 每日收入管理</h2>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button onclick="showIncomeTab('access-card')" class="btn btn-secondary" id="accessCardTabBtn">门禁卡</button>
                    <button onclick="showIncomeTab('fire-test')" class="btn btn-secondary" id="fireTestTabBtn">消防放水</button>
                    <button onclick="showIncomeTab('other')" class="btn btn-secondary" id="otherTabBtn">其他收费</button>
                </div>
                
                <!-- 门禁卡收费 -->
                <div id="accessCardTab" class="income-tab" style="display: none;">
                    <form id="accessCardForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>房产:</label>
                                <select id="accessCardProperty" required>
                                    <option value="">请选择房产</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>门禁卡数量:</label>
                                <input type="number" id="accessCardQuantity" min="1" value="1" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>单价(元/张):</label>
                                <input type="number" id="accessCardPrice" value="20" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>收费日期:</label>
                                <input type="date" id="accessCardDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>说明:</label>
                                <input type="text" id="accessCardDescription" placeholder="如: 张三门禁卡2张">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">记录收费</button>
                    </form>
                </div>
                
                <!-- 消防放水费 -->
                <div id="fireTestTab" class="income-tab" style="display: none;">
                    <form id="fireTestForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>房产:</label>
                                <select id="fireTestProperty" required>
                                    <option value="">请选择房产</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>费用(元):</label>
                                <input type="number" id="fireTestAmount" value="100" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>收费日期:</label>
                                <input type="date" id="fireTestDate" required>
                            </div>
                            <div class="form-group">
                                <label>说明:</label>
                                <input type="text" id="fireTestDescription" placeholder="如: A栋1单元101消防放水">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">记录收费</button>
                    </form>
                </div>
                
                <!-- 其他收费 -->
                <div id="otherTab" class="income-tab" style="display: none;">
                    <form id="otherIncomeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>房产:</label>
                                <select id="otherProperty">
                                    <option value="">请选择房产(可选)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>收费类型:</label>
                                <input type="text" id="otherIncomeType" placeholder="如: 停车费" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>费用(元):</label>
                                <input type="number" id="otherAmount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>收费日期:</label>
                                <input type="date" id="otherDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>说明:</label>
                                <input type="text" id="otherDescription" placeholder="收费说明">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">记录收费</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 租赁管理页面 -->
        <div id="rental" class="page">
            <div class="card">
                <h2>🏠 房屋租售</h2>
                <button onclick="loadRentalProperties()" class="btn btn-secondary">刷新列表</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>小区</th>
                            <th>房产</th>
                            <th>面积</th>
                            <th>类型</th>
                            <th>业主</th>
                            <th>租金</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rentalPropertiesBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>🅿️ 车位租售</h2>
                <button onclick="loadRentalParkingSpaces()" class="btn btn-secondary">刷新列表</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>小区</th>
                            <th>车位编号</th>
                            <th>类型</th>
                            <th>业主</th>
                            <th>位置描述</th>
                            <th>租金</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rentalParkingBody"></tbody>
                </table>
            </div>

            <div class="card">
                <h2>📋 合同管理</h2>
                <button onclick="toggleContractForm()" class="btn btn-success">新建合同</button>
                <button onclick="loadRentalContracts()" class="btn btn-secondary">刷新列表</button>
                
                <!-- 合同创建表单 -->
                <div id="contractForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #3498db; border-radius: 8px; background-color: #f8f9fa;">
                    <h3>📝 新建租赁合同</h3>
                    <form onsubmit="createContract(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>合同编号:</label>
                                <input type="text" id="contractNumber" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label>租赁类型:</label>
                                <select id="rentalType" required onchange="updateRentalOptions()">
                                    <option value="">请选择租赁类型</option>
                                    <option value="property">房屋租赁</option>
                                    <option value="parking">车位租赁</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label id="rentalObjectLabel">租赁对象:</label>
                                <select id="rentalObject" required>
                                    <option value="">请先选择租赁类型</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>租客信息:</label>
                                <select id="tenantSelect" required>
                                    <option value="">请选择租客</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>月租金(元):</label>
                                <input type="number" id="monthlyRent" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>押金(元):</label>
                                <input type="number" id="depositAmount" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>合同开始日期:</label>
                                <input type="date" id="contractStart" required>
                            </div>
                            <div class="form-group">
                                <label>合同结束日期:</label>
                                <input type="date" id="contractEnd" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>付款周期:</label>
                                <select id="paymentCycle" required>
                                    <option value="monthly">月付</option>
                                    <option value="quarterly">季付</option>
                                    <option value="semi_annual">半年付</option>
                                    <option value="annual">年付</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>合同状态:</label>
                                <select id="contractStatus">
                                    <option value="active">生效中</option>
                                    <option value="pending">待生效</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>备注:</label>
                            <textarea id="contractRemarks" rows="3" placeholder="合同备注信息"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">创建合同</button>
                            <button type="button" onclick="cancelContractForm()" class="btn btn-secondary" style="margin-left: 10px;">取消</button>
                        </div>
                    </form>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>合同编号</th>
                            <th>租赁对象</th>
                            <th>租客</th>
                            <th>租金</th>
                            <th>押金</th>
                            <th>开始日期</th>
                            <th>结束日期</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="contractsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 装修管理页面 -->
        <div id="decoration" class="page">
            <div class="card">
                <h2>🔨 装修许可管理</h2>
                <button onclick="toggleDecorationForm()" class="btn btn-success">新建装修许可</button>
                <button onclick="loadDecorationPermits()" class="btn btn-secondary">刷新列表</button>
                
                <!-- 装修许可创建表单 -->
                <div id="decorationForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #e67e22; border-radius: 8px; background-color: #fef9e7;">
                    <h3>📄 新建装修许可申请</h3>
                    <form onsubmit="createDecorationPermit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>许可证编号:</label>
                                <input type="text" id="permitNumber" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label>装修房产:</label>
                                <select id="decorationProperty" required>
                                    <option value="">请选择房产</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>装修类型:</label>
                                <select id="decorationType" required>
                                    <option value="">请选择装修类型</option>
                                    <option value="新装修">新装修</option>
                                    <option value="二次装修">二次装修</option>
                                    <option value="局部装修">局部装修</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>施工方名称:</label>
                                <input type="text" id="contractorName" required placeholder="请输入施工方名称">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>联系人姓名:</label>
                                <input type="text" id="contactPerson" required placeholder="请输入联系人姓名">
                            </div>
                            <div class="form-group">
                                <label>联系电话:</label>
                                <input type="tel" id="contactPhone" required placeholder="请输入联系电话">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>装修开始日期:</label>
                                <input type="date" id="decorationStart" required>
                            </div>
                            <div class="form-group">
                                <label>预计结束日期:</label>
                                <input type="date" id="decorationEnd" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>装修押金(元):</label>
                                <input type="number" id="decorationDeposit" step="0.01" required placeholder="请输入装修押金">
                            </div>
                            <div class="form-group">
                                <label>清运费(元):</label>
                                <input type="number" id="cleaningFee" step="0.01" placeholder="装修垃圾清运费">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>消防放水费(元):</label>
                                <input type="number" id="fireSafetyFee" step="0.01" placeholder="消防用水费用">
                            </div>
                            <div class="form-group">
                                <label>其他费用(元):</label>
                                <input type="number" id="otherFees" step="0.01" placeholder="其他相关费用">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>申请状态:</label>
                            <select id="decorationStatus">
                                <option value="申请中">申请中</option>
                                <option value="审批通过">审批通过</option>
                                <option value="装修中">装修中</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>备注:</label>
                            <textarea id="decorationRemarks" rows="3" placeholder="装修相关备注信息"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">创建许可</button>
                            <button type="button" onclick="cancelDecorationForm()" class="btn btn-secondary" style="margin-left: 10px;">取消</button>
                        </div>
                    </form>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>许可证编号</th>
                            <th>房产</th>
                            <th>业主</th>
                            <th>施工期间</th>
                            <th>联系人</th>
                            <th>装修押金</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="decorationPermitsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 车辆管理页面 -->
        <div id="vehicles" class="page">
            <div class="card">
                <h2>🚗 车位车辆绑定</h2>
                <button onclick="toggleVehicleBindingForm()" class="btn btn-success">新建绑定</button>
                <button onclick="loadVehicleBindings()" class="btn btn-secondary">刷新列表</button>
                
                <!-- 车辆绑定创建表单 -->
                <div id="vehicleBindingForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #27ae60; border-radius: 8px; background-color: #eafaf1;">
                    <h3>🔗 新建车辆绑定</h3>
                    <form onsubmit="createVehicleBinding(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>车位信息:</label>
                                <select id="bindingParkingSpace" required>
                                    <option value="">请选择车位</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>车牌号:</label>
                                <input type="text" id="vehicleLicensePlate" required placeholder="请输入车牌号" style="text-transform: uppercase;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>车型:</label>
                                <input type="text" id="vehicleModel" required placeholder="请输入车型">
                            </div>
                            <div class="form-group">
                                <label>车辆颜色:</label>
                                <input type="text" id="vehicleColor" placeholder="请输入车辆颜色">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>车主类型:</label>
                                <select id="ownerType" required onchange="updateOwnerOptions()">
                                    <option value="">请选择车主类型</option>
                                    <option value="业主">业主</option>
                                    <option value="租客">租客</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>车主信息:</label>
                                <select id="vehicleOwner" required>
                                    <option value="">请先选择车主类型</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>绑定类型:</label>
                                <select id="bindingType" required>
                                    <option value="owner">业主使用</option>
                                    <option value="rent">租赁使用</option>
                                    <option value="temporary">临时停放</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>绑定状态:</label>
                                <select id="bindingStatus">
                                    <option value="active">正常使用</option>
                                    <option value="pending">待激活</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>绑定开始日期:</label>
                                <input type="date" id="bindingStartDate" required>
                            </div>
                            <div class="form-group">
                                <label>绑定结束日期:</label>
                                <input type="date" id="bindingEndDate" placeholder="留空表示不限期">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>备注:</label>
                            <textarea id="vehicleRemarks" rows="3" placeholder="车辆绑定相关备注"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">创建绑定</button>
                            <button type="button" onclick="cancelVehicleBindingForm()" class="btn btn-secondary" style="margin-left: 10px;">取消</button>
                        </div>
                    </form>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>车位编号</th>
                            <th>车牌号</th>
                            <th>车型</th>
                            <th>业主</th>
                            <th>绑定类型</th>
                            <th>绑定时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="vehicleBindingsBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>⚠️ 违章管理</h2>
                <button onclick="toggleViolationForm()" class="btn btn-success">登记违章</button>
                <button onclick="loadViolations()" class="btn btn-secondary">刷新列表</button>
                
                <!-- 违章登记表单 -->
                <div id="violationForm" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #e74c3c; border-radius: 8px; background-color: #fdedec;">
                    <h3>🚨 新增违章记录</h3>
                    <form onsubmit="createViolation(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>违章编号:</label>
                                <input type="text" id="violationNumber" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label>车牌号:</label>
                                <input type="text" id="violationLicensePlate" required placeholder="请输入车牌号" style="text-transform: uppercase;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>违章类型:</label>
                                <select id="violationType" required>
                                    <option value="">请选择违章类型</option>
                                    <option value="乱停乱放">乱停乱放</option>
                                    <option value="占用消防通道">占用消防通道</option>
                                    <option value="占用绿化带">占用绿化带</option>
                                    <option value="超速行驶">超速行驶</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>违章地点:</label>
                                <input type="text" id="violationLocation" required placeholder="请输入违章地点">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>违章时间:</label>
                                <input type="datetime-local" id="violationTime" required>
                            </div>
                            <div class="form-group">
                                <label>罚款金额(元):</label>
                                <input type="number" id="fineAmount" step="0.01" required placeholder="请输入罚款金额">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>上报人:</label>
                                <input type="text" id="violationReporter" placeholder="上报人姓名">
                            </div>
                            <div class="form-group">
                                <label>处理状态:</label>
                                <select id="violationStatus">
                                    <option value="待处理">待处理</option>
                                    <option value="已通知">已通知</option>
                                    <option value="已处理">已处理</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>备注:</label>
                            <textarea id="violationRemarks" rows="3" placeholder="违章情况详细描述"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">登记违章</button>
                            <button type="button" onclick="cancelViolationForm()" class="btn btn-secondary" style="margin-left: 10px;">取消</button>
                        </div>
                    </form>
                </div>
                
                <div class="stats" style="margin: 20px 0;">
                    <div class="stat-card stat-red">
                        <h3 id="pendingViolations">0</h3>
                        <p>待处理违章</p>
                    </div>
                    <div class="stat-card stat-blue">
                        <h3 id="totalFines">¥0</h3>
                        <p>罚款总额</p>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>车牌号</th>
                            <th>违章类型</th>
                            <th>违章时间</th>
                            <th>地点</th>
                            <th>罚款金额</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="violationsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 日报管理页面 -->
        <div id="reports" class="page">
            <div class="card">
                <h2>📈 日报表生成</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>报表类型:</label>
                        <select id="reportType">
                            <option value="daily">日报表</option>
                            <option value="monthly">月报表</option>
                            <option value="quarterly">季度报表</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>查询日期:</label>
                        <input type="date" id="reportDate">
                    </div>
                </div>
                <button onclick="generateReport()" class="btn btn-success">生成报表</button>
                <div id="reportResults" style="margin-top: 20px; display: none;"></div>
            </div>
            
            <div class="card">
                <h2>💸 欠费统计</h2>
                <button onclick="loadOutstandingFees()" class="btn btn-secondary">刷新欠费统计</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>业主</th>
                            <th>联系电话</th>
                            <th>房产</th>
                            <th>车位</th>
                            <th>欠费笔数</th>
                            <th>欠费总额</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="outstandingFeesBody"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>🔍 欠费看板</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>查询类型:</label>
                        <select id="searchType">
                            <option value="owner">按业主名称</option>
                            <option value="property">按门牌号</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>查询内容:</label>
                        <input type="text" id="searchValue" placeholder="输入业主名称或门牌号(如: A栋-1单元-101)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>截止日期:</label>
                        <input type="date" id="dashboardEndDate">
                    </div>
                </div>
                <button onclick="searchOutstanding()" class="btn btn-success">查询欠费</button>
                <div id="dashboardResults" style="margin-top: 20px; display: none;"></div>
            </div>
        </div>

        <!-- 房产照片查看模态框 -->
        <div id="propertyPhotosModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>🏠 房产照片</h2>
                    <span class="close" onclick="closePropertyPhotosModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="propertyPhotosContainer">
                        <!-- 照片将动态加载到这里 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 违章照片查看模态框 -->
        <div id="violationPhotosModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>🚗 违章照片</h2>
                    <span class="close" onclick="closeViolationPhotosModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="violationPhotosContainer">
                        <!-- 照片将动态加载到这里 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据导入页面 -->
        <div id="import" class="page">
            <div class="card">
                <h2>📥 Excel数据导入</h2>
                <p style="color: #666; margin-bottom: 20px;">支持批量导入业主、房产、车位数据。请先下载模板，按格式填写后上传。</p>
                
                <!-- 业主数据导入 -->
                <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <h3>👤 业主数据导入</h3>
                    <div style="margin: 15px 0;">
                        <a href="javascript:downloadTemplate('owners')" class="btn btn-secondary">📋 下载业主导入模板</a>
                        <span style="margin-left: 10px; color: #666;">支持字段：姓名*、电话、身份证、工作单位、职务、爱好、备注</span>
                    </div>
                    <div style="margin: 15px 0;">
                        <input type="file" id="ownersFile" accept=".xlsx,.xls" style="margin-right: 10px;">
                        <button onclick="importData('owners')" class="btn btn-success">📤 导入业主数据</button>
                    </div>
                    <div id="ownersResult" style="margin-top: 10px;"></div>
                </div>

                <!-- 房产数据导入 -->
                <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <h3>🏢 房产数据导入</h3>
                    <div style="margin: 15px 0;">
                        <a href="javascript:downloadTemplate('properties')" class="btn btn-secondary">📋 下载房产导入模板</a>
                        <span style="margin-left: 10px; color: #666;">支持字段：楼栋*、单元*、房号*、面积*、房产性质、业主</span>
                    </div>
                    <div style="margin: 15px 0;">
                        <input type="file" id="propertiesFile" accept=".xlsx,.xls" style="margin-right: 10px;">
                        <button onclick="importData('properties')" class="btn btn-success">📤 导入房产数据</button>
                    </div>
                    <div id="propertiesResult" style="margin-top: 10px;"></div>
                </div>

                <!-- 车位数据导入 -->
                <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <h3>🅿️ 车位数据导入</h3>
                    <div style="margin: 15px 0;">
                        <a href="javascript:downloadTemplate('parking')" class="btn btn-secondary">📋 下载车位导入模板</a>
                        <span style="margin-left: 10px; color: #666;">支持字段：车位编号*、类型、状态、业主、位置描述</span>
                    </div>
                    <div style="margin: 15px 0;">
                        <input type="file" id="parkingFile" accept=".xlsx,.xls" style="margin-right: 10px;">
                        <button onclick="importData('parking')" class="btn btn-success">📤 导入车位数据</button>
                    </div>
                    <div id="parkingResult" style="margin-top: 10px;"></div>
                </div>

                <!-- 导入说明 -->
                <div class="card" style="background: #f8f9fa; border: 1px solid #e9ecef;">
                    <h3>📝 导入说明</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>文件格式</strong>：仅支持Excel文件(.xlsx, .xls)，文件大小不超过5MB</li>
                        <li><strong>数据顺序</strong>：建议先导入业主，再导入房产和车位(因为房产和车位需要关联业主)</li>
                        <li><strong>字段说明</strong>：带*的字段为必填项，其他为可选项</li>
                        <li><strong>业主关联</strong>：房产和车位的"业主"字段请填写业主姓名，系统会自动匹配</li>
                        <li><strong>数据验证</strong>：系统会自动验证数据格式，重复数据将被跳过</li>
                        <li><strong>错误处理</strong>：导入时如有错误，会显示详细的错误信息</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加房产类型模态框 -->
    <div id="addPropertyTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📝 添加房产类型收费标准</h2>
                <span class="close" onclick="closeAddPropertyTypeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addPropertyTypeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>房产类型名称: <span style="color:red">*</span></label>
                            <input type="text" id="newPropertyTypeName" placeholder="如: 洋房" required>
                        </div>
                        <div class="form-group">
                            <label>物业费单价(元/㎡/月): <span style="color:red">*</span></label>
                            <input type="number" id="newPropertyTypeRate" step="0.01" min="0" placeholder="如: 2.8" required>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeAddPropertyTypeModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-success">添加</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        // 页面切换
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'owners') loadOwners();
            if (pageId === 'communities') loadCommunities();
            if (pageId === 'properties') { loadProperties(); loadCommunitiesForSelect(); loadOwnersForSelect(); }
            if (pageId === 'parking') { loadParkingSpaces(); loadCommunitiesForSelect(); loadOwnersForSelect(); }
            if (pageId === 'fees') { loadFeeRecords(); loadPropertiesForSelect(); loadFeeStats(); loadFeeItems(); loadFeeRatesCache(); }
            if (pageId === 'advanced-fees') { loadOwnersForSelect(); loadPropertiesForSelect(); loadPropertyFeeRates(); showUtilityTab('water'); }
            if (pageId === 'rental') { loadRentalProperties(); loadRentalParkingSpaces(); loadRentalContracts(); }
            if (pageId === 'decoration') { loadDecorationPermits(); }
            if (pageId === 'vehicles') { loadVehicleBindings(); loadViolations(); loadViolationStats(); }
            if (pageId === 'reports') { setDefaultReportDate(); }
            if (pageId === 'import') { /* 数据导入页面无需初始化加载 */ }
        }
        
        // 加载仪表盘数据
        async function loadDashboard() {
            try {
                const [ownersRes, propertiesRes, parkingRes, feeStatsRes] = await Promise.all([
                    fetch(`${API_BASE}/owners`),
                    fetch(`${API_BASE}/properties`),
                    fetch(`${API_BASE}/parking`),
                    fetch(`${API_BASE}/fees/stats`)
                ]);
                
                const owners = await ownersRes.json();
                const properties = await propertiesRes.json();
                const parking = await parkingRes.json();
                const feeStats = await feeStatsRes.json();
                
                if (owners.success) document.getElementById('ownerCount').textContent = owners.data.length;
                if (properties.success) document.getElementById('propertyCount').textContent = properties.data.length;
                if (parking.success) document.getElementById('parkingCount').textContent = parking.data.length;
                if (feeStats.success) document.getElementById('feeTotal').textContent = '¥' + (feeStats.data.unpaid_amount || 0);
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
            }
        }
        
        // 加载业主列表
        async function loadOwners() {
            try {
                const response = await fetch(`${API_BASE}/owners`);
                const result = await response.json();
                
                const tbody = document.getElementById('ownerTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(owner => `
                        <tr>
                            <td>
                                ${owner.photo_url ? 
                                    `<img src="${API_BASE.replace('/api', '')}${owner.photo_url}" alt="业主照片" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : 
                                    '<span style="color: #999;">无照片</span>'
                                }
                            </td>
                            <td>${owner.name}</td>
                            <td>${owner.phone || '-'}</td>
                            <td>${owner.id_card || '-'}</td>
                            <td>${owner.company || '-'}</td>
                            <td>${owner.position || '-'}</td>
                            <td>${owner.property_count || 0}</td>
                            <td>${owner.parking_count || 0}</td>
                            <td>
                                <button onclick="editOwner(${owner.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">编辑</button>
                                <button onclick="deleteOwner(${owner.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载业主列表失败:', error);
            }
        }
        
        // 加载房产列表
        async function loadProperties() {
            try {
                const response = await fetch(`${API_BASE}/properties`);
                const result = await response.json();
                
                const tbody = document.getElementById('propertyTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(property => `
                        <tr>
                            <td>${property.community_name || '未知小区'}</td>
                            <td>${property.property_type}</td>
                            <td>${property.building}-${property.unit}-${property.room}</td>
                            <td>${property.area}</td>
                            <td>${property.is_delivered ? '已交房' : '未交房'}</td>
                            <td>${property.is_decorated ? '已装修' : '未装修'}</td>
                            <td>${property.occupancy_status}</td>
                            <td>${property.is_for_rent ? '可租售' : '不租售'}</td>
                            <td>${property.owner_name || '空置'}</td>
                            <td>
                                <button onclick="editProperty(${property.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">编辑</button>
                                <button onclick="deleteProperty(${property.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载房产列表失败:', error);
            }
        }
        
        // 加载业主选项
        async function loadOwnersForSelect() {
            try {
                const response = await fetch(`${API_BASE}/owners`);
                const result = await response.json();
                
                const propertySelect = document.getElementById('propertyOwner');
                const parkingSelect = document.getElementById('parkingOwner');
                const calcOwnerSelect = document.getElementById('calcOwner');
                const editPropertyOwnerSelect = document.getElementById('editPropertyOwner');
                const editParkingOwnerSelect = document.getElementById('editParkingOwner');
                
                if (result.success) {
                    const options = '<option value="">请选择业主</option>' + 
                        result.data.map(owner => `<option value="${owner.id}">${owner.name}${owner.phone ? ' - ' + owner.phone : ''}</option>`).join('');
                    
                    if (propertySelect) propertySelect.innerHTML = options;
                    if (parkingSelect) parkingSelect.innerHTML = options;
                    if (calcOwnerSelect) calcOwnerSelect.innerHTML = options;
                    if (editPropertyOwnerSelect) editPropertyOwnerSelect.innerHTML = options;
                    if (editParkingOwnerSelect) editParkingOwnerSelect.innerHTML = options;
                }
            } catch (error) {
                console.error('加载业主选项失败:', error);
            }
        }
        
        // 加载房产选项（增强版，包含房产详情）
        async function loadPropertiesForSelect() {
            try {
                const response = await fetch(`${API_BASE}/properties`);
                const result = await response.json();
                
                const feePropertySelect = document.getElementById('feeProperty');
                const calcPropertySelect = document.getElementById('calcProperty');
                
                if (result.success) {
                    const options = '<option value="">请选择房产</option>' + 
                        result.data.map(property => `<option value="${property.id}" data-area="${property.area}" data-type="${property.property_type}">${property.building}-${property.unit}-${property.room} (${property.property_type}, ${property.area}㎡)</option>`).join('');
                        
                    if (feePropertySelect) feePropertySelect.innerHTML = options;
                    if (calcPropertySelect) calcPropertySelect.innerHTML = options;
                    
                    // 同时填充高级收费页面的其他房产选择框
                    const utilitySelects = [
                        'waterProperty', 'electricityProperty', 'depositProperty',
                        'accessCardProperty', 'fireTestProperty', 'otherProperty'
                    ];
                    
                    utilitySelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = options;
                        }
                    });
                }
            } catch (error) {
                console.error('加载房产选项失败:', error);
            }
        }
        
        // 全局存储费率数据
        let propertyFeeRatesCache = {};
        
        // 加载费率数据到缓存
        async function loadFeeRatesCache() {
            try {
                const response = await fetch(`${API_BASE}/advanced-fees/rates`);
                const result = await response.json();
                if (result.success) {
                    propertyFeeRatesCache = {};
                    result.data.forEach(rate => {
                        propertyFeeRatesCache[rate.property_type] = rate.unit_price;
                    });
                }
            } catch (error) {
                console.error('加载费率缓存失败:', error);
            }
        }
        
        // 更新费用金额建议
        function updateFeeAmount() {
            const propertySelect = document.getElementById('feeProperty');
            const feeTypeSelect = document.getElementById('feeType');
            const amountInput = document.getElementById('feeAmount');
            const tipDiv = document.getElementById('feeAmountTip');
            
            if (!propertySelect.value || !feeTypeSelect.value) {
                tipDiv.innerHTML = '';
                return;
            }
            
            const selectedOption = propertySelect.options[propertySelect.selectedIndex];
            const area = parseFloat(selectedOption.dataset.area);
            const propertyType = selectedOption.dataset.type;
            const feeType = feeTypeSelect.value;
            
            if (feeType === '物业费' && area && propertyType && propertyFeeRatesCache[propertyType]) {
                const rate = propertyFeeRatesCache[propertyType];
                const monthlyAmount = area * rate;
                amountInput.value = monthlyAmount.toFixed(2);
                tipDiv.innerHTML = `💡 ${propertyType}标准: ${rate}元/㎡/月 × ${area}㎡ = ${monthlyAmount.toFixed(2)}元/月`;
                tipDiv.style.color = '#28a745';
            } else if (feeType === '物业费') {
                tipDiv.innerHTML = '⚠️ 该房产类型暂无费率标准，请在高级收费管理中设置';
                tipDiv.style.color = '#e74c3c';
            } else {
                tipDiv.innerHTML = '';
            }
        }
        
        // 加载收费记录
        async function loadFeeRecords() {
            try {
                const response = await fetch(`${API_BASE}/fees`);
                const result = await response.json();
                
                const tbody = document.getElementById('feeTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(fee => `
                        <tr>
                            <td>${fee.building}-${fee.unit}-${fee.room}</td>
                            <td><span style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${fee.property_type || '未知'}</span></td>
                            <td>${fee.owner_name || '未分配'}</td>
                            <td>${fee.fee_type}</td>
                            <td>¥${fee.amount}</td>
                            <td>${fee.period}</td>
                            <td>${fee.due_date}</td>
                            <td style="color: ${fee.status === 'paid' ? '#27ae60' : '#e74c3c'};">
                                ${fee.status === 'paid' ? '已缴费' : '未缴费'}
                            </td>
                            <td>
                                ${fee.status === 'unpaid' ? 
                                    `<button onclick="markAsPaid(${fee.id})" class="btn btn-success" style="padding: 5px 10px; font-size: 12px;">标记已缴费</button>` :
                                    `<button onclick="markAsUnpaid(${fee.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">标记未缴费</button>`
                                }
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载收费记录失败:', error);
            }
        }
        
        // 加载收费统计
        async function loadFeeStats() {
            try {
                const response = await fetch(`${API_BASE}/fees/stats`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('paidAmount').textContent = '¥' + (result.data.paid_amount || 0);
                    document.getElementById('unpaidAmount').textContent = '¥' + (result.data.unpaid_amount || 0);
                }
            } catch (error) {
                console.error('加载收费统计失败:', error);
            }
        }
        
        // 标记为已缴费
        async function markAsPaid(feeId) {
            try {
                const response = await fetch(`${API_BASE}/fees/${feeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'paid' })
                });
                
                if (response.ok) {
                    loadFeeRecords();
                    loadFeeStats();
                    loadDashboard();
                }
            } catch (error) {
                alert('操作失败');
            }
        }
        
        // 标记为未缴费
        async function markAsUnpaid(feeId) {
            try {
                const response = await fetch(`${API_BASE}/fees/${feeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'unpaid' })
                });
                
                if (response.ok) {
                    loadFeeRecords();
                    loadFeeStats();
                    loadDashboard();
                }
            } catch (error) {
                alert('操作失败');
            }
        }
        
        // 添加业主
        document.getElementById('ownerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('ownerName').value,
                phone: document.getElementById('ownerPhone').value,
                id_card: document.getElementById('ownerIdCard').value,
                company: document.getElementById('ownerCompany').value,
                position: document.getElementById('ownerPosition').value,
                hobby: document.getElementById('ownerHobby').value,
                remark: document.getElementById('ownerRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/owners`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('业主添加成功！');
                    document.getElementById('ownerForm').reset();
                    loadOwners();
                    loadDashboard();
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                alert('添加失败: ' + error.message);
                console.error(error);
            }
        });
        
        // 添加房产
        document.getElementById('propertyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                community_id: document.getElementById('propertyCommunity').value,
                property_type: document.getElementById('propertyType').value,
                building: document.getElementById('propertyBuilding').value,
                unit: document.getElementById('propertyUnit').value,
                room: document.getElementById('propertyRoom').value,
                area: parseFloat(document.getElementById('propertyArea').value),
                is_delivered: document.getElementById('propertyDelivered').value,
                is_decorated: document.getElementById('propertyDecorated').value,
                occupancy_status: document.getElementById('propertyOccupancy').value,
                is_for_rent: document.getElementById('propertyForRent').value,
                handover_date: document.getElementById('propertyHandoverDate').value,
                owner_id: document.getElementById('propertyOwner').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/properties`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('房产添加成功！');
                    document.getElementById('propertyForm').reset();
                    loadProperties();
                    loadDashboard();
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                alert('添加失败: ' + error.message);
                console.error(error);
            }
        });
        
        // 房产编辑表单提交
        document.getElementById('propertyEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const propertyId = document.getElementById('editPropertyId').value;
            const formData = {
                community_id: document.getElementById('editPropertyCommunity').value,
                property_type: document.getElementById('editPropertyType').value,
                building: document.getElementById('editPropertyBuilding').value,
                unit: document.getElementById('editPropertyUnit').value,
                room: document.getElementById('editPropertyRoom').value,
                area: parseFloat(document.getElementById('editPropertyArea').value),
                is_delivered: document.getElementById('editPropertyDelivered').value,
                is_decorated: document.getElementById('editPropertyDecorated').value,
                occupancy_status: document.getElementById('editPropertyOccupancy').value,
                is_for_rent: document.getElementById('editPropertyForRent').value,
                handover_date: document.getElementById('editPropertyHandoverDate').value,
                owner_id: document.getElementById('editPropertyOwner').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('房产信息更新成功！');
                    closePropertyEditModal();
                    loadProperties();
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
                console.error(error);
            }
        });
        
        // 添加收费记录
        document.getElementById('feeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('feeProperty').value,
                fee_type: document.getElementById('feeType').value,
                amount: parseFloat(document.getElementById('feeAmount').value),
                period: document.getElementById('feePeriod').value,
                due_date: document.getElementById('feeDueDate').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/fees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('收费记录添加成功！');
                    document.getElementById('feeForm').reset();
                    loadFeeRecords();
                    loadFeeStats();
                    loadDashboard();
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                alert('添加失败: ' + error.message);
                console.error(error);
            }
        });
        
        // 添加收费项目
        document.getElementById('feeItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('feeItemName').value,
                unit_price: document.getElementById('feeItemPrice').value || null,
                calculation_method: document.getElementById('feeItemMethod').value || null,
                description: document.getElementById('feeItemDescription').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/fees/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('收费项目添加成功！');
                    document.getElementById('feeItemForm').reset();
                    loadFeeItems();
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                alert('添加失败');
                console.error(error);
            }
        });
        
        // 加载收费项目列表
        async function loadFeeItems() {
            try {
                const response = await fetch(`${API_BASE}/fees/items`);
                const result = await response.json();
                
                const tbody = document.getElementById('feeItemTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(item => `
                        <tr>
                            <td>
                                <input type="text" 
                                       id="item_name_${item.id}" 
                                       value="${item.name || ''}" 
                                       style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="markFeeItemAsModified()">
                            </td>
                            <td>
                                <input type="number" 
                                       id="item_price_${item.id}" 
                                       value="${item.unit_price || ''}" 
                                       step="0.01" 
                                       min="0"
                                       style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="markFeeItemAsModified()">
                            </td>
                            <td>
                                <select id="item_method_${item.id}" 
                                        style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                        onchange="markFeeItemAsModified()">
                                    <option value="">请选择</option>
                                    <option value="按面积" ${item.calculation_method === '按面积' ? 'selected' : ''}>按面积</option>
                                    <option value="按套" ${item.calculation_method === '按套' ? 'selected' : ''}>按套</option>
                                    <option value="按月" ${item.calculation_method === '按月' ? 'selected' : ''}>按月</option>
                                    <option value="按年" ${item.calculation_method === '按年' ? 'selected' : ''}>按年</option>
                                    <option value="按次" ${item.calculation_method === '按次' ? 'selected' : ''}>按次</option>
                                </select>
                            </td>
                            <td>
                                <input type="text" 
                                       id="item_desc_${item.id}" 
                                       value="${item.description || ''}" 
                                       style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="markFeeItemAsModified()">
                            </td>
                            <td>${new Date(item.created_at).toLocaleDateString()}</td>
                            <td>
                                <button onclick="deactivateFeeItem(${item.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">停用</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
                }
            } catch (error) {
                console.error('加载收费项目列表失败:', error);
                document.getElementById('feeItemTableBody').innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
            }
        }
        
        // 标记收费项目为已修改
        function markFeeItemAsModified() {
            const statusElement = document.getElementById('feeItemBatchUpdateStatus');
            statusElement.style.display = 'none';
        }

        // 批量保存收费项目
        async function saveBatchFeeItems() {
            const tbody = document.getElementById('feeItemTableBody');
            const rows = tbody.querySelectorAll('tr');
            const updates = [];
            
            // 收集所有输入值
            rows.forEach(row => {
                const nameInput = row.querySelector('[id^="item_name_"]');
                const priceInput = row.querySelector('[id^="item_price_"]');
                const methodSelect = row.querySelector('[id^="item_method_"]');
                const descInput = row.querySelector('[id^="item_desc_"]');
                
                if (nameInput) {
                    const itemId = nameInput.id.replace('item_name_', '');
                    updates.push({
                        id: parseInt(itemId),
                        name: nameInput.value.trim(),
                        unit_price: parseFloat(priceInput.value) || null,
                        calculation_method: methodSelect.value || null,
                        description: descInput.value.trim() || null
                    });
                }
            });
            
            if (updates.length === 0) {
                alert('没有可保存的数据');
                return;
            }
            
            try {
                // 显示保存状态
                const statusElement = document.getElementById('feeItemBatchUpdateStatus');
                statusElement.textContent = '💾 保存中...';
                statusElement.style.display = 'inline';
                statusElement.style.color = '#f39c12';
                
                // 批量更新所有收费项目
                const promises = updates.map(update => 
                    fetch(`${API_BASE}/fees/items/${update.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: update.name,
                            unit_price: update.unit_price,
                            calculation_method: update.calculation_method,
                            description: update.description
                        })
                    })
                );
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                // 检查是否全部成功
                const failures = results.filter(r => !r.success);
                if (failures.length > 0) {
                    throw new Error(`${failures.length}个收费项目更新失败`);
                }
                
                // 更新状态显示
                statusElement.textContent = '✅ 已保存';
                statusElement.style.color = '#27ae60';
                
                // 3秒后隐藏状态
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                const statusElement = document.getElementById('feeItemBatchUpdateStatus');
                statusElement.textContent = '❌ 保存失败';
                statusElement.style.color = '#e74c3c';
                
                alert('保存失败: ' + error.message);
                console.error('批量保存收费项目失败:', error);
            }
        }
        
        // 停用收费项目
        async function deactivateFeeItem(id) {
            if (!confirm('确定要停用此收费项目吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/fees/items/${id}/deactivate`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('收费项目已停用！');
                    loadFeeItems();
                } else {
                    alert('停用失败: ' + result.message);
                }
            } catch (error) {
                alert('停用失败');
                console.error(error);
            }
        }
        
        // 加载车位列表
        async function loadParkingSpaces() {
            try {
                const response = await fetch(`${API_BASE}/parking`);
                const result = await response.json();
                
                const tbody = document.getElementById('parkingTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(parking => `
                        <tr>
                            <td>${parking.community_name || '未知小区'}</td>
                            <td>${parking.space_number}</td>
                            <td>${parking.type}</td>
                            <td>${parking.status}</td>
                            <td>${parking.owner_name || '无'}</td>
                            <td>${new Date(parking.created_at).toLocaleDateString()}</td>
                            <td>
                                <button onclick="editParking(${parking.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">编辑</button>
                                <button onclick="deleteParking(${parking.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载车位列表失败:', error);
            }
        }
        
        // 加载小区选项
        async function loadCommunitiesForSelect() {
            try {
                const response = await fetch(`${API_BASE}/communities`);
                const result = await response.json();
                
                const selects = ['propertyCommunity', 'parkingCommunity', 'editPropertyCommunity', 'editParkingCommunity'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (result.success && select) {
                        select.innerHTML = '<option value="">请选择小区</option>' + 
                            result.data.map(community => `<option value="${community.id}">${community.name}</option>`).join('');
                    }
                });
            } catch (error) {
                console.error('加载小区选项失败:', error);
            }
        }
        
        // 搜索业主
        async function searchOwners() {
            const searchTerm = document.getElementById('ownerSearchInput').value.trim();
            if (!searchTerm) {
                loadOwners();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/owners/search?keyword=${encodeURIComponent(searchTerm)}`);
                const result = await response.json();
                
                const tbody = document.getElementById('ownerTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(owner => `
                        <tr>
                            <td>
                                ${owner.photo_url ? 
                                    `<img src="${API_BASE.replace('/api', '')}${owner.photo_url}" alt="业主照片" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : 
                                    '<span style="color: #999;">无照片</span>'
                                }
                            </td>
                            <td>${owner.name}</td>
                            <td>${owner.phone || '-'}</td>
                            <td>${owner.id_card || '-'}</td>
                            <td>${owner.company || '-'}</td>
                            <td>${owner.position || '-'}</td>
                            <td>${owner.property_count || 0}</td>
                            <td>${owner.parking_count || 0}</td>
                            <td>
                                <button onclick="editOwner(${owner.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">编辑</button>
                                <button onclick="deleteOwner(${owner.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('搜索业主失败:', error);
            }
        }
        
        // 加载小区列表
        async function loadCommunities() {
            try {
                const response = await fetch(`${API_BASE}/communities`);
                const result = await response.json();
                
                const tbody = document.getElementById('communityTableBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(community => `
                        <tr>
                            <td>${community.name}</td>
                            <td>${community.address || '-'}</td>
                            <td>${community.description || '-'}</td>
                            <td>${community.property_count || 0}</td>
                            <td>${community.parking_count || 0}</td>
                            <td>${new Date(community.created_at).toLocaleDateString()}</td>
                            <td>
                                <button onclick="editCommunity(${community.id})" class="btn" style="padding: 5px 10px; font-size: 12px; margin: 2px;">编辑</button>
                                <button onclick="deleteCommunity(${community.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 2px;">删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载小区列表失败:', error);
            }
        }
        
        // 添加车位
        document.getElementById('parkingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                community_id: document.getElementById('parkingCommunity').value,
                space_number: document.getElementById('parkingNumber').value,
                type: document.getElementById('parkingType').value,
                status: document.getElementById('parkingStatus').value,
                owner_id: document.getElementById('parkingOwner').value || null
            };
            
            try {
                const response = await fetch(`${API_BASE}/parking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('车位添加成功！');
                    document.getElementById('parkingForm').reset();
                    loadParkingSpaces();
                    loadDashboard();
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                alert('添加失败: ' + error.message);
                console.error(error);
            }
        });
        
        // 添加小区
        document.getElementById('communityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('communityName').value,
                address: document.getElementById('communityAddress').value,
                description: document.getElementById('communityDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/communities`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('小区添加成功！');
                    document.getElementById('communityForm').reset();
                    loadCommunities();
                    loadCommunitiesForSelect(); // 刷新小区选项
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                alert('添加失败');
                console.error(error);
            }
        });
        
        // 编辑业主
        async function editOwner(id) {
            try {
                const response = await fetch(`${API_BASE}/owners/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const owner = result.data.owner;
                    
                    // 填充表单
                    document.getElementById('editOwnerId').value = owner.id;
                    document.getElementById('editOwnerName').value = owner.name || '';
                    document.getElementById('editOwnerPhone').value = owner.phone || '';
                    document.getElementById('editOwnerIdCard').value = owner.id_card || '';
                    document.getElementById('editOwnerCompany').value = owner.company || '';
                    document.getElementById('editOwnerPosition').value = owner.position || '';
                    document.getElementById('editOwnerHobby').value = owner.hobby || '';
                    document.getElementById('editOwnerRemark').value = owner.remark || '';
                    
                    // 显示照片
                    updatePhotoDisplay(owner.photo_url);
                    
                    // 显示模态框
                    document.getElementById('ownerEditModal').style.display = 'block';
                } else {
                    alert('获取业主信息失败');
                }
            } catch (error) {
                alert('获取业主信息失败');
                console.error(error);
            }
        }
        
        // 关闭编辑模态框
        function closeOwnerEditModal() {
            document.getElementById('ownerEditModal').style.display = 'none';
            document.getElementById('ownerPhotoInput').value = '';
            document.getElementById('uploadPhotoBtn').style.display = 'none';
        }
        
        // 关闭房产编辑模态框
        function closePropertyEditModal() {
            document.getElementById('propertyEditModal').style.display = 'none';
            // 清空照片上传
            document.getElementById('propertyPhotoInput').value = '';
            document.getElementById('uploadPropertyPhotoBtn').style.display = 'none';
        }
        
        // 加载房产照片用于编辑
        async function loadPropertyPhotosForEdit(propertyId) {
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}/photos`);
                const result = await response.json();
                
                const gallery = document.getElementById('propertyPhotosGallery');
                
                if (result.success && result.data && result.data.length > 0) {
                    gallery.className = 'photos-gallery';
                    gallery.innerHTML = result.data.map((photo, index) => `
                        <div class="photo-item">
                            <img src="${API_BASE.replace('/api', '')}${photo.url}" alt="房产照片${index + 1}">
                            <button class="delete-btn" onclick="deletePropertyPhoto(${propertyId}, '${photo.url}')" title="删除照片">&times;</button>
                        </div>
                    `).join('');
                } else {
                    gallery.className = 'photos-gallery empty';
                    gallery.innerHTML = '';
                }
            } catch (error) {
                console.error('加载房产照片失败:', error);
                const gallery = document.getElementById('propertyPhotosGallery');
                gallery.className = 'photos-gallery empty';
                gallery.innerHTML = '';
            }
        }
        
        // 删除房产照片
        async function deletePropertyPhoto(propertyId, photoUrl) {
            if (!confirm('确定要删除这张照片吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}/photos`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photo_url: photoUrl })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('照片删除成功！');
                    await loadPropertyPhotosForEdit(propertyId);
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
                console.error(error);
            }
        }
        
        // 处理房产照片文件选择
        document.getElementById('propertyPhotoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadPropertyPhotoBtn');
            
            if (file) {
                uploadBtn.style.display = 'inline-block';
            } else {
                uploadBtn.style.display = 'none';
            }
        });
        
        // 上传房产照片
        document.getElementById('uploadPropertyPhotoBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('propertyPhotoInput');
            const propertyId = document.getElementById('editPropertyId').value;
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要上传的照片');
                return;
            }
            
            if (!propertyId) {
                alert('房产信息错误，请重新选择房产进行编辑');
                return;
            }
            
            const formData = new FormData();
            formData.append('photo', file);
            
            try {
                const response = await fetch(`${API_BASE}/properties/${propertyId}/photos`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('照片上传成功！');
                    await loadPropertyPhotosForEdit(propertyId);
                    document.getElementById('uploadPropertyPhotoBtn').style.display = 'none';
                    fileInput.value = '';
                } else {
                    alert('上传失败: ' + result.message);
                }
            } catch (error) {
                alert('上传失败: ' + error.message);
                console.error(error);
            }
        });
        
        // 更新照片显示
        function updatePhotoDisplay(photoUrl) {
            const preview = document.getElementById('ownerPhotoPreview');
            const placeholder = document.getElementById('noPhotoPlaceholder');
            const deleteBtn = document.getElementById('deletePhotoBtn');
            
            if (photoUrl) {
                preview.src = `${API_BASE.replace('/api', '')}${photoUrl}`;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
                deleteBtn.style.display = 'none';
            }
        }
        
        // 处理照片文件选择
        document.getElementById('ownerPhotoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadPhotoBtn');
            
            if (file) {
                // 显示预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('ownerPhotoPreview');
                    const placeholder = document.getElementById('noPhotoPlaceholder');
                    
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
                
                uploadBtn.style.display = 'inline-block';
            } else {
                uploadBtn.style.display = 'none';
            }
        });
        
        // 上传照片
        document.getElementById('uploadPhotoBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('ownerPhotoInput');
            const ownerId = document.getElementById('editOwnerId').value;
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要上传的照片');
                return;
            }
            
            const formData = new FormData();
            formData.append('photo', file);
            
            try {
                const response = await fetch(`${API_BASE}/owners/${ownerId}/photo`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('照片上传成功！');
                    updatePhotoDisplay(result.data.photo_url);
                    document.getElementById('uploadPhotoBtn').style.display = 'none';
                    fileInput.value = '';
                } else {
                    alert('上传失败: ' + result.message);
                }
            } catch (error) {
                alert('上传失败');
                console.error(error);
            }
        });
        
        // 删除照片
        document.getElementById('deletePhotoBtn').addEventListener('click', async function() {
            if (!confirm('确定要删除这张照片吗？')) {
                return;
            }
            
            const ownerId = document.getElementById('editOwnerId').value;
            
            try {
                const response = await fetch(`${API_BASE}/owners/${ownerId}/photo`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('照片删除成功！');
                    updatePhotoDisplay(null);
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                alert('删除失败');
                console.error(error);
            }
        });
        
        // 提交编辑表单
        document.getElementById('ownerEditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ownerId = document.getElementById('editOwnerId').value;
            const formData = {
                name: document.getElementById('editOwnerName').value,
                phone: document.getElementById('editOwnerPhone').value,
                id_card: document.getElementById('editOwnerIdCard').value,
                company: document.getElementById('editOwnerCompany').value,
                position: document.getElementById('editOwnerPosition').value,
                hobby: document.getElementById('editOwnerHobby').value,
                remark: document.getElementById('editOwnerRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/owners/${ownerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('业主信息更新成功！');
                    closeOwnerEditModal();
                    loadOwners(); // 重新加载列表
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                alert('更新失败');
                console.error(error);
            }
        });
        
        async function deleteOwner(id) {
            if (confirm('确定要删除此业主吗？删除后无法恢复！')) {
                try {
                    const response = await fetch(`${API_BASE}/owners/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('业主删除成功！');
                        loadOwners();
                        loadDashboard();
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                } catch (error) {
                    alert('删除失败: ' + error.message);
                    console.error(error);
                }
            }
        }
        
        async function editProperty(id) {
            try {
                const response = await fetch(`${API_BASE}/properties/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const property = result.data;
                    
                    // 先加载小区和业主选项
                    await loadCommunitiesForSelect();
                    await loadOwnersForSelect();
                    
                    // 填充表单 - 确保正确填充所有字段
                    document.getElementById('editPropertyId').value = property.id;
                    document.getElementById('editPropertyCommunity').value = property.community_id || '';
                    document.getElementById('editPropertyType').value = property.property_type || '普通住宅';
                    document.getElementById('editPropertyBuilding').value = property.building || '';
                    document.getElementById('editPropertyUnit').value = property.unit || '';
                    document.getElementById('editPropertyRoom').value = property.room || '';
                    document.getElementById('editPropertyArea').value = property.area || '';
                    document.getElementById('editPropertyDelivered').value = property.is_delivered ? '1' : '0';
                    document.getElementById('editPropertyDecorated').value = property.is_decorated ? '1' : '0';
                    document.getElementById('editPropertyOccupancy').value = property.occupancy_status || '空关';
                    document.getElementById('editPropertyForRent').value = property.is_for_rent ? '1' : '0';
                    document.getElementById('editPropertyHandoverDate').value = property.handover_date || '';
                    document.getElementById('editPropertyOwner').value = property.owner_id || '';
                    
                    // 加载房产照片
                    await loadPropertyPhotosForEdit(property.id);
                    
                    // 显示模态框
                    document.getElementById('propertyEditModal').style.display = 'block';
                } else {
                    alert('获取房产信息失败: ' + result.message);
                }
            } catch (error) {
                alert('获取房产信息失败: ' + error.message);
                console.error(error);
            }
        }
        
        async function deleteProperty(id) {
            if (confirm('确定要删除此房产吗？删除后无法恢复！')) {
                try {
                    const response = await fetch(`${API_BASE}/properties/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('房产删除成功！');
                        loadProperties();
                        loadDashboard();
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                } catch (error) {
                    alert('删除失败: ' + error.message);
                    console.error(error);
                }
            }
        }
        
        async function editParking(id) {
            try {
                const response = await fetch(`${API_BASE}/parking/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const parking = result.data.parking;
                    
                    // 先加载小区和业主选项
                    await loadCommunitiesForSelect();
                    await loadOwnersForSelect();
                    
                    // 填充表单 - 确保正确填充所有字段
                    document.getElementById('editParkingId').value = parking.id;
                    document.getElementById('editParkingCommunity').value = parking.community_id || '';
                    document.getElementById('editParkingNumber').value = parking.space_number || '';
                    document.getElementById('editParkingType').value = parking.type || '地下';
                    document.getElementById('editParkingStatus').value = parking.status || '自用';
                    document.getElementById('editParkingOwner').value = parking.owner_id || '';
                    document.getElementById('editParkingLocation').value = parking.location_description || '';
                    document.getElementById('editParkingRent').value = parking.rental_price || '';
                    document.getElementById('editParkingRemark').value = parking.remark || '';
                    
                    // 显示模态框
                    document.getElementById('parkingEditModal').style.display = 'block';
                } else {
                    alert('获取车位信息失败: ' + result.message);
                }
            } catch (error) {
                alert('获取车位信息失败: ' + error.message);
                console.error(error);
            }
        }
        
        // 关闭车位编辑模态框
        function closeParkingEditModal() {
            document.getElementById('parkingEditModal').style.display = 'none';
        }
        
        // 车位编辑表单提交
        document.getElementById('parkingEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const parkingId = document.getElementById('editParkingId').value;
            const formData = {
                community_id: document.getElementById('editParkingCommunity').value,
                space_number: document.getElementById('editParkingNumber').value,
                type: document.getElementById('editParkingType').value,
                status: document.getElementById('editParkingStatus').value,
                owner_id: document.getElementById('editParkingOwner').value || null,
                location_description: document.getElementById('editParkingLocation').value,
                rental_price: document.getElementById('editParkingRent').value ? parseFloat(document.getElementById('editParkingRent').value) : null,
                remark: document.getElementById('editParkingRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/parking/${parkingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('车位信息更新成功！');
                    closeParkingEditModal();
                    loadParkingSpaces();
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
                console.error(error);
            }
        });
        
        async function deleteParking(id) {
            if (confirm('确定要删除此车位吗？删除后无法恢复！')) {
                try {
                    const response = await fetch(`${API_BASE}/parking/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('车位删除成功！');
                        loadParkingSpaces();
                        loadDashboard();
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                } catch (error) {
                    alert('删除失败: ' + error.message);
                    console.error(error);
                }
            }
        }
        
        // 编辑小区
        async function editCommunity(id) {
            try {
                const response = await fetch(`${API_BASE}/communities/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const community = result.data;
                    
                    // 填充表单
                    document.getElementById('editCommunityId').value = community.id;
                    document.getElementById('editCommunityName').value = community.name || '';
                    document.getElementById('editCommunityAddress').value = community.address || '';
                    document.getElementById('editCommunityDescription').value = community.description || '';
                    
                    // 显示模态框
                    document.getElementById('communityEditModal').style.display = 'block';
                } else {
                    alert('获取小区信息失败: ' + result.message);
                }
            } catch (error) {
                alert('获取小区信息失败: ' + error.message);
                console.error(error);
            }
        }
        
        // 关闭小区编辑模态框
        function closeCommunityEditModal() {
            document.getElementById('communityEditModal').style.display = 'none';
        }
        
        // 小区编辑表单提交
        document.getElementById('communityEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const communityId = document.getElementById('editCommunityId').value;
            const formData = {
                name: document.getElementById('editCommunityName').value,
                address: document.getElementById('editCommunityAddress').value,
                description: document.getElementById('editCommunityDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/communities/${communityId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('小区信息更新成功！');
                    closeCommunityEditModal();
                    loadCommunities();
                    loadCommunitiesForSelect(); // 刷新小区选项
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
                console.error(error);
            }
        });
        
        async function deleteCommunity(id) {
            if (confirm('确定要删除此小区吗？删除后无法恢复，且会影响相关的房产和车位数据！')) {
                try {
                    const response = await fetch(`${API_BASE}/communities/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('小区删除成功！');
                        loadCommunities();
                        loadCommunitiesForSelect(); // 刷新小区选项
                        loadDashboard(); // 刷新仪表盘统计
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                } catch (error) {
                    alert('删除失败: ' + error.message);
                    console.error(error);
                }
            }
        }

        // ========== 高级收费管理 JavaScript ==========
        
        // 加载房产类型收费标准
        async function loadPropertyFeeRates() {
            try {
                const response = await fetch(`${API_BASE}/advanced-fees/rates`);
                const result = await response.json();
                
                const tbody = document.getElementById('feeRatesTableBody');
                if (result.success) {
                    const propertyTypes = ['普通住宅', '公寓', '商铺', '上叠', '下叠', '别墅'];
                    
                    tbody.innerHTML = propertyTypes.map(type => {
                        const rate = result.data.find(r => r.property_type === type);
                        const rateValue = rate ? rate.unit_price : 0;
                        return `
                            <tr>
                                <td><strong>${type}</strong></td>
                                <td>
                                    <input type="number" 
                                           id="rate_${type.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                           value="${rateValue}" 
                                           step="0.01" 
                                           min="0"
                                           style="width: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                           onchange="markAsModified()">
                                    <span style="color: #666; margin-left: 8px;">元/㎡/月</span>
                                </td>
                                <td>按面积(㎡)×月数</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3">加载失败</td></tr>';
                }
            } catch (error) {
                console.error('加载收费标准失败:', error);
                document.getElementById('feeRatesTableBody').innerHTML = '<tr><td colspan="3">加载失败</td></tr>';
            }
        }
        
        // 编辑收费标准
        // 标记为已修改
        function markAsModified() {
            const statusElement = document.getElementById('batchUpdateStatus');
            statusElement.style.display = 'none';
        }

        // 批量保存费率
        async function saveBatchFeeRates() {
            const propertyTypes = ['普通住宅', '公寓', '商铺', '上叠', '下叠', '别墅'];
            const updates = [];
            
            // 收集所有输入值
            for (const type of propertyTypes) {
                const inputId = `rate_${type.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const input = document.getElementById(inputId);
                if (input) {
                    const rate = parseFloat(input.value) || 0;
                    updates.push({
                        property_type: type,
                        fee_item_id: 1, // 物业费项目ID
                        unit_price: rate
                    });
                }
            }
            
            if (updates.length === 0) {
                alert('没有可保存的数据');
                return;
            }
            
            try {
                // 显示保存状态
                const statusElement = document.getElementById('batchUpdateStatus');
                statusElement.textContent = '💾 保存中...';
                statusElement.style.display = 'inline';
                statusElement.style.color = '#f39c12';
                
                // 批量更新所有费率
                const promises = updates.map(update => 
                    fetch(`${API_BASE}/advanced-fees/rates`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(update)
                    })
                );
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                // 检查是否全部成功
                const failures = results.filter(r => !r.success);
                if (failures.length > 0) {
                    throw new Error(`${failures.length}个费率更新失败`);
                }
                
                // 更新状态显示
                statusElement.textContent = '✅ 已保存';
                statusElement.style.color = '#27ae60';
                
                // 更新缓存
                loadFeeRatesCache();
                
                // 3秒后隐藏状态
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                const statusElement = document.getElementById('batchUpdateStatus');
                statusElement.textContent = '❌ 保存失败';
                statusElement.style.color = '#e74c3c';
                
                alert('保存失败: ' + error.message);
                console.error('批量保存费率失败:', error);
            }
        }
        
        // 显示添加房产类型模态框
        function showAddPropertyTypeModal() {
            document.getElementById('addPropertyTypeModal').style.display = 'block';
        }

        // 关闭添加房产类型模态框
        function closeAddPropertyTypeModal() {
            document.getElementById('addPropertyTypeModal').style.display = 'none';
            document.getElementById('addPropertyTypeForm').reset();
        }

        // 处理添加房产类型表单提交
        document.getElementById('addPropertyTypeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const typeName = document.getElementById('newPropertyTypeName').value.trim();
            const typeRate = parseFloat(document.getElementById('newPropertyTypeRate').value);
            
            if (!typeName || isNaN(typeRate) || typeRate < 0) {
                alert('请填写完整且有效的信息');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/advanced-fees/rates`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        property_type: typeName,
                        fee_item_id: 1, // 物业费项目ID
                        unit_price: typeRate
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('房产类型收费标准添加成功！');
                    closeAddPropertyTypeModal();
                    loadPropertyFeeRates();
                    loadFeeRatesCache(); // 更新缓存
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                alert('添加失败: ' + error.message);
                console.error(error);
            }
        });
        
        // 工具标签切换
        function showUtilityTab(tabName) {
            document.querySelectorAll('.utility-tab').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('[id$="TabBtn"]').forEach(btn => btn.classList.remove('btn-primary'));
            
            document.getElementById(tabName + 'Tab').style.display = 'block';
            document.getElementById(tabName + 'TabBtn').classList.add('btn-primary');
        }
        
        // 收入标签切换
        function showIncomeTab(tabName) {
            document.querySelectorAll('.income-tab').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('[id$="TabBtn"]').forEach(btn => btn.classList.remove('btn-primary'));
            
            document.getElementById(tabName.replace('-', '') + 'Tab').style.display = 'block';
            document.getElementById(tabName.replace('-', '') + 'TabBtn').classList.add('btn-primary');
        }
        
        // 物业费计算表单提交
        document.getElementById('calculateFeesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ownerId = document.getElementById('calcOwner').value;
            const propertyId = document.getElementById('calcProperty').value;
            const startDate = document.getElementById('calcStartDate').value;
            const endDate = document.getElementById('calcEndDate').value;
            
            try {
                let url = `${API_BASE}/advanced-fees/calculate?start_date=${startDate}&end_date=${endDate}`;
                if (ownerId) url += `&owner_id=${ownerId}`;
                if (propertyId) url += `&property_id=${propertyId}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayCalculationResults(result.data);
                } else {
                    alert('计算失败: ' + result.message);
                }
            } catch (error) {
                alert('计算失败');
                console.error(error);
            }
        });
        
        function displayCalculationResults(data) {
            const resultsDiv = document.getElementById('calcResultsContent');
            let html = '<table class="table"><thead><tr><th>房产地址</th><th>房产类型</th><th>面积(㎡)</th><th>月数</th><th>物业费单价</th><th>物业费</th><th>车位费</th><th>合计</th></tr></thead><tbody>';
            
            let totalAmount = 0;
            data.forEach(item => {
                totalAmount += item.total_amount;
                html += `<tr>
                    <td>${item.address}</td>
                    <td><span style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${item.property_type}</span></td>
                    <td>${item.area}</td>
                    <td>${item.months}</td>
                    <td>¥${item.property_fee.unit_price}/㎡/月</td>
                    <td>¥${item.property_fee.amount.toFixed(2)}</td>
                    <td>¥${item.parking_fee.amount.toFixed(2)}</td>
                    <td><strong>¥${item.total_amount.toFixed(2)}</strong></td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr><th colspan="7">总计</th><th><strong style="color: #e74c3c;">¥${totalAmount.toFixed(2)}</strong></th></tr></tfoot></table>`;
            html += '<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; color: #666;">💡 提示：不同房产类型使用不同的物业费单价，单价可在上方收费标准中调整</div>';
            resultsDiv.innerHTML = html;
            document.getElementById('calcResults').style.display = 'block';
        }
        
        // 水费抄表表单
        document.getElementById('waterReadingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('waterProperty').value,
                reading_date: document.getElementById('waterDate').value,
                current_reading: parseFloat(document.getElementById('waterReading').value),
                unit_price: parseFloat(document.getElementById('waterPrice').value),
                remark: document.getElementById('waterRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/utilities/water`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`水费抄表成功！用量: ${result.data.usage}吨，费用: ¥${result.data.amount}`);
                    document.getElementById('waterReadingForm').reset();
                } else {
                    alert('抄表失败: ' + result.message);
                }
            } catch (error) {
                alert('抄表失败');
                console.error(error);
            }
        });
        
        // 电费抄表表单
        document.getElementById('electricityReadingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('electricityProperty').value,
                reading_date: document.getElementById('electricityDate').value,
                current_reading: parseFloat(document.getElementById('electricityReading').value),
                prepaid_amount: parseFloat(document.getElementById('electricityRecharge').value) || 0,
                remark: document.getElementById('electricityRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/utilities/electricity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`电费抄表成功！用量: ${result.data.usage}度，余额: ¥${result.data.balance}(${result.data.balance_status})`);
                    document.getElementById('electricityReadingForm').reset();
                } else {
                    alert('抄表失败: ' + result.message);
                }
            } catch (error) {
                alert('抄表失败');
                console.error(error);
            }
        });
        
        // 押金管理表单
        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('depositProperty').value,
                deposit_type: document.getElementById('depositType').value,
                amount: parseFloat(document.getElementById('depositAmount').value),
                paid_date: document.getElementById('depositDate').value,
                remark: document.getElementById('depositRemark').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/utilities/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('押金记录创建成功！');
                    document.getElementById('depositForm').reset();
                } else {
                    alert('创建失败: ' + result.message);
                }
            } catch (error) {
                alert('创建失败');
                console.error(error);
            }
        });
        
        // 门禁卡收费表单
        document.getElementById('accessCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('accessCardProperty').value,
                quantity: parseInt(document.getElementById('accessCardQuantity').value),
                unit_price: parseFloat(document.getElementById('accessCardPrice').value),
                record_date: document.getElementById('accessCardDate').value,
                description: document.getElementById('accessCardDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/daily-income/access-card`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`门禁卡收费记录成功！金额: ¥${result.data.amount}`);
                    document.getElementById('accessCardForm').reset();
                } else {
                    alert('记录失败: ' + result.message);
                }
            } catch (error) {
                alert('记录失败');
                console.error(error);
            }
        });
        
        // 消防放水费表单
        document.getElementById('fireTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('fireTestProperty').value,
                unit_price: parseFloat(document.getElementById('fireTestAmount').value),
                record_date: document.getElementById('fireTestDate').value,
                description: document.getElementById('fireTestDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/daily-income/fire-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`消防放水费记录成功！金额: ¥${result.data.amount}`);
                    document.getElementById('fireTestForm').reset();
                } else {
                    alert('记录失败: ' + result.message);
                }
            } catch (error) {
                alert('记录失败');
                console.error(error);
            }
        });
        
        // 其他收费表单
        document.getElementById('otherIncomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                property_id: document.getElementById('otherProperty').value || null,
                income_type: document.getElementById('otherIncomeType').value,
                amount: parseFloat(document.getElementById('otherAmount').value),
                record_date: document.getElementById('otherDate').value,
                description: document.getElementById('otherDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/daily-income/other`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`收费记录成功！金额: ¥${result.data.amount}`);
                    document.getElementById('otherIncomeForm').reset();
                } else {
                    alert('记录失败: ' + result.message);
                }
            } catch (error) {
                alert('记录失败');
                console.error(error);
            }
        });
        
        // ========== 租赁管理 JavaScript ==========
        
        async function loadRentalProperties() {
            try {
                const response = await fetch(`${API_BASE}/rental/properties`);
                const result = await response.json();
                
                const tbody = document.getElementById('rentalPropertiesBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(property => `
                        <tr>
                            <td>${property.community_name || '未知小区'}</td>
                            <td>
                                ${property.building}${property.unit}${property.room}
                                <br>
                                ${property.photos ? 
                                    `<span style="color: #28a745; font-size: 12px;">📸 有照片</span>` : 
                                    `<span style="color: #6c757d; font-size: 12px;">📷 无照片</span>`
                                }
                            </td>
                            <td>${property.area}㎡</td>
                            <td>${property.property_type}</td>
                            <td>${property.owner_name || '无'}</td>
                            <td>¥${property.rental_price || 0}/月</td>
                            <td>${property.rental_status}</td>
                            <td>
                                <button onclick="viewPropertyPhotos('${property.building}${property.unit}${property.room}', '${property.photos || ''}')" class="btn" style="padding: 5px 10px; font-size: 12px;">查看</button>
                                <button onclick="editRentalProperty(${property.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">编辑</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载可租售房产失败:', error);
            }
        }
        
        async function loadRentalParkingSpaces() {
            try {
                const response = await fetch(`${API_BASE}/rental/parking-spaces`);
                const result = await response.json();
                
                const tbody = document.getElementById('rentalParkingBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(parking => `
                        <tr>
                            <td>${parking.community_name || '未知小区'}</td>
                            <td>${parking.space_number}</td>
                            <td>${parking.type}</td>
                            <td>${parking.owner_name || '无'}</td>
                            <td>${parking.location_description || '-'}</td>
                            <td>¥${parking.rental_price || 0}/月</td>
                            <td>${parking.status}</td>
                            <td>
                                <button onclick="editRentalParking(${parking.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">编辑</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载可租售车位失败:', error);
            }
        }
        
        async function loadRentalContracts() {
            try {
                const response = await fetch(`${API_BASE}/rental/contracts`);
                const result = await response.json();
                
                const tbody = document.getElementById('contractsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(contract => {
                        const rentObject = contract.building ? 
                            `${contract.building}${contract.unit}${contract.room}` : 
                            contract.space_number;
                        
                        return `
                            <tr>
                                <td>${contract.contract_number}</td>
                                <td>${rentObject}</td>
                                <td>${contract.tenant_name}</td>
                                <td>¥${contract.monthly_rent}/月</td>
                                <td>¥${contract.deposit || 0}</td>
                                <td>${contract.start_date}</td>
                                <td>${contract.end_date}</td>
                                <td>${contract.status}</td>
                                <td>
                                    <button onclick="editContract(${contract.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">编辑</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('加载租赁合同失败:', error);
            }
        }
        
        // ========== 装修管理 JavaScript ==========
        
        async function loadDecorationPermits() {
            try {
                const response = await fetch(`${API_BASE}/decoration`);
                const result = await response.json();
                
                const tbody = document.getElementById('decorationPermitsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(permit => `
                        <tr>
                            <td>${permit.permit_number || '-'}</td>
                            <td>${permit.building}${permit.unit}${permit.room}</td>
                            <td>${permit.owner_name}</td>
                            <td>${permit.start_date} 至 ${permit.end_date}</td>
                            <td>${permit.contact_person}<br>${permit.contact_phone}</td>
                            <td>¥${permit.deposit_amount || 0}</td>
                            <td>${permit.status}</td>
                            <td>
                                <button onclick="editDecoration(${permit.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">编辑</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载装修许可失败:', error);
            }
        }
        
        // ========== 车辆管理 JavaScript ==========
        
        async function loadVehicleBindings() {
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/bindings`);
                const result = await response.json();
                
                const tbody = document.getElementById('vehicleBindingsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(binding => `
                        <tr>
                            <td>${binding.space_number}</td>
                            <td>${binding.license_plate}</td>
                            <td>${binding.car_model || '-'}</td>
                            <td>${binding.owner_name}</td>
                            <td>${binding.binding_type}</td>
                            <td>${binding.start_date}</td>
                            <td>${binding.status}</td>
                            <td>
                                <button onclick="removeBinding(${binding.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">解除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载车辆绑定失败:', error);
            }
        }
        
        async function loadViolations() {
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/violations`);
                const result = await response.json();
                
                const tbody = document.getElementById('violationsBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(violation => `
                        <tr>
                            <td>${violation.license_plate}</td>
                            <td>${violation.violation_type}</td>
                            <td>${violation.violation_date}</td>
                            <td>${violation.location || '-'}</td>
                            <td>¥${violation.fine_amount}</td>
                            <td>${violation.status}</td>
                            <td>
                                <button onclick="viewViolationPhotos('${violation.license_plate}', '${violation.photos || ''}')" class="btn" style="padding: 5px 10px; font-size: 12px;">查看照片</button>
                                <button onclick="updateViolation(${violation.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">处理</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载违章记录失败:', error);
            }
        }
        
        async function loadViolationStats() {
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/violations/stats`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('pendingViolations').textContent = result.data.pending_violations;
                    document.getElementById('totalFines').textContent = `¥${result.data.total_fines}`;
                }
            } catch (error) {
                console.error('加载违章统计失败:', error);
            }
        }
        
        // ========== 日报管理 JavaScript ==========
        
        function setDefaultReportDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('dashboardEndDate').value = today;
        }
        
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            
            try {
                let url = `${API_BASE}/reports/${reportType}`;
                if (reportDate) {
                    if (reportType === 'daily') {
                        url += `?date=${reportDate}`;
                    } else if (reportType === 'monthly') {
                        const [year, month] = reportDate.split('-');
                        url += `?year=${year}&month=${month}`;
                    } else if (reportType === 'quarterly') {
                        const quarter = Math.ceil(new Date(reportDate).getMonth() / 3);
                        url += `?year=${reportDate.split('-')[0]}&quarter=${quarter}`;
                    }
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayReportResults(result.data, reportType);
                } else {
                    alert('报表生成失败: ' + result.message);
                }
            } catch (error) {
                alert('报表生成失败');
                console.error(error);
            }
        }
        
        function displayReportResults(data, reportType) {
            const resultsDiv = document.getElementById('reportResults');
            let html = '';
            
            if (reportType === 'daily') {
                html = `
                    <h3>📊 ${data.report_date} 日报表</h3>
                    <div class="stats" style="margin: 20px 0;">
                        <div class="stat-card stat-green">
                            <h3>¥${data.summary.total_amount}</h3>
                            <p>总收入</p>
                        </div>
                        <div class="stat-card stat-blue">
                            <h3>${data.summary.total_transactions}</h3>
                            <p>交易笔数</p>
                        </div>
                    </div>
                `;
                
                if (data.daily_income.length > 0) {
                    html += '<h4>💰 每日收入明细</h4><table class="table"><thead><tr><th>收费类型</th><th>房产</th><th>金额</th><th>说明</th></tr></thead><tbody>';
                    data.daily_income.forEach(income => {
                        html += `<tr><td>${income.income_type}</td><td>${income.building || ''}${income.unit || ''}${income.room || ''}</td><td>¥${income.amount}</td><td>${income.description || '-'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        async function loadOutstandingFees() {
            try {
                const response = await fetch(`${API_BASE}/reports/outstanding/all`);
                const result = await response.json();
                
                const tbody = document.getElementById('outstandingFeesBody');
                if (result.success) {
                    tbody.innerHTML = result.data.map(outstanding => `
                        <tr>
                            <td>${outstanding.owner_name}</td>
                            <td>${outstanding.owner_phone || '-'}</td>
                            <td>${outstanding.properties || '-'}</td>
                            <td>${outstanding.parking_spaces || '-'}</td>
                            <td>${outstanding.outstanding_count}</td>
                            <td>¥${outstanding.total_outstanding}</td>
                            <td>
                                <button onclick="viewOwnerDetails(${outstanding.owner_id})" class="btn" style="padding: 5px 10px; font-size: 12px;">查看详情</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载欠费统计失败:', error);
            }
        }
        
        async function searchOutstanding() {
            const searchType = document.getElementById('searchType').value;
            const searchValue = document.getElementById('searchValue').value;
            const endDate = document.getElementById('dashboardEndDate').value;
            
            if (!searchValue) {
                alert('请输入查询内容');
                return;
            }
            
            try {
                const url = `${API_BASE}/reports/dashboard?search_type=${searchType}&search_value=${encodeURIComponent(searchValue)}&end_date=${endDate}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayDashboardResults(result.data);
                } else {
                    alert('查询失败: ' + result.message);
                }
            } catch (error) {
                alert('查询失败');
                console.error(error);
            }
        }
        
        function displayDashboardResults(data) {
            const resultsDiv = document.getElementById('dashboardResults');
            let html = `
                <h3>🔍 欠费查询结果</h3>
                <p>查询条件: ${data.search_criteria.search_type === 'owner' ? '业主名称' : '门牌号'} = ${data.search_criteria.search_value}</p>
                <p>截止日期: ${data.search_criteria.end_date}</p>
                <div class="stats" style="margin: 20px 0;">
                    <div class="stat-card stat-red">
                        <h3>${data.summary.total_count}</h3>
                        <p>欠费笔数</p>
                    </div>
                    <div class="stat-card stat-red">
                        <h3>¥${data.summary.total_amount}</h3>
                        <p>欠费总额</p>
                    </div>
                </div>
            `;
            
            if (data.records.length > 0) {
                html += '<table class="table"><thead><tr><th>业主</th><th>房产/车位</th><th>费用类型</th><th>金额</th><th>到期日期</th></tr></thead><tbody>';
                data.records.forEach(record => {
                    html += `<tr><td>${record.owner_name}</td><td>${record.location}</td><td>${record.fee_item_name}</td><td>¥${record.amount}</td><td>${record.due_date}</td></tr>`;
                });
                html += '</tbody></table>';
            } else {
                html += '<p>暂无欠费记录</p>';
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // ========== 占位函数 ==========
        
        async function editRentalProperty(id) { 
            const newPrice = prompt('请输入新的租金(元/月):');
            if (newPrice === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/properties/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rental_price: parseFloat(newPrice) })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('租金更新成功！');
                    loadRentalProperties();
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
            }
        }
        
        async function editRentalParking(id) { 
            const newPrice = prompt('请输入新的租金(元/月):');
            if (newPrice === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/parking/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rental_price: parseFloat(newPrice) })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('租金更新成功！');
                    loadRentalParkingSpaces();
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
            }
        }
        // ========== 租赁管理 JavaScript ==========
        
        // 显示/隐藏合同表单
        function toggleContractForm() {
            const form = document.getElementById('contractForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // 生成合同编号
                document.getElementById('contractNumber').value = 'CONTRACT-' + Date.now();
                // 设置当前日期
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('contractStart').value = today;
                // 加载租客列表
                loadTenantOptions();
            }
        }
        
        function cancelContractForm() {
            document.getElementById('contractForm').style.display = 'none';
            document.querySelector('#contractForm form').reset();
        }
        
        // 更新租赁对象选项
        async function updateRentalOptions() {
            const rentalType = document.getElementById('rentalType').value;
            const select = document.getElementById('rentalObject');
            const label = document.getElementById('rentalObjectLabel');
            
            select.innerHTML = '<option value="">加载中...</option>';
            
            if (rentalType === 'property') {
                label.textContent = '租赁房产:';
                try {
                    const response = await fetch(`${API_BASE}/properties`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">请选择房产</option>';
                        result.data.forEach(property => {
                            select.innerHTML += `<option value="${property.id}">${property.community_name} - ${property.building}${property.unit}${property.room_number}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">加载失败</option>';
                }
            } else if (rentalType === 'parking') {
                label.textContent = '租赁车位:';
                try {
                    const response = await fetch(`${API_BASE}/parking`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">请选择车位</option>';
                        result.data.forEach(parking => {
                            select.innerHTML += `<option value="${parking.id}">${parking.community_name} - ${parking.space_number}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">加载失败</option>';
                }
            }
        }
        
        // 加载租客选项
        async function loadTenantOptions() {
            try {
                const response = await fetch(`${API_BASE}/tenants`);
                const result = await response.json();
                const select = document.getElementById('tenantSelect');
                
                if (result.success) {
                    select.innerHTML = '<option value="">请选择租客</option>';
                    result.data.forEach(tenant => {
                        select.innerHTML += `<option value="${tenant.id}">${tenant.name} - ${tenant.phone}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">无租客数据</option>';
                }
            } catch (error) {
                document.getElementById('tenantSelect').innerHTML = '<option value="">加载失败</option>';
            }
        }
        
        // 创建合同
        async function createContract(event) {
            event.preventDefault();
            
            const contractData = {
                contract_number: document.getElementById('contractNumber').value,
                rental_type: document.getElementById('rentalType').value,
                object_id: parseInt(document.getElementById('rentalObject').value),
                tenant_id: parseInt(document.getElementById('tenantSelect').value),
                monthly_rent: parseFloat(document.getElementById('monthlyRent').value),
                deposit_amount: parseFloat(document.getElementById('depositAmount').value),
                start_date: document.getElementById('contractStart').value,
                end_date: document.getElementById('contractEnd').value,
                payment_cycle: document.getElementById('paymentCycle').value,
                status: document.getElementById('contractStatus').value,
                remarks: document.getElementById('contractRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/rental/contracts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contractData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('合同创建成功！');
                    cancelContractForm();
                    loadRentalContracts();
                } else {
                    alert('创建失败: ' + result.message);
                }
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        }
        
        function editContract(id) { 
            alert('合同编辑功能：\n现在可以使用上方的表单创建新合同\n合同ID: ' + id); 
        }
        
        // ========== 装修管理 JavaScript ==========
        
        // 显示/隐藏装修表单
        function toggleDecorationForm() {
            const form = document.getElementById('decorationForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // 生成许可证编号
                document.getElementById('permitNumber').value = 'PERMIT-' + Date.now();
                // 设置当前日期
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('decorationStart').value = today;
                // 加载房产选项
                loadDecorationPropertyOptions();
            }
        }
        
        function cancelDecorationForm() {
            document.getElementById('decorationForm').style.display = 'none';
            document.querySelector('#decorationForm form').reset();
        }
        
        // 加载房产选项
        async function loadDecorationPropertyOptions() {
            try {
                const response = await fetch(`${API_BASE}/properties`);
                const result = await response.json();
                const select = document.getElementById('decorationProperty');
                
                if (result.success) {
                    select.innerHTML = '<option value="">请选择房产</option>';
                    result.data.forEach(property => {
                        select.innerHTML += `<option value="${property.id}">${property.community_name} - ${property.building}${property.unit}${property.room_number} (业主: ${property.owner_name || '未知'})</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">无房产数据</option>';
                }
            } catch (error) {
                document.getElementById('decorationProperty').innerHTML = '<option value="">加载失败</option>';
            }
        }
        
        // 创建装修许可
        async function createDecorationPermit(event) {
            event.preventDefault();
            
            const decorationData = {
                permit_number: document.getElementById('permitNumber').value,
                property_id: parseInt(document.getElementById('decorationProperty').value),
                decoration_type: document.getElementById('decorationType').value,
                contractor_name: document.getElementById('contractorName').value,
                contact_person: document.getElementById('contactPerson').value,
                contact_phone: document.getElementById('contactPhone').value,
                start_date: document.getElementById('decorationStart').value,
                expected_end_date: document.getElementById('decorationEnd').value,
                deposit_amount: parseFloat(document.getElementById('decorationDeposit').value),
                cleaning_fee: parseFloat(document.getElementById('cleaningFee').value) || 0,
                fire_safety_fee: parseFloat(document.getElementById('fireSafetyFee').value) || 0,
                other_fees: parseFloat(document.getElementById('otherFees').value) || 0,
                status: document.getElementById('decorationStatus').value,
                remarks: document.getElementById('decorationRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/decoration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(decorationData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('装修许可创建成功！');
                    cancelDecorationForm();
                    loadDecorationPermits();
                } else {
                    alert('创建失败: ' + result.message);
                }
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        }
        
        function editDecoration(id) { 
            alert('装修管理编辑功能：\n现在可以使用上方的表单创建新许可\n许可ID: ' + id); 
        }
        // ========== 车辆管理 JavaScript ==========
        
        // 显示/隐藏车辆绑定表单
        function toggleVehicleBindingForm() {
            const form = document.getElementById('vehicleBindingForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // 设置当前日期
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('bindingStartDate').value = today;
                // 加载车位选项
                loadParkingSpaceOptions();
            }
        }
        
        function cancelVehicleBindingForm() {
            document.getElementById('vehicleBindingForm').style.display = 'none';
            document.querySelector('#vehicleBindingForm form').reset();
        }
        
        // 加载车位选项
        async function loadParkingSpaceOptions() {
            try {
                const response = await fetch(`${API_BASE}/parking`);
                const result = await response.json();
                const select = document.getElementById('bindingParkingSpace');
                
                if (result.success) {
                    select.innerHTML = '<option value="">请选择车位</option>';
                    result.data.forEach(parking => {
                        const statusText = parking.status === '自用' ? '(可绑定)' : `(${parking.status})`;
                        select.innerHTML += `<option value="${parking.id}">${parking.community_name} - ${parking.space_number} ${statusText}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">无车位数据</option>';
                }
            } catch (error) {
                document.getElementById('bindingParkingSpace').innerHTML = '<option value="">加载失败</option>';
            }
        }
        
        // 更新车主选项
        async function updateOwnerOptions() {
            const ownerType = document.getElementById('ownerType').value;
            const select = document.getElementById('vehicleOwner');
            
            select.innerHTML = '<option value="">加载中...</option>';
            
            if (ownerType === '业主') {
                try {
                    const response = await fetch(`${API_BASE}/owners`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">请选择业主</option>';
                        result.data.forEach(owner => {
                            select.innerHTML += `<option value="${owner.id}">${owner.name} - ${owner.phone}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">加载失败</option>';
                }
            } else if (ownerType === '租客') {
                try {
                    const response = await fetch(`${API_BASE}/tenants`);
                    const result = await response.json();
                    if (result.success) {
                        select.innerHTML = '<option value="">请选择租客</option>';
                        result.data.forEach(tenant => {
                            select.innerHTML += `<option value="${tenant.id}">${tenant.name} - ${tenant.phone}</option>`;
                        });
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">加载失败</option>';
                }
            }
        }
        
        // 创建车辆绑定
        async function createVehicleBinding(event) {
            event.preventDefault();
            
            const bindingData = {
                parking_space_id: parseInt(document.getElementById('bindingParkingSpace').value),
                license_plate: document.getElementById('vehicleLicensePlate').value.toUpperCase(),
                car_model: document.getElementById('vehicleModel').value,
                color: document.getElementById('vehicleColor').value,
                owner_type: document.getElementById('ownerType').value,
                owner_id: parseInt(document.getElementById('vehicleOwner').value),
                binding_type: document.getElementById('bindingType').value,
                status: document.getElementById('bindingStatus').value,
                start_date: document.getElementById('bindingStartDate').value,
                end_date: document.getElementById('bindingEndDate').value || null,
                remarks: document.getElementById('vehicleRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/bindings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bindingData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('车辆绑定成功！');
                    cancelVehicleBindingForm();
                    loadVehicleBindings();
                } else {
                    alert('绑定失败: ' + result.message);
                }
            } catch (error) {
                alert('绑定失败: ' + error.message);
            }
        }
        
        // 显示/隐藏违章表单
        function toggleViolationForm() {
            const form = document.getElementById('violationForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // 生成违章编号
                document.getElementById('violationNumber').value = 'VIO-' + Date.now();
                // 设置当前时间
                const now = new Date();
                const localTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('violationTime').value = localTime;
            }
        }
        
        function cancelViolationForm() {
            document.getElementById('violationForm').style.display = 'none';
            document.querySelector('#violationForm form').reset();
        }
        
        // 创建违章记录
        async function createViolation(event) {
            event.preventDefault();
            
            const violationData = {
                violation_number: document.getElementById('violationNumber').value,
                license_plate: document.getElementById('violationLicensePlate').value.toUpperCase(),
                violation_type: document.getElementById('violationType').value,
                location: document.getElementById('violationLocation').value,
                violation_time: document.getElementById('violationTime').value,
                fine_amount: parseFloat(document.getElementById('fineAmount').value),
                reporter: document.getElementById('violationReporter').value,
                status: document.getElementById('violationStatus').value,
                remarks: document.getElementById('violationRemarks').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/enhanced-vehicles/violations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(violationData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('违章记录创建成功！');
                    cancelViolationForm();
                    loadViolations();
                } else {
                    alert('创建失败: ' + result.message);
                }
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        }
        
        function removeBinding(id) { 
            if (confirm('确定要解除此车辆绑定吗？')) {
                alert('车辆绑定解除功能：\n现在可以使用上方的表单创建新绑定\n绑定ID: ' + id);
            }
        }
        
        // 此函数已被替换为上方的 toggleViolationForm() 和 createViolation()
        // 请使用新的表单界面创建违章记录
        
        function updateViolation(id) { 
            if (confirm('确定要处理此违章记录吗？')) {
                alert('违章处理功能：\n违章ID: ' + id + '\n可将状态改为paid或appealed');
            }
        }
        function viewOwnerDetails(id) { alert('查看业主详情功能开发中...'); }

        // 查看房产照片
        function viewPropertyPhotos(propertyName, photos) {
            const container = document.getElementById('propertyPhotosContainer');
            
            if (!photos || photos.trim() === '') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">📷</div>
                        <h3>${propertyName}</h3>
                        <p>暂无房产照片</p>
                    </div>
                `;
            } else {
                const photoUrls = photos.split(',').filter(url => url.trim());
                let html = `<h3 style="margin-bottom: 20px;">${propertyName} - 房产照片</h3>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                
                photoUrls.forEach((photo, index) => {
                    const photoUrl = photo.trim().startsWith('/') ? `${API_BASE.replace('/api', '')}${photo.trim()}` : photo.trim();
                    html += `
                        <div style="text-align: center;">
                            <img src="${photoUrl}" alt="房产照片${index + 1}" 
                                 style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;"
                                 onclick="window.open('${photoUrl}', '_blank')">
                            <p style="margin-top: 5px; font-size: 12px; color: #666;">照片 ${index + 1}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            document.getElementById('propertyPhotosModal').style.display = 'block';
        }
        
        // 关闭房产照片模态框
        function closePropertyPhotosModal() {
            document.getElementById('propertyPhotosModal').style.display = 'none';
        }

        // 查看违章照片
        function viewViolationPhotos(licensePlate, photos) {
            const container = document.getElementById('violationPhotosContainer');
            
            if (!photos || photos.trim() === '') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">📷</div>
                        <h3>${licensePlate}</h3>
                        <p>暂无违章照片</p>
                        <div style="margin-top: 20px;">
                            <input type="file" id="violationPhotoInput" accept="image/*" multiple style="margin-right: 10px;">
                            <button onclick="uploadViolationPhotos('${licensePlate}')" class="btn btn-success">📤 上传违章照片</button>
                        </div>
                    </div>
                `;
            } else {
                const photoUrls = photos.split(',').filter(url => url.trim());
                let html = `<h3 style="margin-bottom: 20px;">${licensePlate} - 违章照片</h3>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
                
                photoUrls.forEach((photo, index) => {
                    const photoUrl = photo.trim().startsWith('/') ? `${API_BASE.replace('/api', '')}${photo.trim()}` : photo.trim();
                    html += `
                        <div style="text-align: center;">
                            <img src="${photoUrl}" alt="违章照片${index + 1}" 
                                 style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;"
                                 onclick="window.open('${photoUrl}', '_blank')">
                            <p style="margin-top: 5px; font-size: 12px; color: #666;">违章照片 ${index + 1}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `
                    <div style="text-align: center; padding: 20px; border-top: 1px solid #ddd;">
                        <input type="file" id="violationPhotoInput" accept="image/*" multiple style="margin-right: 10px;">
                        <button onclick="uploadViolationPhotos('${licensePlate}')" class="btn btn-success">📤 添加更多照片</button>
                    </div>
                `;
                container.innerHTML = html;
            }
            
            document.getElementById('violationPhotosModal').style.display = 'block';
        }
        
        // 关闭违章照片模态框
        function closeViolationPhotosModal() {
            document.getElementById('violationPhotosModal').style.display = 'none';
        }
        
        // 上传违章照片(占位函数)
        function uploadViolationPhotos(licensePlate) {
            const fileInput = document.getElementById('violationPhotoInput');
            if (!fileInput.files.length) {
                alert('请选择要上传的照片');
                return;
            }
            alert('违章照片上传功能开发中...\n车牌号: ' + licensePlate + '\n选择了 ' + fileInput.files.length + ' 张照片');
        }

        // ========== 数据导入 JavaScript ==========
        
        // 下载导入模板
        function downloadTemplate(type) {
            const url = `${API_BASE}/import/template/${type}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = true;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 导入数据
        async function importData(type) {
            const fileInput = document.getElementById(type + 'File');
            const resultDiv = document.getElementById(type + 'Result');
            
            if (!fileInput.files[0]) {
                alert('请选择要导入的Excel文件');
                return;
            }
            
            const file = fileInput.files[0];
            
            // 检查文件类型
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('请选择Excel文件(.xlsx或.xls)');
                return;
            }
            
            // 检查文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('文件大小不能超过5MB');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                resultDiv.innerHTML = '<div style="color: #007bff;">📤 正在导入数据，请稍候...</div>';
                
                const response = await fetch(`${API_BASE}/import/${type}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let html = `<div style="color: #28a745; margin: 10px 0;">
                        ✅ ${result.message}
                        <br>总计: ${result.data.total} 条，成功: ${result.data.successCount} 条，失败: ${result.data.errorCount} 条
                    </div>`;
                    
                    if (result.data.errors && result.data.errors.length > 0) {
                        html += '<div style="color: #dc3545; margin: 10px 0;"><strong>错误详情:</strong><ul>';
                        result.data.errors.forEach(error => {
                            html += `<li>${error}</li>`;
                        });
                        html += '</ul></div>';
                    }
                    
                    resultDiv.innerHTML = html;
                    
                    // 清空文件选择
                    fileInput.value = '';
                    
                    // 刷新相关页面数据
                    if (type === 'owners') {
                        loadOwners();
                        loadDashboard();
                    } else if (type === 'properties') {
                        loadProperties();
                        loadDashboard();
                    } else if (type === 'parking') {
                        loadParkingSpaces();
                        loadDashboard();
                    }
                    
                } else {
                    resultDiv.innerHTML = `<div style="color: #dc3545;">❌ 导入失败: ${result.message}</div>`;
                }
                
            } catch (error) {
                console.error('导入数据失败:', error);
                resultDiv.innerHTML = `<div style="color: #dc3545;">❌ 导入失败: ${error.message}</div>`;
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', () => {
            loadDashboard();
        });
    </script>
</body>
</html>